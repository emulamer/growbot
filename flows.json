[{"id":"38def9ff.21aea6","type":"tab","label":"Home","disabled":false,"info":""},{"id":"6bb640c6.525a5","type":"tab","label":"Config","disabled":false,"info":""},{"id":"638a1ba8.eab274","type":"tab","label":"Water Control","disabled":false,"info":""},{"id":"68dd499a.a366c8","type":"tab","label":"History","disabled":false,"info":""},{"id":"594ee16b.d66e3","type":"tab","label":"System Status","disabled":false,"info":""},{"id":"2b4fc933.a97346","type":"subflow","name":"HistChartCfg","info":"","category":"","in":[{"x":40,"y":60,"wires":[{"id":"fc14c775.f1c158"}]}],"out":[{"x":460,"y":80,"wires":[{"id":"fc14c775.f1c158","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"5189c7b3.782c68","type":"subflow","name":"DashChtCfg","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"c199c539.1f1bd8"}]}],"out":[{"x":380,"y":60,"wires":[{"id":"c199c539.1f1bd8","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"2c950cc0.f5b4d4","type":"subflow","name":"Parse growbot binary","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"9f3b8982.948a58"}]}],"out":[{"x":420,"y":100,"wires":[{"id":"9f3b8982.948a58","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"fb6e1899.829f18","type":"subflow","name":"Update Config Prop","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"a9765549.092e18"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"9243fa99.15cf28","type":"mqtt-broker","name":"mosquitto","broker":"localhost","port":"1883","clientid":"","usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"sessionExpiry":""},{"id":"30dfc866.064c48","type":"sqlitedb","db":"/growbot/growbot.db","mode":"RW"},{"id":"7f61f4d.e984e0c","type":"ui_tab","name":"Home","icon":"dashboard","order":1,"disabled":false,"hidden":false},{"id":"46917510.f81e1c","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","reset":false},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey","palette":"light"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"MM/DD/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"60058375.2cde8c","type":"ui_group","name":"Dashboard","tab":"7f61f4d.e984e0c","order":1,"disp":true,"width":"14","collapse":false},{"id":"de56d4f6.628058","type":"ui_tab","name":"Historical","icon":"dashboard","order":2,"disabled":false,"hidden":false},{"id":"ab3ec0cf.5f1fc","type":"ui_group","name":"History","tab":"de56d4f6.628058","order":1,"disp":true,"width":14,"collapse":false},{"id":"8350c218.c1ab3","type":"ui_tab","name":"Configuration","icon":"dashboard","order":3,"disabled":false,"hidden":false},{"id":"a2345340.dcf1","type":"ui_group","name":"Power","tab":"8350c218.c1ab3","order":1,"disp":true,"width":"12","collapse":false},{"id":"96d9d6c0.428e28","type":"ui_group","name":"System","tab":"8350c218.c1ab3","order":3,"disp":true,"width":"6","collapse":false},{"id":"4975dc2d.9c4134","type":"ui_group","name":"Power Control","tab":"7f61f4d.e984e0c","order":3,"disp":true,"width":"6","collapse":true},{"id":"63d090d9.23eae","type":"ui_group","name":"pH Calibration","tab":"8350c218.c1ab3","order":4,"disp":true,"width":"6","collapse":false},{"id":"8822534f.5b11a","type":"ui_group","name":"TDS Calibration","tab":"8350c218.c1ab3","order":5,"disp":true,"width":"6","collapse":false},{"id":"f31f9e53.8a7f","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":1,"width":7,"height":1},{"id":"d5377a49.f6daf8","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":2,"width":7,"height":1},{"id":"591950ff.0a363","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":3,"width":7,"height":1},{"id":"7f70c5e7.3de1dc","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":4,"width":7,"height":1},{"id":"53071ceb.8a2e94","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":14,"width":5,"height":1},{"id":"df0017e7.10b168","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":15,"width":5,"height":1},{"id":"6a9ac3cd.d0831c","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":17,"width":5,"height":1},{"id":"699cbfb8.a2c5c","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":18,"width":5,"height":1},{"id":"5bce2eb2.34d88","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":20,"width":5,"height":1},{"id":"bd72273.ff7d5d8","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":21,"width":5,"height":1},{"id":"2b30aa6.51a9c56","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":23,"width":5,"height":1},{"id":"1bb89026.9dbff","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":24,"width":5,"height":1},{"id":"77ce56de.13b358","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":26,"width":5,"height":1},{"id":"f65d3134.6126a","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":27,"width":5,"height":1},{"id":"3d74877a.91cc38","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":29,"width":5,"height":1},{"id":"ae86e4a.2032b18","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":30,"width":5,"height":1},{"id":"4a8b378b.9fa778","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":32,"width":5,"height":1},{"id":"b771f3ee.6da22","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":33,"width":5,"height":1},{"id":"bb7e7a8d.4e01f8","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":35,"width":5,"height":1},{"id":"5c8e58a1.a72178","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":36,"width":5,"height":1},{"id":"573bdc6.0264424","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":38,"width":5,"height":1},{"id":"c961e321.6ef39","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":39,"width":5,"height":1},{"id":"208e75da.180b8a","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":41,"width":5,"height":1},{"id":"93bccaf5.129518","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":42,"width":5,"height":1},{"id":"aeb47e3b.5e7cd","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":43,"width":1,"height":1},{"id":"c8c5cdeb.d2094","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":45,"width":1,"height":1},{"id":"94470df.629b8f","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":46,"width":1,"height":1},{"id":"19fb79b1.db4d06","type":"ui_spacer","name":"spacer","group":"84084ec.d63dcb","order":47,"width":1,"height":1},{"id":"3e9c32d0.a7e42e","type":"websocket-client","path":"ws://growbot-doser.local:8118","tls":"","wholemsg":"false"},{"id":"efc6ea82.963f78","type":"ui_tab","name":"Water Control","icon":"dashboard","order":4,"disabled":false,"hidden":false},{"id":"963f0a7c.dc1ca8","type":"ui_group","name":"Doser Calibration","tab":"efc6ea82.963f78","order":3,"disp":true,"width":"14","collapse":false},{"id":"b35587bd.c30058","type":"ui_group","name":"Nutrient Dosing","tab":"efc6ea82.963f78","order":1,"disp":true,"width":"14","collapse":false},{"id":"967933ee.45097","type":"ui_group","name":"Adjustment","tab":"efc6ea82.963f78","order":2,"disp":true,"width":"14","collapse":false},{"id":"cef2d3a3.2dfb4","type":"ui_spacer","name":"spacer","group":"ab3ec0cf.5f1fc","order":4,"width":1,"height":1},{"id":"c757e6fe.62c618","type":"ui_spacer","name":"spacer","group":"ab3ec0cf.5f1fc","order":6,"width":5,"height":1},{"id":"4c5b1a8c.affb44","type":"ui_spacer","name":"spacer","group":"ab3ec0cf.5f1fc","order":8,"width":1,"height":1},{"id":"d959c6a4.d1a4b8","type":"ui_spacer","name":"spacer","group":"ab3ec0cf.5f1fc","order":10,"width":1,"height":1},{"id":"8237dc2e.e85d8","type":"ui_spacer","name":"spacer","group":"ab3ec0cf.5f1fc","order":13,"width":1,"height":1},{"id":"44ea3e3f.c328","type":"ui_spacer","name":"spacer","group":"ab3ec0cf.5f1fc","order":15,"width":5,"height":1},{"id":"b9fab5a.6b0f448","type":"ui_group","name":"Cams","tab":"7f61f4d.e984e0c","order":2,"disp":true,"width":"6","collapse":false},{"id":"d99fcb82.968e48","type":"websocket-client","path":"ws://growbot-flow.local:8118","tls":"","wholemsg":"false"},{"id":"79e4a25c.bb49dc","type":"ui_group","name":"Water Flow","tab":"efc6ea82.963f78","order":4,"disp":true,"width":12,"collapse":false},{"id":"201a3b26.67ae34","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":2,"width":6,"height":1},{"id":"a5083e30.81ec9","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":3,"width":6,"height":1},{"id":"2f827355.f0e74c","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":5,"width":6,"height":1},{"id":"92d08231.2243b","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":6,"width":6,"height":1},{"id":"196c7b49.643cc5","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":8,"width":6,"height":1},{"id":"2b4dc542.b7a5fa","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":9,"width":6,"height":1},{"id":"3c96361e.328bda","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":11,"width":6,"height":1},{"id":"9448b907.923ab8","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":12,"width":6,"height":1},{"id":"cdb248cb.0b74e8","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":14,"width":6,"height":1},{"id":"3ad186c7.1be5fa","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":15,"width":6,"height":1},{"id":"117161cd.14378e","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":17,"width":6,"height":1},{"id":"4fbb66c8.e76cb8","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":18,"width":6,"height":1},{"id":"62e39878.f07c78","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":19,"width":14,"height":1},{"id":"33f13e3e.1fbb32","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":21,"width":6,"height":1},{"id":"dc463f1a.cd1d7","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":22,"width":6,"height":1},{"id":"e045a420.055ff8","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":23,"width":14,"height":1},{"id":"f707dd96.11a97","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":25,"width":8,"height":1},{"id":"5904069d.33e508","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":26,"width":8,"height":1},{"id":"78a767ad.d12ff8","type":"ui_spacer","name":"spacer","group":"b35587bd.c30058","order":27,"width":14,"height":1},{"id":"f2373da7.36617","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":2,"width":3,"height":1},{"id":"c76fc09c.385","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":4,"width":3,"height":1},{"id":"1d886452.837f7c","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":5,"width":3,"height":1},{"id":"917f7697.9ffed8","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":6,"width":3,"height":1},{"id":"e91020cb.e5d88","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":7,"width":3,"height":1},{"id":"c0233170.d8931","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":8,"width":3,"height":1},{"id":"554948f9.9f5288","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":9,"width":14,"height":1},{"id":"efd486f5.8d9728","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":11,"width":3,"height":1},{"id":"648465bc.cf691c","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":13,"width":3,"height":1},{"id":"27ff975a.3663a8","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":14,"width":3,"height":1},{"id":"3d9b282.40e9ed8","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":15,"width":3,"height":1},{"id":"af822317.98a79","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":16,"width":3,"height":1},{"id":"d29dd2fd.b98d","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":17,"width":3,"height":1},{"id":"1200e0df.2c5e2f","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":18,"width":14,"height":1},{"id":"bbc0aef7.00388","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":20,"width":3,"height":1},{"id":"72c525b6.97b97c","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":22,"width":3,"height":1},{"id":"4453ff1b.67cd8","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":23,"width":3,"height":1},{"id":"2c0aac36.0cd0d4","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":24,"width":3,"height":1},{"id":"a87a4d80.9ddac","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":25,"width":3,"height":1},{"id":"cc114490.f7bd18","type":"ui_spacer","name":"spacer","group":"967933ee.45097","order":26,"width":3,"height":1},{"id":"ba29dbbc.cb9778","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":2,"width":3,"height":1},{"id":"dfc4df54.1931b","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":3,"width":3,"height":1},{"id":"b6c47da6.9bd29","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":4,"width":14,"height":1},{"id":"f7d67f3d.b5fc4","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":6,"width":5,"height":1},{"id":"30e084e4.b46d0c","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":7,"width":5,"height":1},{"id":"5e845534.07169c","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":8,"width":14,"height":1},{"id":"36ff3ab2.00b946","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":11,"width":3,"height":1},{"id":"cd50814a.8a657","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":12,"width":3,"height":1},{"id":"443c177f.e366a8","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":13,"width":14,"height":1},{"id":"392d7f61.4a2e6","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":16,"width":3,"height":1},{"id":"a614a3b6.65d5b","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":17,"width":3,"height":1},{"id":"3d3073a.d155a8c","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":18,"width":14,"height":1},{"id":"c0bbaccb.37f99","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":21,"width":3,"height":1},{"id":"a6a1accb.ec2bc","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":22,"width":3,"height":1},{"id":"8e5073d1.06317","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":23,"width":14,"height":1},{"id":"9fe0b36e.830fa","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":26,"width":3,"height":1},{"id":"4f0576be.1c7878","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":27,"width":3,"height":1},{"id":"40d72921.2431f8","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":28,"width":14,"height":1},{"id":"31afeb2d.974ff4","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":31,"width":3,"height":1},{"id":"50ccd93c.c72618","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":32,"width":3,"height":1},{"id":"427b7246.ee666c","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":33,"width":14,"height":1},{"id":"c78d49aa.ae49e8","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":36,"width":3,"height":1},{"id":"eb62c2dd.3e153","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":37,"width":3,"height":1},{"id":"e51e9b93.fceeb8","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":38,"width":14,"height":1},{"id":"ee12202.2c176e","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":39,"width":14,"height":1},{"id":"5ce6896e.d5a378","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":41,"width":3,"height":1},{"id":"2317f4e2.fdd53c","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":43,"width":3,"height":1},{"id":"4d8e9065.b215a","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":44,"width":3,"height":1},{"id":"e6509311.ad31","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":45,"width":3,"height":1},{"id":"d9433ee5.618d4","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":46,"width":14,"height":1},{"id":"d7f0afd1.ee4a8","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":48,"width":3,"height":1},{"id":"28b0204c.debc","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":50,"width":3,"height":1},{"id":"d5f79255.98cd3","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":51,"width":3,"height":1},{"id":"5ab2c950.8f58b8","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":52,"width":3,"height":1},{"id":"495c098c.e8ce38","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":53,"width":14,"height":1},{"id":"b468114f.5948c","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":55,"width":3,"height":1},{"id":"f4a27413.378248","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":57,"width":3,"height":1},{"id":"1f24083.6e18bf8","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":58,"width":3,"height":1},{"id":"31b05f8a.8e73","type":"ui_spacer","name":"spacer","group":"963f0a7c.dc1ca8","order":59,"width":3,"height":1},{"id":"9b0a5156.f5a29","type":"ui_spacer","name":"spacer","group":"79e4a25c.bb49dc","order":4,"width":3,"height":1},{"id":"1a31ff61.fd1781","type":"ui_spacer","name":"spacer","group":"79e4a25c.bb49dc","order":24,"width":6,"height":1},{"id":"e43e88ca.268e38","type":"ui_spacer","name":"spacer","group":"79e4a25c.bb49dc","order":26,"width":6,"height":1},{"id":"d0a8065.0235ff8","type":"serial-port","serialport":"/dev/ttyACM0","serialbaud":"115200","databits":"8","parity":"none","stopbits":"1","waitfor":"","dtr":"none","rts":"none","cts":"none","dsr":"none","newline":"\\n","bin":"false","out":"char","addchar":"","responsetimeout":"10000"},{"id":"6050e21d.121acc","type":"websocket-client","path":"ws://growbot-inside-intake-temp.local:8118","tls":"","wholemsg":"false"},{"id":"706f2da7.938834","type":"websocket-client","path":"ws://growbot-outside-intake-temp.local:8118","tls":"","wholemsg":"false"},{"id":"19d050ef.ac48af","type":"websocket-client","path":"ws://growbot-ducter.local:8118","tls":"","wholemsg":"false"},{"id":"5fcd719a.e80f1","type":"ui_group","name":"Air Intake","tab":"7f61f4d.e984e0c","order":4,"disp":true,"width":"6","collapse":false},{"id":"c9da95c0.5b45c8","type":"websocket-client","path":"ws://growbot-mix-intake-temp.local:8118/","tls":"","wholemsg":"false"},{"id":"e6cb8ba6.8350e8","type":"websocket-client","path":"ws://growbot-humidifier.local:8118","tls":"","wholemsg":"false"},{"id":"198cd612.f86eaa","type":"ui_group","name":"Lightify","tab":"7f61f4d.e984e0c","order":5,"disp":true,"width":"6","collapse":false},{"id":"7cf977f9.c0b488","type":"ui_group","name":"Module Status","tab":"faa7effd.b0c95","order":1,"disp":true,"width":"6","collapse":false},{"id":"faa7effd.b0c95","type":"ui_tab","name":"System Status","icon":"dashboard","order":5,"disabled":false,"hidden":false},{"id":"76ab0099.db5b","type":"ui_spacer","name":"spacer","group":"60058375.2cde8c","order":5,"width":2,"height":1},{"id":"dfb8bd15.2eaf3","type":"ui_spacer","name":"spacer","group":"60058375.2cde8c","order":10,"width":2,"height":1},{"id":"d69d42ff.46ba5","type":"ui_spacer","name":"spacer","group":"60058375.2cde8c","order":11,"width":2,"height":1},{"id":"31c9d872.a67c98","type":"ui_spacer","name":"spacer","group":"60058375.2cde8c","order":16,"width":2,"height":1},{"id":"94b3d0e8.39bfc","type":"ui_spacer","name":"spacer","group":"60058375.2cde8c","order":21,"width":2,"height":1},{"id":"173bb965.6c8b17","type":"ui_spacer","name":"spacer","group":"60058375.2cde8c","order":22,"width":2,"height":1},{"id":"34a8156f.0bd23a","type":"ui_spacer","name":"spacer","group":"60058375.2cde8c","order":26,"width":5,"height":1},{"id":"77a652a8.f4386c","type":"ui_spacer","name":"spacer","group":"60058375.2cde8c","order":29,"width":8,"height":1},{"id":"fc96697f.3387d8","type":"ui_spacer","name":"spacer","group":"60058375.2cde8c","order":30,"width":14,"height":1},{"id":"e014f0b.5461a1","type":"ui_spacer","name":"spacer","group":"60058375.2cde8c","order":31,"width":14,"height":1},{"id":"1fc887db.9fe938","type":"ui_spacer","name":"spacer","group":"b9fab5a.6b0f448","order":5,"width":6,"height":1},{"id":"c28835a6.c162e8","type":"ui_spacer","name":"spacer","group":"4975dc2d.9c4134","order":7,"width":6,"height":1},{"id":"d613cc16.d00e2","type":"ui_spacer","name":"spacer","group":"5fcd719a.e80f1","order":16,"width":6,"height":1},{"id":"ab039191.c3ca","type":"mqtt in","z":"38def9ff.21aea6","name":"Message from Growbot","topic":"GROWBOT","qos":"2","datatype":"auto","broker":"9243fa99.15cf28","nl":false,"rap":true,"rh":0,"x":120,"y":160,"wires":[["92821c48.0c0d5"]]},{"id":"1538449f.33dd9b","type":"sqlite","z":"38def9ff.21aea6","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"State History","x":790,"y":200,"wires":[[]]},{"id":"c82b9b1b.a92598","type":"inject","z":"38def9ff.21aea6","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":110,"y":40,"wires":[["d3a8d4d1.504b58","b81b9626.dd20e8"]]},{"id":"d3a8d4d1.504b58","type":"sqlite","z":"38def9ff.21aea6","mydb":"30dfc866.064c48","sqlquery":"fixed","sql":"create table if not exists states(timestamp integer, state_json TEXT);\ncreate index if not exists idx_states_timestamp on states (timestamp);\ncreate table if not exists flowops (id text, timestamp integer, op text not null, status text not null, error text null, opLitersIn real not null, opLitersOut real not null, opLitersDelta real not null, params text null);\ncreate table if not exists flowstatus(timestamp integer, litersIn real not null, litersOut real not null, inValveOpen integer not null, outValveOpen integer not null, waterLevel real not null); \ncreate table if not exists airstatus(timestamp integer, insideTempC real, insideHumidityPercent real, outsideTempC real, outsideHumidityPercent real, mixTempC real, mixHumidityPercent real, ambientTempC real, ambientHumidityPercent real, mode real, insideOpenPercent real, outsideOpenPercent real, targetTempC real);\ncreate index if not exists idx_airstatus_timestamp on airstatus (timestamp);\ncreate table if not exists data (\n    timestamp integer,\n    current_mode integer,\n    config_exhaustFanPercent integer,\n    config_intakeFanPercent integer,\n    config_exhaustFanOn integer, \n    config_intakeFanOn integer,\n    config_overheadLightsOn integer,\n    config_sideLightsOn integer,\n    config_bubblesOn integer,\n    config_exhaustFanCalibration_minOffset integer,\n    config_exhaustFanCalibration_maxOffset integer,\n    config_exhaustFanCalibration_spinUpSec integer,\n    config_intakeFanCalibration_minOffset integer,\n    config_intakeFanCalibration_maxOffset integer,\n    config_intakeFanCalibration_spinUpSec integer,\n    config_samplingIntervalMS integer,\n    config_controlWaterLevelCalibration_fullCm real,\n    config_controlWaterLevelCalibration_emptyCm real,\n    config_waterChillerThermostat_mode integer,\n    config_waterChillerThermostat_minValue real,\n    config_waterChillerThermostat_maxValue real,\n    config_lightsSchedule_status integer,\n    config_lightsSchedule_turnOnGmtHourMin integer,\n    config_lightsSchedule_turnOffGmtHourMin integer,\n    config_roomFanSchedule_status integer,\n    config_roomFanSchedule_turnOnGmtHourMin integer,\n    config_roomFanSchedule_turnOffGmtHourMin integer,\n    data_exhaustInternal_temperatureC real,\n    data_exhaustInternal_humidity real,\n    data_exhaustExternal_temperatureC real,\n    data_exhaustExternal_humidity real,\n    data_intakeExternal_temperatureC real,\n    data_intakeExternal_humidity real,\n    data_intakeInternal_temperatureC real,\n    data_intakeInternal_humidity real,    \n    data_ambientInternal1_temperatureC real,\n    data_ambientInternal1_humidity real,\n    data_ambientInternal2_temperatureC real,\n    data_ambientInternal2_humidity real,\n    data_ambientInternal3_temperatureC real,\n    data_ambientInternal3_humidity real,\n    data_lights_temperatureC real,\n    data_lights_humidity real,\n    data_luxAmbient1 real,\n    data_luxAmbient2 real,\n    data_luxAmbient3 real,\n    data_luxAmbient4 real,\n    data_luxAmbient5 real,\n    data_waterData_ph real,\n    data_waterData_tds real,\n    data_controlBucket_temperatureC real,\n    data_controlBucket_waterLevelPercent real,\n    data_waterChillerStatus real,\n    data_lightsOn integer,\n    data_roomFanOn integer,\n    data_pumpEmergencyShutoff integer,\n    data_pumpOn integer,\n    data_bubblesOn integer\n);\n\ncreate index if not exists idx_data_timestamp on data (timestamp);\n","name":"Create table","x":290,"y":40,"wires":[[]]},{"id":"16fea1c4.41d3ee","type":"function","z":"38def9ff.21aea6","name":"Create INSERT state SQL","func":"msg.topic = `INSERT INTO states (timestamp, state_json) VALUES ('${msg.payload.timestamp}', '${JSON.stringify(msg.payload)}')`;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":200,"wires":[["1538449f.33dd9b"]]},{"id":"c2f4374c.dace78","type":"ui_gauge","z":"38def9ff.21aea6","name":"Water Level","group":"60058375.2cde8c","order":8,"width":3,"height":2,"gtype":"gage","title":"","label":"percent","format":"{{msg.payload.data.controlBucket.waterLevelPercent}}","min":"0","max":"100","colors":["#739c9b","#00f508","#0154da"],"seg1":"20","seg2":"70","x":610,"y":380,"wires":[]},{"id":"6a4eb66c.beee98","type":"ui_gauge","z":"38def9ff.21aea6","name":"Water Temp","group":"60058375.2cde8c","order":17,"width":3,"height":2,"gtype":"gage","title":"","label":"°C","format":"{{msg.payload.data.controlBucket.temperatureC}}","min":"18","max":"30","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":610,"y":340,"wires":[]},{"id":"8178f4f8.97f6a8","type":"ui_gauge","z":"38def9ff.21aea6","name":"pH","group":"60058375.2cde8c","order":6,"width":3,"height":2,"gtype":"gage","title":"","label":"pH","format":"{{msg.payload.data.waterData.ph}}","min":"1","max":"14","colors":["#d50b0b","#00ff11","#f40b0b"],"seg1":"5","seg2":"7","x":590,"y":420,"wires":[]},{"id":"6121ea23.d626c4","type":"ui_gauge","z":"38def9ff.21aea6","name":"TDS","group":"60058375.2cde8c","order":7,"width":3,"height":2,"gtype":"gage","title":"","label":"PPM","format":"{{msg.payload.data.waterData.tds}}","min":0,"max":"1500","colors":["#9b9bbb","#22c601","#d7da34"],"seg1":"400","seg2":"850","x":590,"y":460,"wires":[]},{"id":"f971b716.a97688","type":"ui_gauge","z":"38def9ff.21aea6","name":"ambient temp","group":"60058375.2cde8c","order":9,"width":3,"height":2,"gtype":"gage","title":"","label":"°C","format":"{{msg.payload.data.ambientInternal1.temperatureC}}","min":"10","max":"35","colors":["#002aff","#00e62e","#ca3838"],"seg1":"20","seg2":"26","x":620,"y":300,"wires":[]},{"id":"b3d41dc.0ad40e","type":"ui_gauge","z":"38def9ff.21aea6","name":"ambient humid","group":"60058375.2cde8c","order":18,"width":3,"height":2,"gtype":"gage","title":"","label":"%","format":"{{msg.payload.data.ambientInternal1.humidity}}","min":"0","max":"100","colors":["#9f9fa3","#00e62e","#ca3838"],"seg1":"40","seg2":"060","x":620,"y":260,"wires":[]},{"id":"bcaab1eb.be397","type":"function","z":"38def9ff.21aea6","name":"Round","func":"var newmsg = RED.util.cloneMessage(msg.payload);\nvar d = newmsg.data;\nd.exhaustInternal.temperatureC = Math.round(d.exhaustInternal.temperatureC * 100)/100;\nd.exhaustInternal.humidity = Math.round(d.exhaustInternal.humidity);\n\nd.exhaustExternal.temperatureC = Math.round(d.exhaustExternal.temperatureC * 100)/100;\nd.exhaustExternal.humidity = Math.round(d.exhaustExternal.humidity);\n\nd.intakeInternal.temperatureC = Math.round(d.intakeInternal.temperatureC * 100)/100;\nd.intakeInternal.humidity = Math.round(d.intakeInternal.humidity);\n\nd.intakeExternal.temperatureC = Math.round(d.intakeExternal.temperatureC * 100)/100;\nd.intakeExternal.humidity = Math.round(d.intakeExternal.humidity);\n\n\nd.ambientInternal1.temperatureC = Math.round(d.ambientInternal1.temperatureC * 100)/100;\nd.ambientInternal1.humidity = Math.round(d.ambientInternal1.humidity);\n\nd.ambientInternal2.temperatureC = Math.round(d.ambientInternal2.temperatureC * 100)/100;\nd.ambientInternal2.humidity = Math.round(d.ambientInternal2.humidity);\n\nd.ambientInternal3.temperatureC = Math.round(d.ambientInternal3.temperatureC * 100)/100;\nd.ambientInternal3.humidity = Math.round(d.ambientInternal3.humidity);\n\nd.luxAmbient1 = Math.round(d.luxAmbient1);\n\nd.lights.temperatureC = Math.round(d.lights.temperatureC * 100)/100;\nd.lights.humidity = Math.round(d.lights.humidity);\n\nd.controlBucket.temperatureC = Math.round(d.controlBucket.temperatureC * 100)/100;\nd.controlBucket.waterLevelPercent = Math.round(d.controlBucket.waterLevelPercent);\n\nd.waterData.ph = Math.round(d.waterData.ph * 100)/100;\nd.waterData.tds = Math.round(d.waterData.tds);\nmsg.payload = newmsg;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":280,"wires":[["c2f4374c.dace78","6a4eb66c.beee98","8178f4f8.97f6a8","6121ea23.d626c4","b3d41dc.0ad40e","f971b716.a97688","c28f12c2.accbf","85496d15.61f54","80055d4c.3c88a","13317070.09d97","7db0e518.6480cc","1dafdc9a.db0293","621f1363.70a14c","2ddfd455.7f7dcc","9534ec93.e7856","5cd5959f.c7cacc","858c193.40db9e8"]]},{"id":"7db0e518.6480cc","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":1,"width":3,"height":1,"name":"","label":"pH","format":"{{msg.payload.data.waterData.ph}}","layout":"col-center","x":410,"y":420,"wires":[]},{"id":"1dafdc9a.db0293","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":2,"width":3,"height":1,"name":"","label":"TDS","format":"{{msg.payload.data.waterData.tds}}","layout":"col-center","x":410,"y":460,"wires":[]},{"id":"85496d15.61f54","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":13,"width":3,"height":1,"name":"","label":"Humidity","format":"{{msg.payload.data.ambientInternal1.humidity}}","layout":"col-center","x":420,"y":260,"wires":[]},{"id":"80055d4c.3c88a","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":12,"width":3,"height":1,"name":"","label":"Water Temp","format":"{{msg.payload.data.controlBucket.temperatureC}}","layout":"col-center","x":430,"y":340,"wires":[]},{"id":"13317070.09d97","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":3,"width":3,"height":1,"name":"","label":"Water Level","format":"{{msg.payload.data.controlBucket.waterLevelPercent}}","layout":"col-center","x":430,"y":380,"wires":[]},{"id":"c28f12c2.accbf","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":4,"width":3,"height":1,"name":"","label":"Temp","format":"{{msg.payload.data.ambientInternal1.temperatureC}}","layout":"col-center","x":410,"y":300,"wires":[]},{"id":"621f1363.70a14c","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":25,"width":3,"height":1,"name":"","label":"Water Chiller","format":"{{msg.payload.data.waterChillerStatus?\"On\":\"Off\"}}","layout":"col-center","x":430,"y":500,"wires":[]},{"id":"1aed25b7.bd2dca","type":"websocket out","z":"638a1ba8.eab274","name":"","server":"","client":"3e9c32d0.a7e42e","x":1460,"y":720,"wires":[]},{"id":"18624c66.cf7564","type":"function","z":"638a1ba8.eab274","name":"Build Binary Message","func":"const buf = Buffer.alloc(6);\nlet offset = 0;\nbuf.writeUInt8(msg.payload.cmd, offset);\noffset++;\nif (msg.payload.port || msg.payload.port === 0) {\n    buf.writeUInt8(msg.payload.port, offset);\n    offset++;\n}\nif (msg.payload.intVal || msg.payload.intVal === 0) {\n    buf.writeInt32LE(msg.payload.intVal, offset);\n    offset +=4;\n} else if (msg.payload.floatVal || msg.payload.floatVal === 0) {\n    buf.writeFloatLE(msg.payload.floatVal, offset);\n    offset +=4;\n}\nmsg.payload = buf;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1160,"y":720,"wires":[["1aed25b7.bd2dca"]]},{"id":"ae466857.639cc8","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":40,"width":4,"height":2,"passthru":false,"label":"Prime 1","tooltip":"","color":"","bgcolor":"","icon":"","payload":"1","payloadType":"num","topic":"topic","topicType":"msg","x":140,"y":620,"wires":[["8cfea5df.267f98"]]},{"id":"ca2668c2.e43858","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":42,"width":4,"height":2,"passthru":false,"label":"Prime  2","tooltip":"","color":"","bgcolor":"","icon":"","payload":"2","payloadType":"num","topic":"topic","topicType":"msg","x":140,"y":660,"wires":[["8cfea5df.267f98"]]},{"id":"382b04b9.5e414c","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":47,"width":4,"height":2,"passthru":false,"label":"Prime  3","tooltip":"","color":"","bgcolor":"","icon":"","payload":"3","payloadType":"num","topic":"topic","topicType":"msg","x":140,"y":700,"wires":[["8cfea5df.267f98"]]},{"id":"f02a7004.5ea07","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":49,"width":4,"height":2,"passthru":false,"label":"Prime  4","tooltip":"","color":"","bgcolor":"","icon":"","payload":"4","payloadType":"num","topic":"topic","topicType":"msg","x":140,"y":740,"wires":[["8cfea5df.267f98"]]},{"id":"2f806dcf.d37a22","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":54,"width":4,"height":2,"passthru":false,"label":"Prime  5","tooltip":"","color":"","bgcolor":"","icon":"","payload":"5","payloadType":"num","topic":"topic","topicType":"msg","x":140,"y":780,"wires":[["8cfea5df.267f98"]]},{"id":"a7e3e2f0.eb3de","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":56,"width":4,"height":2,"passthru":false,"label":"Prime 6","tooltip":"","color":"","bgcolor":"","icon":"","payload":"6","payloadType":"num","topic":"topic","topicType":"msg","x":140,"y":820,"wires":[["8cfea5df.267f98"]]},{"id":"8cfea5df.267f98","type":"function","z":"638a1ba8.eab274","name":"Build start continuous pump","func":"const payload = { msgType: \"DoserStartContinuousPortMsg\", port: msg.payload, skipRetract: false };\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":640,"y":740,"wires":[["4e1f0661.619288"]]},{"id":"39e2da4a.fa35c6","type":"ui_button","z":"638a1ba8.eab274","d":true,"name":"","group":"967933ee.45097","order":10,"width":4,"height":3,"passthru":false,"label":"0.5mL CaliMagic","tooltip":"","color":"","bgcolor":"","icon":"","payload":"0","payloadType":"num","topic":"topic","topicType":"msg","x":270,"y":1820,"wires":[["7d42f8aa.cad448"]]},{"id":"1ff3f885.2d2bd7","type":"ui_button","z":"638a1ba8.eab274","d":true,"name":"","group":"967933ee.45097","order":12,"width":4,"height":3,"passthru":false,"label":"0.5mL Micro","tooltip":"","color":"","bgcolor":"","icon":"","payload":"1","payloadType":"num","topic":"topic","topicType":"msg","x":250,"y":1860,"wires":[["7d42f8aa.cad448"]]},{"id":"b3d67d2b.dac35","type":"ui_button","z":"638a1ba8.eab274","d":true,"name":"","group":"967933ee.45097","order":19,"width":4,"height":3,"passthru":false,"label":"0.5mL Grow","tooltip":"","color":"","bgcolor":"","icon":"","payload":"2","payloadType":"num","topic":"topic","topicType":"msg","x":250,"y":1900,"wires":[["7d42f8aa.cad448"]]},{"id":"caf7b42.08a2248","type":"ui_button","z":"638a1ba8.eab274","d":true,"name":"","group":"967933ee.45097","order":21,"width":4,"height":3,"passthru":false,"label":"0.5mL Bloom","tooltip":"","color":"","bgcolor":"","icon":"","payload":"3","payloadType":"num","topic":"topic","topicType":"msg","x":250,"y":1940,"wires":[["7d42f8aa.cad448"]]},{"id":"85bd501.9974eb","type":"ui_numeric","z":"638a1ba8.eab274","name":"","label":"CaliMagic ml/Gal","tooltip":"","group":"b35587bd.c30058","order":1,"width":8,"height":2,"wrap":false,"passthru":true,"topic":"0","topicType":"str","format":"{{value}}","min":0,"max":10,"step":"0.1","x":610,"y":1140,"wires":[["eda2f19a.35472"]]},{"id":"1ba2f06a.765b2","type":"ui_numeric","z":"638a1ba8.eab274","name":"","label":"Micro ml/Gal","tooltip":"","group":"b35587bd.c30058","order":4,"width":8,"height":2,"wrap":false,"passthru":true,"topic":"1","topicType":"str","format":"{{value}}","min":0,"max":10,"step":"0.1","x":590,"y":1180,"wires":[["eda2f19a.35472"]]},{"id":"d9c46ded.d942f","type":"ui_numeric","z":"638a1ba8.eab274","name":"","label":"Grow ml/Gal","tooltip":"","group":"b35587bd.c30058","order":7,"width":8,"height":2,"wrap":false,"passthru":true,"topic":"2","topicType":"str","format":"{{value}}","min":0,"max":10,"step":"0.1","x":590,"y":1220,"wires":[["eda2f19a.35472"]]},{"id":"24d56dce.424d22","type":"ui_numeric","z":"638a1ba8.eab274","name":"","label":"Bloom ml/Gal","tooltip":"","group":"b35587bd.c30058","order":10,"width":8,"height":2,"wrap":false,"passthru":true,"topic":"3","topicType":"str","format":"{{value}}","min":0,"max":10,"step":"0.1","x":600,"y":1260,"wires":[["eda2f19a.35472"]]},{"id":"42309a00.bf2194","type":"function","z":"638a1ba8.eab274","name":"Read Nute Config","func":"\nconst nutes = global.get(\"nutrient_config\") || {};\nif (!nutes.portRatios) {\n    nutes.portRatios = [0,0,0,0,0,0];\n}\nif (!nutes.delaySecBetween) {\n    nutes.delaySecBetween = 10;\n}\nconst ret = [];\nfor (let i = 0; i < 6; i++) {\n    ret.push({ payload: nutes.portRatios[i]||0});\n}\nret.push({payload: nutes.delaySecBetween});\nreturn ret;","outputs":7,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":1220,"wires":[["85bd501.9974eb"],["1ba2f06a.765b2"],["d9c46ded.d942f"],["24d56dce.424d22"],["3875815e.c499de"],["22133cf8.8bf494"],["a163db1d.dfe978"]]},{"id":"7e555a1c.b8d6d4","type":"inject","z":"638a1ba8.eab274","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"10","topic":"","payload":"","payloadType":"date","x":90,"y":1000,"wires":[["42309a00.bf2194","5956e351.3b8c3c"]]},{"id":"3875815e.c499de","type":"ui_numeric","z":"638a1ba8.eab274","name":"","label":"pH Up ml/Gal","tooltip":"","group":"b35587bd.c30058","order":16,"width":8,"height":2,"wrap":false,"passthru":true,"topic":"4","topicType":"str","format":"{{value}}","min":0,"max":10,"step":"0.1","x":600,"y":1300,"wires":[["eda2f19a.35472"]]},{"id":"22133cf8.8bf494","type":"ui_numeric","z":"638a1ba8.eab274","name":"","label":"pH Down ml/Gal","tooltip":"","group":"b35587bd.c30058","order":13,"width":8,"height":2,"wrap":false,"passthru":true,"topic":"5","topicType":"str","format":"{{value}}","min":0,"max":10,"step":"0.1","x":600,"y":1340,"wires":[["eda2f19a.35472"]]},{"id":"eda2f19a.35472","type":"function","z":"638a1ba8.eab274","name":"Save Global Ratios","func":"\nconst nutes = global.get(\"nutrient_config\") || {};\nif (!nutes.portRatios) {\n    nutes.portRatios = [0,0,0,0,0,0];\n}\nif (msg.topic == \"delay\") {\n    nutes.delaySecBetween = msg.payload;\n} else {\n    nutes.portRatios[msg.topic] = msg.payload;\n}\n\nglobal.set(\"nutrient_config\", nutes);\nreturn null;","outputs":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":1160,"wires":[]},{"id":"c8de860.7583b78","type":"ui_numeric","z":"638a1ba8.eab274","name":"","label":"Gallons of Water","tooltip":"","group":"b35587bd.c30058","order":20,"width":8,"height":2,"wrap":false,"passthru":false,"topic":"topic","topicType":"msg","format":"{{value}}","min":0,"max":"15","step":"0.25","x":310,"y":1640,"wires":[["f5dacd6.6115f3"]]},{"id":"2bd91765.c7cf28","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"b35587bd.c30058","order":24,"width":6,"height":2,"passthru":false,"label":"Add All Nutes","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"payload","topicType":"msg","x":480,"y":1440,"wires":[["1964fe1c.55f282"]]},{"id":"1964fe1c.55f282","type":"function","z":"638a1ba8.eab274","name":"Make dosage messages","func":"const gal = global.get(\"gallons_of_water\");\nif (!gal) {\n    return [null, {payload: {success: false, error: \"No gallons set\"}}]; \n}\nconst nutes = global.get(\"nutrient_config\");\nif (!nutes || !nutes.portRatios || nutes.delaySecBetween === null || nutes.delaySecBetween === undefined) {\n    return [null, {payload: {success: false, error: \"No nutrient config\"}}]; \n}\nlet doserQ = flow.get(\"doserMsgQueue\");\nif (doserQ && Array.isArray(doserQ) && doserQ.length) {\n    return [null,{payload:  {success: false, error: \"Queue already exists\"}}];   \n}\n        \n        \nconst ret = [];\nlet delayCtr = 0\nfor (let i = 0; i < 6; i++) {\n    if (nutes.portRatios[i] == 0) {\n        continue;\n    }\n    const mlPerGal = nutes.portRatios[i];// ml now, not tsp* 4.92892;\n    const tot = mlPerGal * gal;\n    ret.push({msgType: \"DoserDosePortMsg\", port: i+1, targetMl: tot});\n}\nif (ret.length) {\n    let firstOne = ret.shift();\n    if (ret.length) {\n        flow.set(\"doserMsgQueue\", ret);\n    }\n    return [{payload: firstOne}, {payload: {success: true, error: \"Starting doses...\"}}];\n} else {\n    return [null, {payload: {success: false, error: \"Nothing to dose!\"}}];\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":1440,"wires":[["4e1f0661.619288"],["7085fc3d.e85624"]]},{"id":"a163db1d.dfe978","type":"ui_numeric","z":"638a1ba8.eab274","name":"","label":"Delay Sec Between","tooltip":"","group":"963f0a7c.dc1ca8","order":5,"width":9,"height":2,"wrap":false,"passthru":false,"topic":"delay","topicType":"str","format":"{{value}}","min":0,"max":"30","step":1,"x":610,"y":1100,"wires":[["eda2f19a.35472"]]},{"id":"2343e8c.d0e5018","type":"delay","z":"638a1ba8.eab274","name":"Delay Between","pauseType":"delayv","timeout":"10000","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1020,"y":1640,"wires":[["18624c66.cf7564"]]},{"id":"f5dacd6.6115f3","type":"function","z":"638a1ba8.eab274","name":"","func":"global.set(\"gallons_of_water\", msg.payload);\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":1720,"wires":[[]]},{"id":"5956e351.3b8c3c","type":"function","z":"638a1ba8.eab274","name":"Read gallons","func":"msg.payload = global.get(\"gallons_of_water\") || 0;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":150,"y":1480,"wires":[["c8de860.7583b78"]]},{"id":"b45905d9.ceee58","type":"delay","z":"638a1ba8.eab274","name":"Delay Between","pauseType":"delayv","timeout":"10000","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":680,"y":1760,"wires":[["2bd91765.c7cf28"]]},{"id":"4a4490a7.05358","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"967933ee.45097","order":3,"width":4,"height":3,"passthru":false,"label":"1mL pH UP Shot","tooltip":"","color":"","bgcolor":"","icon":"","payload":"4","payloadType":"num","topic":"payload","topicType":"msg","x":270,"y":1980,"wires":[["7d42f8aa.cad448"]]},{"id":"f1609208.9e011","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"967933ee.45097","order":1,"width":4,"height":3,"passthru":false,"label":"1mL pH DOWN Shot","tooltip":"","color":"","bgcolor":"","icon":"","payload":"5","payloadType":"num","topic":"payload","topicType":"msg","x":280,"y":2020,"wires":[["7d42f8aa.cad448"]]},{"id":"7d42f8aa.cad448","type":"function","z":"638a1ba8.eab274","name":"Build Dispense 0.5mL Message","func":"const payload = { cmd: 0xA0, floatVal: 1.0, port: msg.payload }\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":1840,"wires":[["18624c66.cf7564"]]},{"id":"dd3e92c2.20771","type":"ui_template","z":"638a1ba8.eab274","group":"b35587bd.c30058","name":"Make buttons bigger","order":28,"width":0,"height":0,"format":"<div ng-bind-html=\"msg.payload\">\n    <script>\n        var style=document.getElementById('growbotstyle');\n        if (!style) {\n            style=document.createElement('style');\n            style.id = 'growbotstyle';\n        \n        }\n        \nstyle.type='text/css';\n\nvar cssStyles = `\n.nr-dashboard-numeric > * .down-button {\n\twidth: 96px !important;\n\theight: 96px !important;\n}\n\n.nr-dashboard-numeric > * .up-button {\n\twidth: 96px !important;\n\theight: 96px !important;\n}\n\n.nr-dashboard-numeric > * .down-button > * ng-md-icon {\n\ttransform: scale(2)\t\n}\n\n.nr-dashboard-numeric > * .up-button > * ng-md-icon {\n\ttransform: scale(2)\t\n}\n\n`;\nif(style.styleSheet){\n    style.styleSheet.cssText=cssStyles;\n}else{\n    style.appendChild(document.createTextNode(cssStyles));\n}\ndocument.getElementsByTagName('head')[0].appendChild(style);\n    </script>\n    \n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":440,"y":880,"wires":[[]]},{"id":"e5da1e94.44b1f","type":"ui_date_picker","z":"68dd499a.a366c8","name":"Start Date","label":"Start Date","group":"ab3ec0cf.5f1fc","order":1,"width":7,"height":1,"passthru":true,"topic":"startdate","topicType":"str","x":100,"y":140,"wires":[["f28325f4.59bf78"]]},{"id":"3ec05563.b8968a","type":"ui_date_picker","z":"68dd499a.a366c8","name":"End Date","label":"End Date","group":"ab3ec0cf.5f1fc","order":2,"width":7,"height":1,"passthru":true,"topic":"enddate","topicType":"str","x":120,"y":200,"wires":[["f28325f4.59bf78"]]},{"id":"f28325f4.59bf78","type":"function","z":"68dd499a.a366c8","name":"Date Global Setters","func":"if (msg.topic == \"startdate\") {\n    global.set(\"history_start_timestamp\", new Date(msg.payload).getTime());\n} else if (msg.topic == \"enddate\") {\n    global.set(\"history_start_timestamp\", new Date(msg.payload).getTime());\n} \nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":140,"wires":[[]]},{"id":"638db2b3.12e6fc","type":"ui_button","z":"68dd499a.a366c8","name":"","group":"ab3ec0cf.5f1fc","order":16,"width":0,"height":0,"passthru":false,"label":"Go","tooltip":"","color":"","bgcolor":"","icon":"","payload":"go","payloadType":"str","topic":"topic","topicType":"msg","x":110,"y":300,"wires":[["280076bc.39b6fa"]]},{"id":"b9e9913b.47eae","type":"function","z":"38def9ff.21aea6","name":"Create VALUE insert","func":"let fields = \"\";\nlet values = \"\";\nconst addOne = (field, val) => {\n\tfields  += field + \",\";\n\tvalues += val + \",\";\n};\n\nlet obj = msg.payload;\nif (!obj || !Object.keys(obj)) {\n\treturn null;\n}\nfor (let key of Object.keys(obj)) {\n\tlet val = obj[key];\n\tlet fname = key;\n\tif (val == null) {\n\t\taddOne(fname, \"null\");\n\t}\n\telse if (typeof val === \"object\") {\n\t\tfor (let subkey of Object.keys(val)) {\n\t\t\tif (subkey == \"buckets\" || subkey == \"bucketWaterLevelCalibration\" || subkey == \"pumpPercent\" || subkey == \"pumpOn\" || subkey == \"pumpCalibration\") {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tlet subval = val[subkey];\n\t\t\tlet subfname = fname + \"_\" + subkey;\n\t\t\tif (subval == null) {\n\t\t\t\taddOne(subfname, \"null\");\n\t\t\t}\n\t\t\telse if (typeof subval === \"object\") {\n\t\t\t\tfor (let subsubkey of Object.keys(subval)) {\n\t\t\t\t\tlet subsubval = subval[subsubkey];\n\t\t\t\t\tlet subsubfname = subfname + \"_\" + subsubkey;\n\n\t\t\t\t\tif (subsubval === null) {\n\t\t\t\t\t\taddOne(subsubfname, \"null\");\n\t\t\t\t\t}\n\t\t\t\t\telse if (typeof subsubval === \"string\") {\n\t\t\t\t\t\taddOne(subsubfname, \"'\" + subsubval.replace(/\\'/g,\"''\") + \"'\");                            \n\t\t\t\t\t} else if (Number.isNaN(subsubval)) {\n\t\t\t\t\t\taddOne(subsubfname, \"null\");\n\t\t\t\t\t} else {\n\t\t\t\t\t\taddOne(subsubfname, subsubval.toString());\n\t\t\t\t\t}                        \n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t\tif (subval === null) {\n\t\t\t\t\t\taddOne(subfname, \"null\");\n\t\t\t\t\t}\n\t\t\t\t\telse if (typeof subval === \"string\") {\n\t\t\t\t\t\taddOne(subfname, \"'\" + subval.replace(/\\'/g,\"''\") + \"'\");\n\t\t\t\t\t} else if (Number.isNaN(subval)) {\n\t\t\t\t\t\taddOne(subfname, \"null\");\n\t\t\t\t\t} else {\n\t\t\t\t\t\taddOne(subfname, subval.toString());\n\t\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\tif (val === null) {\n\t\t\taddOne(fname, \"null\");\n\t\t}\n\t\telse if (typeof val === \"string\") {\n\t\t\taddOne(fname, \"'\" + val.replace(/\\'/g,\"''\") + \"'\");\n\t\t} else if (Number.isNaN(val)) {\n\t\t\taddOne(fname, \"NaN\");\n\t\t} else {\n\t\t\taddOne(fname, val.toString());\n\t\t}\n\t}\n}\nfields = fields.substr(0, fields.length - 1);\nvalues = values.substr(0, values.length - 1);\n\nmsg.topic = `INSERT INTO data (${fields}) VALUES (${values});`;\nmsg.payload = msg.topic;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":160,"wires":[["eb38bf14.88356"]]},{"id":"eb38bf14.88356","type":"sqlite","z":"38def9ff.21aea6","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"State History","x":790,"y":160,"wires":[[]]},{"id":"b81b9626.dd20e8","type":"function","z":"38def9ff.21aea6","name":"Load spatialite extension","func":"msg.extension = \"/usr/local/lib/mod_spatialite\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":80,"wires":[["435139e.499a1c8"]]},{"id":"435139e.499a1c8","type":"sqlite","z":"38def9ff.21aea6","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"","x":560,"y":80,"wires":[[]]},{"id":"b39ff1be.5708","type":"inject","z":"68dd499a.a366c8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":40,"wires":[["adcd11dc.f5a82"]]},{"id":"adcd11dc.f5a82","type":"function","z":"68dd499a.a366c8","name":"Load spatialite extension","func":"msg.extension = \"/usr/local/lib/mod_spatialite\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":40,"wires":[["17267c13.d20064"]]},{"id":"17267c13.d20064","type":"sqlite","z":"68dd499a.a366c8","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"","x":730,"y":40,"wires":[[]]},{"id":"12737952.1e2057","type":"sqlite","z":"68dd499a.a366c8","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":400,"wires":[["3edc45e8.1c39fa","e72c1c85.b11de"]]},{"id":"90c1492b.97dc38","type":"function","z":"68dd499a.a366c8","name":"Build Simplified Query","func":"if (!msg.payload.fields) {\n    return null;\n}\nconst startStamp = msg.payload.startStamp;\nconst endStamp = msg.payload.endStamp;\nconst fieldDefs = [];\nconst allFields = [\n                ['config_exhaustFanPercent', 1],\n                ['config_intakeFanPercent', 1],\n                ['config_exhaustFanOn', 1],\n                ['config_intakeFanOn', 1],\n                ['data_ambientInternal1_temperatureC', .25],\n                ['data_ambientInternal1_humidity', 1],\n                ['data_luxAmbient1', 1],\n                ['data_waterData_ph', .01],\n                ['data_waterData_tds', 1],\n                ['data_controlBucket_temperatureC', .25],\n                ['data_controlBucket_waterLevelPercent', 3.5],\n                ['data_waterChillerStatus', 1]\n        ];\nfor (let field of allFields) {\n    if (msg.payload.fields.includes(field[0])) {\n        fieldDefs.push(field);\n    }\n}\nlet innerFieldStr = \"timestamp*1.0 as timestamp, \";\nlet outerFieldStr = \"\";\nfor (let fieldDef of fieldDefs) {\n        innerFieldStr += `${fieldDef[0]}*1.0 as ${fieldDef[0]}, `;\n        outerFieldStr += `AsText(ST_Simplify(MakeLine(ST_Point(timestamp, ${fieldDef[0]})),${fieldDef[1]})) as ${fieldDef[0]}, `;\n}\ninnerFieldStr = innerFieldStr.substr(0, innerFieldStr.length - 2);\nouterFieldStr = outerFieldStr.substr(0, outerFieldStr.length - 2);\n\nlet sql = `select ${outerFieldStr} from (select ${innerFieldStr} from data where timestamp >= ${startStamp} and timestamp <= ${endStamp} order by timestamp asc) x group by '';`\nmsg.topic = sql;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":300,"wires":[["12737952.1e2057"]]},{"id":"280076bc.39b6fa","type":"function","z":"68dd499a.a366c8","name":"set query params","func":"var startStamp = global.get(\"history_start_timestamp\") || (Date.now() - 86400000);\nstartStamp = new Date(startStamp);\nstartStamp.setHours(0,0,0,0);\nvar endStamp = global.get(\"history_end_timestamp\") || Date.now();\nendStamp = new Date(endStamp);\nendStamp.setHours(0,0,0,0);\nendStamp.setDate(endStamp.getDate() + 1);\nmsg.payload = {fields: [\n            \"data_ambientInternal1_temperatureC\",\n            \"data_ambientInternal1_humidity\",\n            \"data_waterData_ph\",\n            \"data_waterData_tds\",\n            'data_luxAmbient1',\n            'data_controlBucket_temperatureC',\n            'data_controlBucket_waterLevelPercent',\n            'data_waterChillerStatus',\n            'config_exhaustFanPercent',\n            'config_intakeFanPercent',\n            'config_exhaustFanOn',\n            'config_intakeFanOn'\n        ],\n        startStamp: startStamp.getTime(),\n        endStamp: endStamp.getTime()\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":570,"y":300,"wires":[["90c1492b.97dc38"]]},{"id":"3edc45e8.1c39fa","type":"function","z":"68dd499a.a366c8","name":"Parse spatialite","func":"if (!msg.payload[0]) {\n    return null;\n}\nlet data = {};\nlet row = msg.payload[0];\nfor (let field of Object.keys(row)) {\n\n    let points = row[field];\n    points = points.split(\"(\")[1];\n    points = points.substr(0, points.length - 1);\n    points = points.split(\",\");\n    data[field] = points.map(x => { let tmp = x.trim().split(\" \"); return { x: new Date(Math.round(tmp[0])), y: parseFloat(tmp[1]) }; });\n}\nmsg.payload = data;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":500,"wires":[["acac5621.ff9388"]]},{"id":"ab9baf7a.e392d","type":"function","z":"68dd499a.a366c8","name":"Charts Builder","func":"var waterTemp = {scale: 'tempc', series: ['Water Temp C (on)', 'Water Temp C (off)'], data: [[], []], \"labels\": ['Water Temp C (on)', 'Water Temp C (off)'], color: \"#4444ff\"};\nvar waterTempOn = waterTemp.data[0];\nvar waterTempOff = waterTemp.data[1];\nvar waterTempOnSeries = {scale: 'tempc', series: ['Water Temp C (on)', 'Water Temp C (off)'], data: [waterTempOn, []], \"labels\": ['Water Temp C (on)'], color: \"#3333ff\"};\nvar waterTempOffSeries = {scale: 'tempc', series: ['Water Temp C (on)', 'Water Temp C (off)'], data: [waterTempOff], \"labels\": ['Water Temp C (off)'], color: \"#444444\"};\nvar waterLevel = {scale: 'percent', series: ['Water Level'], data: [msg.payload.data_controlBucket_waterLevelPercent], labels: ['Water Level'], color: \"#0cc9c0\"};\nvar ph = {scale: 'ph', series: ['pH'], data: [msg.payload.data_waterData_ph.filter(d => d.y > 0 && d.y <= 14)], labels:['pH'], color: '#ff0000'};\nvar tds = {scale: 'tds', series: ['TDS'], data: [msg.payload.data_waterData_tds.filter(d => d.y > 0 && d.y < 2000)], labels: ['TDS'], color: '#00ff00'};\nvar airTemp = {scale: 'tempc', series: ['Ambient Temp'], data: [msg.payload.data_ambientInternal1_temperatureC.filter(d => d.y > 0 && d.y < 100)], labels: ['Ambient Temp'], color: '#b726d4'};\nvar airHumidity = {scale: 'percent', series: ['Ambient Humidity'], data: [msg.payload.data_ambientInternal1_humidity.filter(d => d.y > 0 && d.y < 100)], labels: ['Ambient Humidity'], color: '#deb514'};\nvar lux = {scale: 'lux', series: ['Lux'], data: [msg.payload.data_luxAmbient1], labels: ['Lux'], color: '#fc03f4'};\nvar intakeFan = {scale: 'percent', series: ['Intake Fan'], data: [msg.payload.config_intakeFanPercent], labels: ['Intake Fan'], color: '#11678c'};\nvar exhaustFan = {scale: 'percent', series: ['Exhaust Fan'], data: [msg.payload.config_exhaustFanPercent], labels: ['Exhaust Fan'], color: '#7a0d1c'};\nlet log = [];\n\nlet combined = {}\nfor (let temp of msg.payload.data_controlBucket_temperatureC.filter(d => d.y > 0 && d.y < 100)) {\n    combined[temp.x.getTime()] = { stamp: temp.x, temp: temp.y };\n}\nfor (let chiller of msg.payload.data_waterChillerStatus) {\n    const cTime = chiller.x.getTime();\n    if (!combined[cTime]) {\n        combined[chiller.x.getTime()] = {stamp: chiller.x, on: chiller.y > 0};\n    } else {\n        combined[chiller.x.getTime()][\"on\"] = chiller.y > 0;\n    }\n}\nlet keys = Object.keys(combined).sort();\nif (keys.length > 0) {\n    let lastOn = false;\n    let firstTempKey = keys.find(x=> typeof combined[x].temp !== \"undefined\");\n    let lastTemp = null;\n    let lastTempStamp = combined[keys[0]].stamp;\n    if (firstTempKey !== null) {\n        lastTemp = combined[firstTempKey].temp;\n        lastTempStamp = combined[firstTempKey].stamp;\n    }\n    \n    for (let i = 0; i < keys.length; i++) {\n        const k = keys[i];\n        const obj = combined[k];\n        \n        if (typeof obj.on === 'undefined') {\n            obj.on = lastOn;\n        } else {\n            lastOn = obj.on;\n        }\n        if (typeof obj.temp === 'undefined') {\n\n            let ctr = 1;\n            while ((ctr + i) < keys.length - 1 && typeof combined[keys[ctr + i]].temp  === 'undefined') ctr++;\n            if ((ctr + i) >= keys.length || combined[keys[ctr + i]].temp === 'undefined') {\n                obj.temp = lastTemp;\n            } else {\n                const next = combined[keys[ctr + i]];\n                const timeDiff = next.stamp.getTime() - lastTempStamp.getTime();\n                const tempDiff = next.temp - lastTemp;\n                const totOffs = Math.round((tempDiff / timeDiff) * (obj.stamp.getTime() - lastTempStamp.getTime()) * 100) / 100;\n                obj.temp = lastTemp + totOffs;\n                obj.adjusted = true;\n            }\n\n        } else {\n            lastTemp = obj.temp;\n            lastTempStamp = obj.stamp;\n        }\n    }\n    lastOn = false;\n    let first = true;\n    for (let k of keys) {\n        const d = combined[k];\n        const transition = d.on != lastOn && first == false;\n    \n        if (d.on) {\n            if (transition) {\n                waterTempOff.push({x: d.stamp, y: d.temp });\n                waterTempOn.push({x: d.stamp, y: d.temp });\n            } else {\n                waterTempOn.push({x: d.stamp, y: d.temp });\n                waterTempOff.push({x: d.stamp, y: null });\n            }\n            \n        } else {\n            if (transition) {\n                waterTempOn.push({x: d.stamp, y: d.temp });\n                waterTempOff.push({x: d.stamp, y: d.temp });\n            } else {\n                waterTempOn.push({x: d.stamp, y: null });\n                waterTempOff.push({x: d.stamp, y: d.temp });\n            }\n        }\n        if (first) {\n            first = false;\n        }\n        lastVal = d.temp;\n        lastOn = d.on;\n    }\n\n}\n\nreturn [{  payload: [waterTempOnSeries] },\n        {  payload: [waterTempOffSeries] }, \n        { payload: [waterLevel] },\n        { payload: [ph] },\n        { payload: [tds] },\n        { payload: [airTemp] },\n        { payload: [airHumidity]},\n        { payload: [lux]},\n        { payload: [intakeFan]},\n        { payload: [exhaustFan]}\n];\n","outputs":10,"noerr":0,"initialize":"","finalize":"","libs":[],"x":280,"y":700,"wires":[["8538e84c.ab2e08"],["8538e84c.ab2e08"],["f2cea99.a8bfa58"],["db9dae8.0eaff5"],["af71055c.18f7c8"],["86d57a23.c136a8"],["711b3b8b.d31ec4"],["5464aa34.16af94"],["ba099ffc.910cf"],["f7d8993d.84d618"]]},{"id":"6d263b8d.302fb4","type":"inject","z":"68dd499a.a366c8","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"clear","payload":"","payloadType":"date","x":120,"y":820,"wires":[["43fb15a6.3c224c"]]},{"id":"8538e84c.ab2e08","type":"switch","z":"68dd499a.a366c8","name":"Show water temp","property":"show_water_temp","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":530,"y":600,"wires":[["43fb15a6.3c224c"]]},{"id":"86d57a23.c136a8","type":"switch","z":"68dd499a.a366c8","name":"Show ambient temp","property":"show_ambient_temp","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":540,"y":760,"wires":[["43fb15a6.3c224c"]]},{"id":"711b3b8b.d31ec4","type":"switch","z":"68dd499a.a366c8","name":"Show ambient humidity","property":"show_ambient_humidity","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":550,"y":800,"wires":[["43fb15a6.3c224c"]]},{"id":"f2cea99.a8bfa58","type":"switch","z":"68dd499a.a366c8","name":"Show water level","property":"show_water_level","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":530,"y":640,"wires":[["43fb15a6.3c224c"]]},{"id":"db9dae8.0eaff5","type":"switch","z":"68dd499a.a366c8","name":"Show ph","property":"show_ph","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":500,"y":680,"wires":[["43fb15a6.3c224c"]]},{"id":"af71055c.18f7c8","type":"switch","z":"68dd499a.a366c8","name":"Show tds","property":"show_tds","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":500,"y":720,"wires":[["43fb15a6.3c224c"]]},{"id":"f81174f6.6cae58","type":"change","z":"68dd499a.a366c8","name":"","rules":[{"t":"set","p":"show_water_temp","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":1080,"wires":[[]]},{"id":"9850f607.ca37d8","type":"ui_switch","z":"68dd499a.a366c8","name":"","label":"Water Temp","tooltip":"","group":"ab3ec0cf.5f1fc","order":5,"width":4,"height":1,"passthru":false,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":150,"y":1080,"wires":[["f81174f6.6cae58"]]},{"id":"e9fad6a6.b8dcc8","type":"ui_switch","z":"68dd499a.a366c8","name":"","label":"Water Level","tooltip":"","group":"ab3ec0cf.5f1fc","order":3,"width":4,"height":1,"passthru":false,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":150,"y":1120,"wires":[["7aafc5e2.5dbd3c"]]},{"id":"7aafc5e2.5dbd3c","type":"change","z":"68dd499a.a366c8","name":"","rules":[{"t":"set","p":"show_water_level","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":1120,"wires":[[]]},{"id":"a5c84f5d.9d515","type":"ui_switch","z":"68dd499a.a366c8","name":"","label":"pH","tooltip":"","group":"ab3ec0cf.5f1fc","order":7,"width":4,"height":1,"passthru":false,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":130,"y":1160,"wires":[["49ff973c.996378"]]},{"id":"49ff973c.996378","type":"change","z":"68dd499a.a366c8","name":"","rules":[{"t":"set","p":"show_ph","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":1160,"wires":[[]]},{"id":"e77dfa16.ad2af8","type":"ui_switch","z":"68dd499a.a366c8","name":"","label":"TDS","tooltip":"","group":"ab3ec0cf.5f1fc","order":9,"width":4,"height":1,"passthru":false,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":130,"y":1200,"wires":[["69bfb58f.115ffc"]]},{"id":"69bfb58f.115ffc","type":"change","z":"68dd499a.a366c8","name":"","rules":[{"t":"set","p":"show_tds","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":1200,"wires":[[]]},{"id":"64b9d12.0ce043","type":"ui_switch","z":"68dd499a.a366c8","name":"","label":"Air Temp","tooltip":"","group":"ab3ec0cf.5f1fc","order":14,"width":4,"height":1,"passthru":false,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":140,"y":1240,"wires":[["869f6fd3.5041f"]]},{"id":"869f6fd3.5041f","type":"change","z":"68dd499a.a366c8","name":"","rules":[{"t":"set","p":"show_ambient_temp","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":1240,"wires":[[]]},{"id":"9cd49838.6380c8","type":"ui_switch","z":"68dd499a.a366c8","name":"","label":"Air Humid","tooltip":"","group":"ab3ec0cf.5f1fc","order":12,"width":4,"height":1,"passthru":false,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":140,"y":1280,"wires":[["ed1409ee.d2d1f8"]]},{"id":"ed1409ee.d2d1f8","type":"change","z":"68dd499a.a366c8","name":"","rules":[{"t":"set","p":"show_ambient_humidity","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":1280,"wires":[[]]},{"id":"1f4c3e78.761792","type":"function","z":"638a1ba8.eab274","name":"Create dosing table","func":"node.send({payload:{}, topic: `create table if not exists dosing (\n\ttimestamp integer,\n\tport integer,\n\tml integer\n);`});\nsetTimeout(() => {\n    node.send({payload: {}, topic: `create index if not exists idx_dosing_timestamp on dosing (timestamp);`});\n}, 5000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":40,"wires":[["bcf7e578.09f018"]]},{"id":"bcf7e578.09f018","type":"sqlite","z":"638a1ba8.eab274","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"","x":1010,"y":40,"wires":[[]]},{"id":"5b057936.598758","type":"inject","z":"638a1ba8.eab274","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":510,"y":40,"wires":[["1f4c3e78.761792","ca9d04e8.653df8"]]},{"id":"ffb9d39.d04463","type":"sqlite","z":"638a1ba8.eab274","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"","x":1120,"y":220,"wires":[[]]},{"id":"1a59a70.0383059","type":"ui_template","z":"68dd499a.a366c8","group":"ab3ec0cf.5f1fc","name":"Apex chart","order":17,"width":14,"height":6,"format":"<div class=\"nr-dashboard-chart-container\" style=\"width:100%; height:100%;\"> <div class=\"nr-dashboard-chart-nolabel\" style=\"height: calc(100% - 25px); overflow-x: visible; overflow-y: visible;\"  ng-bind-html=\"eleContent | trusted\"></div></div>\n<script>\n    \n    ;(function(scope) {\n        if (typeof ApexCharts === 'undefined') {\n            if (!document.getElementById('apexcharts_script')) {\n                let scriptElement = document.createElement(\"script\");\n                scriptElement.src = \"https://cdn.jsdelivr.net/npm/apexcharts\";\n                document.head.appendChild(scriptElement);\n                console.log(\"injected apexcharts script\");\n            }\n            if (!document.getElementById('apexcharts_style')) {\n                let styleElement = document.createElement(\"style\");\n                styleElement.src = \"https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.27.3/apexcharts.min.css\";\n                document.head.appendChild(styleElement);\n                console.log(\"injected apexcharts styles\");\n            }\n       }\n   \n       //hacky thing because we're only getting json, there's some config stuff that needs to be turned into functions\n        const fixFormatter = function (obj) {\n            if (typeof obj !== 'object') {\n                return;\n            }\n            for (let k of Object.keys(obj)) {\n                if (!obj[k]) {\n                    continue;\n                }\n                if (typeof obj[k] === \"string\") {\n                    if (k === 'formatter') {\n                        try {\n                            obj[k] = new Function(`return ${obj[k]}`)();\n                        } catch {\n                            console.error(\"a formatter function failed to compile: \" + obj[k]);\n                            obj[k] = null;\n                        }\n                    }\n                } else if (typeof obj[k] === \"object\") {\n                    fixFormatter(obj[k]);\n                }\n            }\n        }\n        scope.eleId = 'chart' + Math.random();\n        scope.eleId = scope.eleId.replace(\".\",\"\");\n        \n        scope.eleContent = `<div class=\"chart chart-line\" id=${scope.eleId}></div>`;\n        scope.$watch('msg.payload', function(newVal, oldVal) {\n            let msg = scope.msg;\n            if (!msg) {\n                return;\n            }\n            if (msg.topic == \"noop\") {\n                return;\n            }\n            if (!msg.payload) {\n                return;\n            }\n            let makeChart = null;\n            makeChart = (opts) => {\n                var ctx = document.getElementById(scope.eleId);\n                \n                if (!ctx || typeof ApexCharts === 'undefined') {\n                    console.log(\"canvas or apex isn't loaded yet\");\n                    setTimeout(() => {makeChart(opts);}, 100);\n                    return;\n                }\n                ctx.parentElement.parentElement.parentElement.style.overflow = 'visible';\n                ctx.parentElement.parentElement.style.overflow = 'visible';\n                ctx.parentElement.style.overflow = 'visible';\n\n                try {\n                    for (let s of document.querySelectorAll(\"style\")) { if (s.innerText.includes('.nr-dashboard-theme .nr-dashboard-template path')) { s.innerText = (s.innerText.replace(/\\.nr-dashboard-theme \\.nr-dashboard-template path\\s+\\{[^\\}]*\\}/, '')); }}\n                    scope.chart = new ApexCharts(ctx, opts);\n                    scope.chart.render();\n                } catch (e) {\n                    console.log(\"exception: \");\n                    console.log(e);\n                }\n            }\n            fixFormatter(scope.msg.payload);\n            if (!scope.chart) {\n                makeChart(scope.msg.payload);\n            } else {\n                scope.chart.updateOptions(scope.msg.payload, false, false);   \n                scope.chart.updateSeries(scope.msg.payload.series, false);\n            }\n        })\n\n    })(scope)\n</script>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":990,"y":680,"wires":[[]]},{"id":"b32fea39.b8a8f8","type":"function","z":"68dd499a.a366c8","name":"Build dosing query","func":"var startStamp = global.get(\"history_start_timestamp\") || (Date.now() - 86400000);\nstartStamp = new Date(startStamp);\nstartStamp.setHours(0,0,0,0);\nvar endStamp = global.get(\"history_end_timestamp\") || Date.now();\nendStamp = new Date(endStamp);\nendStamp.setHours(0,0,0,0);\nendStamp.setDate(endStamp.getDate() + 1);\nmsg.payload = {};\nmsg.topic = `select timestamp, port, ml from\n    dosing where timestamp >= ${startStamp.getTime()} and timestamp <= ${endStamp.getTime()} order by timestamp asc;`;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":320,"wires":[["c0809287.cc6e7"]]},{"id":"4a4e189b.eb7018","type":"debug","z":"68dd499a.a366c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1450,"y":700,"wires":[]},{"id":"c0809287.cc6e7","type":"sqlite","z":"68dd499a.a366c8","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"","x":1230,"y":420,"wires":[["6c4adfa2.9a2a2"]]},{"id":"6c4adfa2.9a2a2","type":"function","z":"68dd499a.a366c8","name":"Parse dosing data","func":"if (!msg.payload[0]) {\n    return null;\n}\nvar portData = [[], [], [], [], [], []];\nvar portLabels = [['CaliMagic'], ['Micro'], ['Grow'], ['Bloom'], ['pH Up'], ['pH Down']]\nvar calimagic = {scale: 'ml', series: portLabels[0], data: [portData[0]], labels:portLabels[0], color: '#f5da4277', type:'annox'};\nvar micro = {scale: 'ml', series: portLabels[1], data: [portData[1]], labels: portLabels[1], color: '#781c0077', type:'annox'};\nvar grow = {scale: 'ml', series: portLabels[2], data: [portData[2]], labels: portLabels[2], color: '#a1f77277', type:'annox'};\nvar bloom = {scale: 'ml', series: portLabels[3], data: [portData[3]], labels: portLabels[3], color: '#f772c677', type:'annox'};\nvar phup = {scale: 'ml', series: portLabels[4], data: [portData[4]], labels:portLabels[4], color: '#94dbf777', type:'annox'};\nvar phdown = {scale: 'ml', series: portLabels[5], data: [portData[5]], labels:portLabels[5], color: '#f7d78677', type:'annox'};\nlet data = {};\nfor (let row of msg.payload) {\n    if (row.port >= 0 && row.port <= 5) {\n        portData[row.port].push({x: row.timestamp, y: row.ml});\n        portLabels[row.port] += \" \" + row.ml + \"ml\";\n    }\n}\n\nvar msgs = [\n    \n        [{payload: [calimagic]},\n        {payload: [micro]},\n        {payload: [grow]},\n        {payload: [bloom]},\n        {payload: [phup]},\n        {payload: [phdown]}]\n    \n];\n\n    \n\nreturn msgs;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1270,"y":500,"wires":[["43fb15a6.3c224c"]]},{"id":"fc14c775.f1c158","type":"function","z":"2b4fc933.a97346","name":"","func":"\nconst defaultChartOptions = {\n    colors: [],\n    markers: { strokeWidth: 0, size: 0, radius: 0, showNullDataPoints: false },\n    chart: {\n        animations: {enabled: false, dynamicAnimation: { enabled: false }},\n        redrawOnParentResize: true,\n        type: 'line',\n        zoom: {\n            type: 'x',\n            enabled: true,\n            autoScaleYaxis: true\n        },\n        toolbar: {\n             autoSelected: 'zoom'\n        },\n        height: '100%'\n    },\n    series: [],// {name: 'ph', data: [{x: new Date(), y: 1}, {x: new Date(new Date().getTime() + (1 * 24 * 60 * 60 * 1000)), y: 3 }, {x: new Date(new Date().getTime() + (2 * 24 * 60 * 60 * 1000)), y: 6}] }],\n    xaxis: {\n        type: 'datetime',\n        labels: {\n            show: true,\n            datetimeUTC: false,\n            datetimeFormatter: {\n                year: 'yyyy',\n                month: 'MMM \\'yy',\n                day: 'dd MMM',\n                hour: 'h:mm tt'\n              }\n        },\n        tooltip: {\n            enabled: true,\n            formatter: `function (val, ts) {\n                var d = new Date(val);\n                return d.toLocaleString('default', { month: 'short', day: \"2-digit\", hour: 'numeric', hour12: true, minute: \"2-digit\"});\n            }`\n        }\n    },\n    stroke: {\n\n        width: 2,\n        lineCap: 'butt'\n    },\n    tooltip: {\n        shared: false,\n        y: {\n            formatter: `function (x) {\n                return Math.round(x*100)/100;\n            }`\n        },\n        x: {\n                formatter: `function (val, ts) {\n                var d = new Date(val);\n                return d.toLocaleString('default', { month: 'short', day: \"2-digit\", hour: 'numeric', hour12: true, minute: \"2-digit\"});\n            }`\n        }\n    }\n};\nconst getScope = () => {\n    return context.get(\"scope\") || { chartOptions: JSON.parse(JSON.stringify(defaultChartOptions)), dataUpdateQueue: []};;\n}\nlet scope = getScope();\nconst sendChartConfig = () => {\n    node.send({payload: scope.chartOptions});\n    setTimeout(() => {\n        scope.dataUpdateQueue = [];\n        scope.chartOptions = JSON.parse(JSON.stringify(defaultChartOptions));\n        node.send({payload: {}, topic: \"noop\"});\n    }, 100);\n}\nconst updateData = () => {\n    let any = false;\n    while (scope.dataUpdateQueue.length > 0) {\n        any = true;\n        m = scope.dataUpdateQueue[0];\n        scope.dataUpdateQueue.splice(0,1);\n        \n        let label = m.labels[0]\n        let d = m.data[0];\n        if (m.type == 'annox') {\n            if (!scope.chartOptions.annotations) {\n                scope.chartOptions.annotations = {\n                    xaxis: []\n                };\n            }\n            let ap = scope.chartOptions.annotations.xaxis;\n            for (let p of ap.filter(x=> x.label.text == label)) {\n                let idx = ap.indexOf(p);\n                ap.splice(idx, 1);\n            }\n            for (let dp of d) {\n                let pt = {\n                    x: dp.x,\n                    label: {\n                        text: label,\n                          borderColor: m.color,\n                          style: {\n                            color: \"#fff\",\n                            background: m.color\n                          },    \n                    },\n                    borderColor: m.color,\n                }\n                ap.push(pt);\n            }\n        } else {\n            \n        \n            let foundIdx = scope.chartOptions.series.findIndex(x => x.name == label);\n    \n            \n            if (foundIdx >=0) {\n                scope.chartOptions.series[foundIdx].data = d;\n            } else {\n                if (!scope.chartOptions.yaxis) {\n                    scope.chartOptions.yaxis = [];\n                } \n                else if (scope.chartOptions.yaxis.length == 1 && !scope.chartOptions.yaxis[0].seriesName) {\n                    scope.chartOptions.yaxis = [];\n                }\n                let foundAxis = (scope.chartOptions.yaxis || []).find(x=> x.scaleName == m.scale);\n                let scaleSeriesName = label;\n                let scaleSeriesOpposite = scope.chartOptions.yaxis.length %2 == 0;\n                let min = undefined;\n                let max = undefined;\n                for (let dp of d) {\n                    if (dp.y !== null) {\n                        if (min === undefined || dp.y < min) {\n                            min = dp.y;\n                        }\n                        if (max === undefined || dp.y > max) {\n                            max = dp.y\n                        }\n                    }\n                }\n                \n                let pad = Math.abs(min - max) & .15;\n                if (pad < .75) {\n                    pad = .75;\n                }\n                min -= pad;\n                max += pad;\n                min = Math.floor(min);\n                max = Math.ceil(max);\n                if (min == max) {\n                    max += 1;\n                }\n                //dbg.push(`min ${min} max ${max} for label ${label} seriesname ${scaleSeriesName}`);\n                if (foundAxis) {\n                    scaleSeriesName = foundAxis.seriesName;\n                    scaleSeriesOpposite = foundAxis.opposite;\n                    //dbg.push(`for ${label} found series name ${scaleSeriesName} for scale ${m.scale}`);\n                    let changed = false;\n                    if (foundAxis.min < min ) {\n                        min = foundAxis.min;\n                        \n                    } else {\n                        changed = true;\n                    }\n                    if (foundAxis.max > max) {\n                        max = foundAxis.max;\n\n                    } else {\n                        changed = true;\n                    }\n                    if (changed) {\n                       // dbg.push(`hit, min ${min} max ${max}`);\n                        for (let axis of (scope.chartOptions.yaxis || []).filter(x=> x.scaleName == m.scale)) {\n                            axis.min = min;\n                            axis.max = max;\n                        }\n                    }\n                } else {\n                    //dbg.push(`didn't find series name for scale ${m.scale}, using ${scaleSeriesName} min is ${min} max is ${max}`);\n                }\n               // node.send({payload: dbg});\n                var ser = {name: label, data: d};\n                scope.chartOptions.series.push(ser);\n    \n                var yax = { \n                    seriesName: scaleSeriesName, \n                    scaleName: m.scale, \n                    opposite: scaleSeriesOpposite,\n                    labels: {\n                        show: false,\n                    },\n                    min: min,\n                    max: max\n                };\n    \n                scope.chartOptions.yaxis.push(yax);\n                scope.chartOptions.colors.push(m.color || Apex.colors[scope.chartOptions.colors.length]);\n            }\n        }\n    }\n    if (any) {\n        sendChartConfig();\n    }\n}\nconst doUpdateWait = () => {\n    if (scope.updateHandle) {\n        clearTimeout(scope.updateHandle);\n    }\n    scope.updateHandle = setTimeout(() => { try {\n        scope = getScope();\n        updateData();\n    } finally {\n        scope.updateHandle = null;\n        context.set(\"scope\", scope);\n    } }, 3000);\n\n}\ntry {\n    let chartOptions = scope.chartOptions;\n    let dataUpdateQueue = scope.dataUpdateQueue;\n    if (msg.topic == \"clear\") {\n        //todo: clear chart here\n        if (scope.updateHandle) {\n            clearTimeout(scope.updateHandle);\n            scope.updateHandle = null;\n        }\n        scope.dataUpdateQueue = [];\n        scope.chartOptions = JSON.parse(JSON.stringify(defaultChartOptions));\n        sendChartConfig();\n        return;\n    }\n    if (!msg.payload) {\n        throw \"payload null\";\n    }\n    if (!Array.isArray(msg.payload)) {\n        throw \"not array\";\n    }\n    dataUpdateQueue.push(msg.payload[0]);\n    doUpdateWait();\n} finally {         \n    context.set(\"scope\", scope);\n}\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":100,"wires":[[]]},{"id":"43fb15a6.3c224c","type":"subflow:2b4fc933.a97346","z":"68dd499a.a366c8","name":"","x":780,"y":680,"wires":[["1a59a70.0383059","c24ee7a0.871c18"]]},{"id":"c199c539.1f1bd8","type":"function","z":"5189c7b3.782c68","name":"","func":"const defaultChartOptions = {\n    colors: [],\n    markers: { strokeWidth: 0, size: 0, radius: 0, showNullDataPoints: false },\n    chart: {\n        animations: {enabled: false, dynamicAnimation: { enabled: false }},\n        redrawOnParentResize: true,\n        type: 'line',\n        zoom: {\n            type: 'x',\n            enabled: true,\n            autoScaleYaxis: true\n        },\n        toolbar: {\n\n            show: true,\n            offsetX: 0,\n            offsetY: 0,\n            tools: {\n              download: false,\n              selection: false,\n              zoom: true,\n              zoomin: false,\n              zoomout: false,\n              pan: false,\n              reset: true\n            },\n            autoSelected: 'zoom'\n        },\n        height: '100%'\n    },    \n    title: {\n        text: env.get(\"Title\"),\n        align: 'center',\n        floating: true\n    },\n    series: [],// {name: 'ph', data: [{x: new Date(), y: 1}, {x: new Date(new Date().getTime() + (1 * 24 * 60 * 60 * 1000)), y: 3 }, {x: new Date(new Date().getTime() + (2 * 24 * 60 * 60 * 1000)), y: 6}] }],\n    xaxis: {\n        type: 'datetime',\n        labels: {\n            show: true,\n            datetimeUTC: false,\n            datetimeFormatter: {\n                year: 'yyyy',\n                month: 'MMM \\'yy',\n                day: 'dd MMM',\n                hour: 'h:mm tt'\n              }\n        },\n        tooltip: {\n            enabled: true,\n            formatter: `function (val, ts) {\n                var d = new Date(val);\n                return d.toLocaleString('default', { month: 'short', day: \"2-digit\", hour: 'numeric', hour12: true, minute: \"2-digit\"});\n            }`\n        }\n    },\n    stroke: {\n\n        width: 2,\n        lineCap: 'butt'\n    },\n    tooltip: {\n        shared: false,\n        y: {\n            formatter: `function (x) {\n                return Math.round(x*100)/100;\n            }`\n        },\n        x: {\n                formatter: `function (val, ts) {\n                var d = new Date(val);\n                return d.toLocaleString('default', { month: 'short', day: \"2-digit\", hour: 'numeric', hour12: true, minute: \"2-digit\"});\n            }`\n        }\n    },\n    legend: { show: false }\n};\nconst getScope = () => {\n    return context.get(\"scope\") || { chartOptions: JSON.parse(JSON.stringify(defaultChartOptions)), dataUpdateQueue: []};;\n}\nlet scope = getScope();\nconst sendChartConfig = () => {\n    node.send({payload: scope.chartOptions});\n    setTimeout(() => {\n        scope.dataUpdateQueue = [];\n        scope.chartOptions = JSON.parse(JSON.stringify(defaultChartOptions));\n        node.send({payload: {}, topic: \"noop\"});\n    }, 100);\n}\nconst updateData = () => {\n    let any = false;\n    while (scope.dataUpdateQueue.length > 0) {\n        any = true;\n        m = scope.dataUpdateQueue[0];\n        scope.dataUpdateQueue.splice(0,1);\n        \n        let label = m.labels[0]\n        let d = m.data[0];\n        if (m.type == 'annox') {\n            if (!scope.chartOptions.annotations) {\n                scope.chartOptions.annotations = {\n                    xaxis: []\n                };\n            }\n            let ap = scope.chartOptions.annotations.xaxis;\n            for (let p of ap.filter(x=> x.label.text == label)) {\n                let idx = ap.indexOf(p);\n                ap.splice(idx, 1);\n            }\n            for (let dp of d) {\n                let pt = {\n                    text: null,\n                    x: dp.x,\n                    label: {\n                            strokeDashArray: 1,    \n                          borderColor: m.color,\n                          style: {\n                            color: m.color,\n                            background: m.color\n                          },    \n                    },\n                    borderWidth: 2,\n                    borderColor: m.color,\n                }\n                ap.push(pt);\n            }\n        } else {\n            \n        \n            let foundIdx = scope.chartOptions.series.findIndex(x => x.name == label);\n    \n            \n            if (foundIdx >=0) {\n                scope.chartOptions.series[foundIdx].data = d;\n            } else {\n                if (!scope.chartOptions.yaxis) {\n                    scope.chartOptions.yaxis = [];\n                } \n                else if (scope.chartOptions.yaxis.length == 1 && !scope.chartOptions.yaxis[0].seriesName) {\n                    scope.chartOptions.yaxis = [];\n                }\n                let foundAxis = (scope.chartOptions.yaxis || []).find(x=> x.scaleName == m.scale);\n                let scaleSeriesName = label;\n                let scaleSeriesOpposite = scope.chartOptions.yaxis.length %2 == 0;\n                let min = undefined;\n                let max = undefined;\n                for (let dp of d) {\n                    if (dp.y !== null) {\n                        if (min === undefined || dp.y < min) {\n                            min = dp.y;\n                        }\n                        if (max === undefined || dp.y > max) {\n                            max = dp.y\n                        }\n                    }\n                }\n                \n                let pad = Math.abs(min - max) & .15;\n                if (pad < .75) {\n                    pad = .75;\n                }\n                min -= pad;\n                max += pad;\n                min = Math.floor(min);\n                max = Math.ceil(max);\n                if (min == max) {\n                    max += 1;\n                }\n                if (foundAxis) {\n                    scaleSeriesName = foundAxis.seriesName;\n                    scaleSeriesOpposite = foundAxis.opposite;\n                    console.log(`found series name ${scaleSeriesName} for scale ${m.scale}`);\n                    let changed = false;\n                    if (foundAxis.min < min ) {\n                        min = foundAxis.min;\n                        changed = true;\n                    } else {\n                        min = foundAxis.min;\n                    }\n                    if (foundAxis.max > max) {\n                        max = foundAxis.max;\n                        changed = true;\n                    } else {\n                        max = foundAxis.max;\n                    }\n                    if (changed) {\n                        for (let axis of (scope.chartOptions.yaxis || []).filter(x=> x.scaleName == m.scale)) {\n                            axis.min = min;\n                            axis.max = max;\n                        }\n                    }\n                } else {\n                    console.log(`didn't find series name for scale ${m.scale}, using ${scaleSeriesName}`);\n                }\n                var ser = {name: label, data: d};\n\n                scope.chartOptions.series.push(ser);\n\n                var yax = { \n                    seriesName: scaleSeriesName, \n                    scaleName: m.scale, \n                    opposite: scaleSeriesOpposite,\n                    floating: !!foundAxis,\n                    labels: {\n                        maxWidth: foundAxis?0:25,\n                        show: !foundAxis,\n                        formatter: env.get(\"fixedpoint\")?`function(x) { return x.toFixed(0); }`:`function(x) { return Math.round(x * 100)/100; }`\n                    },\n                    min: min,\n                    max: max,\n                    forceNiceScale: true,\n                };\n    \n                scope.chartOptions.yaxis.push(yax);\n                scope.chartOptions.colors.push(m.color || Apex.colors[scope.chartOptions.colors.length]);\n            }\n        }\n    }\n    if (any) {\n        sendChartConfig();\n    }\n}\nconst doUpdateWait = () => {\n    if (scope.updateHandle) {\n        clearTimeout(scope.updateHandle);\n    }\n    scope.updateHandle = setTimeout(() => { try {\n        scope = getScope();\n        updateData();\n    } finally {\n        scope.updateHandle = null;\n        context.set(\"scope\", scope);\n    } }, 3000);\n\n}\ntry {\n    let chartOptions = scope.chartOptions;\n    let dataUpdateQueue = scope.dataUpdateQueue;\n    if (msg.topic == \"clear\") {\n        //todo: clear chart here\n        if (scope.updateHandle) {\n            clearTimeout(scope.updateHandle);\n            scope.updateHandle = null;\n        }\n        scope.dataUpdateQueue = [];\n        scope.chartOptions = JSON.parse(JSON.stringify(defaultChartOptions));\n        sendChartConfig();\n        return;\n    }\n    if (!msg.payload) {\n        return null;\n    }\n    if (!Array.isArray(msg.payload)) {\n        throw \"not array\";\n    }\n    dataUpdateQueue.push(msg.payload[0]);\n    doUpdateWait();\n} finally {         \n    context.set(\"scope\", scope);\n}\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":100,"wires":[["24ed378f.0e5908"]]},{"id":"1231ae06.526dc2","type":"ui_switch","z":"68dd499a.a366c8","name":"","label":"Dosing","tooltip":"","group":"ab3ec0cf.5f1fc","order":11,"width":4,"height":1,"passthru":false,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":130,"y":1340,"wires":[["c99bcef0.c15ca"]]},{"id":"c99bcef0.c15ca","type":"change","z":"68dd499a.a366c8","name":"","rules":[{"t":"set","p":"show_dosing","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":360,"y":1340,"wires":[[]]},{"id":"e72c1c85.b11de","type":"switch","z":"68dd499a.a366c8","name":"Show dosing","property":"show_dosing","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1030,"y":340,"wires":[["b32fea39.b8a8f8"]]},{"id":"9f3b8982.948a58","type":"function","z":"2c950cc0.f5b4d4","name":"Parse binary data","func":"var offset = 0;\nif (msg.payload.length != 224) {\n    throw \"got wrong payload size of \" + msg.payload.length\n}\nvar readbool = function(skipBytes) {\n    var val = msg.payload.readUInt8(offset);\n    offset += 1;\n    if (skipBytes) {\n        offset += skipBytes;\n    }\n    return !!val;\n}\nvar readint = function() {\n    var val = msg.payload.readInt32LE(offset);\n    offset += 4;\n    return val;\n}\nvar readfloat = function() {\n    var val = msg.payload.readFloatLE(offset);\n    offset += 4;\n    return val;\n}\nmsg.payload = {\n        timestamp: Date.now(),\n        current_mode: readint(),\n        config: {\n            exhaustFanPercent: readint(),\n            intakeFanPercent: readint(),\n            //these bool flags will be set later\n            exhaustFanOn: readbool(),\n            intakeFanOn: readbool(),\n            pumpOn: readbool(),\n            bubblesOn: readbool(),\n            exhaustFanCalibration: {\n                minOffset: readint(),\n                maxOffset: readint(),\n                spinUpSec: readint()\n            },\n            intakeFanCalibration: {\n                minOffset: readint(),\n                maxOffset: readint(),\n                spinUpSec: readint()\n            },\n            samplingIntervalMS: readint(),\n            waterChillerThermostat: {\n                mode: readint(),\n                minValue: readfloat(),\n                maxValue: readfloat()\n            },\n            lightsSchedule: {\n                status: readint(),\n                turnOnGmtHourMin: readint(),\n                turnOffGmtHourMin: readint()\n            },\n            roomFanSchedule: {\n                status: readint(),\n                turnOnGmtHourMin: readint(),\n                turnOffGmtHourMin: readint()\n            }\n        },\n        data: {\n            exhaustInternal: {\n                temperatureC: readfloat(),\n                humidity: readfloat()\n            },\n            exhaustExternal: {\n                temperatureC: readfloat(),\n                humidity: readfloat()\n            },\n            intakeInternal: {\n                temperatureC: readfloat(),\n                humidity: readfloat()\n            },\n            intakeExternal: {\n                temperatureC: readfloat(),\n                humidity: readfloat()\n            },\n            ambientInternal1: {\n                temperatureC: readfloat(),\n                humidity: readfloat()\n            },\n            ambientInternal2: {\n                temperatureC: readfloat(),\n                humidity: readfloat()\n            },\n            ambientInternal3: {\n                temperatureC: readfloat(),\n                humidity: readfloat()\n            },\n            lights: {\n                temperatureC: readfloat(),\n                humidity: readfloat()\n            },\n            luxAmbient1: readfloat(),\n            luxAmbient2: readfloat(),\n            luxAmbient3: readfloat(),\n            luxAmbient4: readfloat(),\n            luxAmbient5: readfloat(),\n            waterData: {\n                ph: Math.round(readfloat() * 1000)/1000,\n                tds: readfloat()\n            },\n            controlBucket: {\n                temperatureC: readfloat(),\n                waterLevelPercent: readfloat()\n            },\n            waterChillerStatus: readfloat(),\n            lightsOn: readbool(),\n            roomFanOn: readbool(),\n            pumpOn: readbool(),\n            pumpEmergencyShutoff: readbool(),\n            bubblesOn: readbool(3),\n            buckets: [\n                {\n                    temperatureC: readfloat(),\n                    waterLevelPercent: readfloat()\n                },\n                {\n                    temperatureC: readfloat(),\n                    waterLevelPercent: readfloat()\n                },\n                {\n                    temperatureC: readfloat(),\n                    waterLevelPercent: readfloat()\n                },\n                {\n                    temperatureC: readfloat(),\n                    waterLevelPercent: readfloat()\n                }\n            ]\n        }\n    }\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":120,"wires":[[]]},{"id":"a9765549.092e18","type":"function","z":"fb6e1899.829f18","name":"Inject Latest Config","func":"if (!msg.origVal) {\n    msg.origVal = global.get(\"latest_config\");\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":180,"wires":[["f8f18d4.118a27"]]},{"id":"f8f18d4.118a27","type":"topic-to-prop","z":"fb6e1899.829f18","name":"","topic":"","x":230,"y":220,"wires":[["8aa09a59.2868d8"]]},{"id":"8aa09a59.2868d8","type":"function","z":"fb6e1899.829f18","name":"update global config","func":"if (msg.payload) {\n    global.set(\"latest_config\", msg.payload);\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":260,"wires":[["ebf654dd.c73368"]]},{"id":"ebf654dd.c73368","type":"debounce","z":"fb6e1899.829f18","time":1000,"name":"","x":300,"y":300,"wires":[["9909e1f1.2535e"]]},{"id":"9909e1f1.2535e","type":"function","z":"fb6e1899.829f18","name":"Make binary config message","func":"var cfg = msg.payload;\nif (!cfg) {\n    return null;\n}\nvar buf = Buffer.alloc(76 + 1)\nvar offset = 0;\noffset = buf.writeUInt8(0x10, 0);\noffset = buf.writeInt32LE(cfg.exhaustFanPercent, offset);\noffset = buf.writeInt32LE(cfg.intakeFanPercent, offset);\noffset = buf.writeUInt8(cfg.exhaustFanOn?1:0, offset);\noffset = buf.writeUInt8(cfg.intakeFanOn?1:0, offset);\noffset = buf.writeUInt8(cfg.pumpOn?1:0, offset);\noffset = buf.writeUInt8(cfg.bubblesOn?1:0, offset);\noffset = buf.writeInt32LE(cfg.exhaustFanCalibration.minOffset, offset);\noffset = buf.writeInt32LE(cfg.exhaustFanCalibration.maxOffset, offset);\noffset = buf.writeInt32LE(cfg.exhaustFanCalibration.spinUpSec, offset);\n\noffset = buf.writeInt32LE(cfg.intakeFanCalibration.minOffset, offset);\noffset = buf.writeInt32LE(cfg.intakeFanCalibration.maxOffset, offset);\noffset = buf.writeInt32LE(cfg.intakeFanCalibration.spinUpSec, offset);\n\noffset = buf.writeInt32LE(cfg.samplingIntervalMS, offset);\n\noffset = buf.writeInt32LE(cfg.waterChillerThermostat.mode, offset);\noffset = buf.writeFloatLE(cfg.waterChillerThermostat.minValue, offset);\noffset = buf.writeFloatLE(cfg.waterChillerThermostat.maxValue, offset);\noffset = buf.writeInt32LE(cfg.lightsSchedule.status, offset);\noffset = buf.writeInt32LE(cfg.lightsSchedule.turnOnGmtHourMin, offset);\noffset = buf.writeInt32LE(cfg.lightsSchedule.turnOffGmtHourMin, offset);\noffset = buf.writeInt32LE(cfg.roomFanSchedule.status, offset);\noffset = buf.writeInt32LE(cfg.roomFanSchedule.turnOnGmtHourMin, offset);\noffset = buf.writeInt32LE(cfg.roomFanSchedule.turnOffGmtHourMin, offset);\nmsg.payload = buf;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":340,"wires":[["4530a670.592388"]]},{"id":"4530a670.592388","type":"mqtt out","z":"fb6e1899.829f18","name":"Message to Growbot","topic":"GROWBOT_CONFIG","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"9243fa99.15cf28","x":760,"y":380,"wires":[]},{"id":"ecec9182.21db8","type":"mqtt in","z":"6bb640c6.525a5","name":"Message from Growbot","topic":"GROWBOT","qos":"2","datatype":"auto","broker":"9243fa99.15cf28","nl":false,"rap":true,"rh":0,"x":120,"y":40,"wires":[["bd137d2a.577ac"]]},{"id":"bd137d2a.577ac","type":"subflow:2c950cc0.f5b4d4","z":"6bb640c6.525a5","name":"","env":[],"x":220,"y":100,"wires":[["c1ebcf2d.c4ffb","c4cfd531.18b6b8","c1c2b0f8.c9226","fc42ebdc.c32b48","b7c55316.c17f6"]]},{"id":"4c0921e0.24b47","type":"mqtt out","z":"6bb640c6.525a5","name":"Message to Growbot","topic":"GROWBOT_CONFIG","qos":"1","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"9243fa99.15cf28","x":1440,"y":680,"wires":[]},{"id":"c91b428a.233dd","type":"function","z":"6bb640c6.525a5","name":"Make Mode Message","func":"\nvar buf = Buffer.alloc(2)\nvar offset = 0;\noffset = buf.writeUInt8(0x2, 0);\noffset = buf.writeUInt8(msg.payload, offset);\nmsg.payload = buf;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1420,"y":780,"wires":[["4c0921e0.24b47"]]},{"id":"c209008e.7439c","type":"ui_numeric","z":"6bb640c6.525a5","name":"","label":"Sample Interval Sec","tooltip":"","group":"96d9d6c0.428e28","order":1,"width":0,"height":0,"wrap":false,"passthru":false,"topic":"samplingIntervalMS","topicType":"str","format":"{{value}}","min":"2","max":"300","step":1,"x":520,"y":320,"wires":[["e556c5dc.a3adf8"]]},{"id":"e556c5dc.a3adf8","type":"function","z":"6bb640c6.525a5","name":"s to ms","func":"msg.payload *= 1000;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":360,"wires":[["84cc42f5.c1bcd"]]},{"id":"18221c7f.e37354","type":"ui_slider","z":"6bb640c6.525a5","name":"","label":"Exhaust Fan Min Offset","tooltip":"","group":"a2345340.dcf1","order":8,"width":0,"height":0,"passthru":false,"outs":"end","topic":"exhaustFanCalibration.minOffset","topicType":"str","min":"1","max":"30","step":1,"x":530,"y":400,"wires":[["84cc42f5.c1bcd"]]},{"id":"1cb8abc4.7b6104","type":"ui_slider","z":"6bb640c6.525a5","name":"","label":"Exhaust Fan Max Offset","tooltip":"","group":"a2345340.dcf1","order":9,"width":0,"height":0,"passthru":false,"outs":"end","topic":"exhaustFanCalibration.maxOffset","topicType":"str","min":"2","max":"31","step":1,"x":530,"y":460,"wires":[["84cc42f5.c1bcd"]]},{"id":"9266db2e.6676d8","type":"ui_slider","z":"6bb640c6.525a5","name":"Exhaust Fan %","label":"","tooltip":"","group":"4975dc2d.9c4134","order":2,"width":3,"height":1,"passthru":false,"outs":"end","topic":"exhaustFanPercent","topicType":"str","min":0,"max":"100","step":1,"x":520,"y":940,"wires":[["84cc42f5.c1bcd"]]},{"id":"510be7c0.5a9448","type":"ui_slider","z":"6bb640c6.525a5","name":"","label":"Intake Fan Min Offset","tooltip":"","group":"a2345340.dcf1","order":11,"width":0,"height":0,"passthru":false,"outs":"end","topic":"intakeFanCalibration.minOffset","topicType":"str","min":"1","max":"30","step":1,"x":520,"y":600,"wires":[["84cc42f5.c1bcd"]]},{"id":"57789328.d4239c","type":"ui_slider","z":"6bb640c6.525a5","name":"","label":"Intake Fan Max Offset","tooltip":"","group":"a2345340.dcf1","order":12,"width":0,"height":0,"passthru":false,"outs":"end","topic":"intakeFanCalibration.maxOffset","topicType":"str","min":"2","max":"31","step":1,"x":520,"y":660,"wires":[["84cc42f5.c1bcd"]]},{"id":"94d55525.b76fd8","type":"ui_slider","z":"6bb640c6.525a5","name":"Intake Fan %","label":"","tooltip":"","group":"4975dc2d.9c4134","order":4,"width":3,"height":1,"passthru":false,"outs":"end","topic":"intakeFanPercent","topicType":"str","min":0,"max":"100","step":1,"x":510,"y":1060,"wires":[["84cc42f5.c1bcd"]]},{"id":"fd891e7c.4be9e","type":"ui_numeric","z":"6bb640c6.525a5","name":"","label":"Exhaust Fan Spin Up Sec","tooltip":"","group":"a2345340.dcf1","order":10,"width":0,"height":0,"wrap":false,"passthru":false,"topic":"exhaustFanCalibration.spinUpSec","topicType":"str","format":"{{value}}","min":0,"max":10,"step":1,"x":530,"y":540,"wires":[["84cc42f5.c1bcd"]]},{"id":"ef96f50d.a57e88","type":"ui_numeric","z":"6bb640c6.525a5","name":"","label":"Intake Fan Spin Up Sec","tooltip":"","group":"a2345340.dcf1","order":13,"width":0,"height":0,"wrap":false,"passthru":false,"topic":"intakeFanCalibration.spinUpSec","topicType":"str","format":"{{value}}","min":0,"max":10,"step":1,"x":530,"y":780,"wires":[["84cc42f5.c1bcd"]]},{"id":"7abf1ed1.c73a","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"exhaustFanCalibration.minOffset","x":250,"y":400,"wires":[["18221c7f.e37354"]]},{"id":"2eba2177.f8461e","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"exhaustFanCalibration.maxOffset","x":250,"y":460,"wires":[["1cb8abc4.7b6104"]]},{"id":"260006e4.e4268a","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"exhaustFanPercent","x":270,"y":940,"wires":[["9266db2e.6676d8"]]},{"id":"c7de419f.00e67","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"intakeFanCalibration.minOffset","x":250,"y":600,"wires":[["510be7c0.5a9448"]]},{"id":"26efa78f.3c30a8","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"intakeFanCalibration.maxOffset","x":250,"y":660,"wires":[["57789328.d4239c"]]},{"id":"dbcf7076.21fe7","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"intakeFanPercent","x":270,"y":1060,"wires":[["94d55525.b76fd8"]]},{"id":"9ce5e6c3.edb948","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"exhaustFanCalibration.spinUpSec","x":250,"y":540,"wires":[["fd891e7c.4be9e"]]},{"id":"9ec7a1b4.3b61c","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"intakeFanCalibration.spinUpSec","x":250,"y":780,"wires":[["ef96f50d.a57e88"]]},{"id":"768fb8e9.e56d98","type":"ui_switch","z":"6bb640c6.525a5","name":"","label":"Exhaust Fan","tooltip":"","group":"4975dc2d.9c4134","order":1,"width":3,"height":1,"passthru":false,"decouple":"true","topic":"exhaustFanOn","topicType":"str","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":510,"y":880,"wires":[["84cc42f5.c1bcd"]]},{"id":"b9ed68a3.901e18","type":"ui_switch","z":"6bb640c6.525a5","name":"","label":"Intake Fan","tooltip":"","group":"4975dc2d.9c4134","order":3,"width":3,"height":1,"passthru":false,"decouple":"true","topic":"intakeFanOn","topicType":"str","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":510,"y":1000,"wires":[["84cc42f5.c1bcd"]]},{"id":"6a9e8e37.dcc63","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"exhaustFanOn","x":270,"y":880,"wires":[["768fb8e9.e56d98"]]},{"id":"ecef3886.8a5278","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"intakeFanOn","x":270,"y":1000,"wires":[["b9ed68a3.901e18"]]},{"id":"d67faca0.46327","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"lightsSchedule.status","x":270,"y":1120,"wires":[["59e0eba2.8224b4"]]},{"id":"9d6388e1.5a1068","type":"ui_button","z":"6bb640c6.525a5","name":"","group":"63d090d9.23eae","order":2,"width":0,"height":0,"passthru":false,"label":"Start pH Calibration","tooltip":"","color":"","bgcolor":"","icon":"","payload":"32","payloadType":"num","topic":"topic","topicType":"msg","x":1250,"y":1020,"wires":[["c91b428a.233dd"]]},{"id":"c1c2b0f8.c9226","type":"function","z":"6bb640c6.525a5","name":"pH Calibration Button States","func":"let startCalibBtn = false;\nlet calibMidBtn = false;\nlet calibLowBtn = false;\nlet calibHighBtn = false;\nlet stopCalibBtn = false;\n\nswitch (msg.payload.current_mode) {\n    case 0x0:\n        //normal mode, not calibrating anything\n        startCalibBtn = true;\n        break;\n    case 0x20:\n        calibMidBtn = true;\n        stopCalibBtn = true;\n        break;\n    case 0x21:\n        calibLowBtn = true;\n        stopCalibBtn = true;\n        break;\n    case 0x22:\n        calibHighBtn = true;\n        stopCalibBtn = true;\n        break;\n}\nreturn [ {enabled: startCalibBtn},\n         {enabled: calibMidBtn},\n         {enabled: calibLowBtn},\n         {enabled: calibHighBtn},\n         {enabled: stopCalibBtn}\n         ];\n","outputs":5,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":1160,"wires":[["9d6388e1.5a1068"],["f012898e.06d5a8"],["c27adb80.da46a8"],["5b9dc6d4.8f7de8"],["f22633ee.6482f"]]},{"id":"c4cfd531.18b6b8","type":"ui_text","z":"6bb640c6.525a5","group":"63d090d9.23eae","order":1,"width":0,"height":0,"name":"","label":"pH Reading","format":"{{msg.payload.data.waterData.ph}}","layout":"row-spread","x":1230,"y":980,"wires":[]},{"id":"f22633ee.6482f","type":"ui_button","z":"6bb640c6.525a5","name":"","group":"63d090d9.23eae","order":6,"width":0,"height":0,"passthru":false,"label":"Cancel pH Calibration","tooltip":"","color":"","bgcolor":"","icon":"","payload":"0","payloadType":"num","topic":"topic","topicType":"msg","x":1260,"y":1260,"wires":[["c91b428a.233dd"]]},{"id":"f012898e.06d5a8","type":"ui_button","z":"6bb640c6.525a5","name":"","group":"63d090d9.23eae","order":3,"width":0,"height":0,"passthru":false,"label":"Set pH MID Calibration Point","tooltip":"","color":"","bgcolor":"","icon":"","payload":"33","payloadType":"num","topic":"topic","topicType":"msg","x":1280,"y":1080,"wires":[["c91b428a.233dd"]]},{"id":"c27adb80.da46a8","type":"ui_button","z":"6bb640c6.525a5","name":"","group":"63d090d9.23eae","order":4,"width":0,"height":0,"passthru":false,"label":"Set pH LOW Calibration Point","tooltip":"","color":"","bgcolor":"","icon":"","payload":"34","payloadType":"num","topic":"topic","topicType":"msg","x":1290,"y":1140,"wires":[["c91b428a.233dd"]]},{"id":"5b9dc6d4.8f7de8","type":"ui_button","z":"6bb640c6.525a5","name":"","group":"63d090d9.23eae","order":5,"width":0,"height":0,"passthru":false,"label":"Set ph HIGH Calibration Point","tooltip":"","color":"","bgcolor":"","icon":"","payload":"35","payloadType":"num","topic":"topic","topicType":"msg","x":1290,"y":1200,"wires":[["c91b428a.233dd"]]},{"id":"676429fd.9f8c68","type":"ui_button","z":"6bb640c6.525a5","name":"","group":"8822534f.5b11a","order":2,"width":0,"height":0,"passthru":false,"label":"Start EC Calibration","tooltip":"","color":"","bgcolor":"","icon":"","payload":"48","payloadType":"num","topic":"topic","topicType":"msg","x":1240,"y":1400,"wires":[["c91b428a.233dd"]]},{"id":"b7c55316.c17f6","type":"function","z":"6bb640c6.525a5","name":"EC Calibration Button States","func":"let startCalibBtn = false;\nlet calibDryBtn = false;\nlet calibLowBtn = false;\nlet calibHighBtn = false;\nlet stopCalibBtn = false;\n\nswitch (msg.payload.current_mode) {\n    case 0x0:\n        //normal mode, not calibrating anything\n        startCalibBtn = true;\n        break;\n    case 0x30:\n        calibDryBtn = true;\n        stopCalibBtn = true;\n        break;\n    case 0x31:\n        calibLowBtn = true;\n        stopCalibBtn = true;\n        break;\n    case 0x32:\n        calibHighBtn = true;\n        stopCalibBtn = true;\n        break;\n}\nreturn [ {enabled: startCalibBtn},\n         {enabled: calibDryBtn},\n         {enabled: calibLowBtn},\n         {enabled: calibHighBtn},\n         {enabled: stopCalibBtn}\n         ];\n","outputs":5,"noerr":0,"initialize":"","finalize":"","libs":[],"x":900,"y":1460,"wires":[["676429fd.9f8c68"],["503e7d0d.ccc5f4"],["85c40d69.999b5"],["97d95884.aeab18"],["6175c764.483618"]]},{"id":"6175c764.483618","type":"ui_button","z":"6bb640c6.525a5","name":"","group":"8822534f.5b11a","order":6,"width":0,"height":0,"passthru":false,"label":"Cancel EC Calibration","tooltip":"","color":"","bgcolor":"","icon":"","payload":"0","payloadType":"num","topic":"topic","topicType":"msg","x":1240,"y":1640,"wires":[["c91b428a.233dd"]]},{"id":"503e7d0d.ccc5f4","type":"ui_button","z":"6bb640c6.525a5","name":"","group":"8822534f.5b11a","order":3,"width":0,"height":0,"passthru":false,"label":"Set DRY EC Calibration Point","tooltip":"","color":"","bgcolor":"","icon":"","payload":"49","payloadType":"num","topic":"topic","topicType":"msg","x":1270,"y":1460,"wires":[["c91b428a.233dd"]]},{"id":"85c40d69.999b5","type":"ui_button","z":"6bb640c6.525a5","name":"","group":"8822534f.5b11a","order":4,"width":0,"height":0,"passthru":false,"label":"Set LOW EC Calibration Point","tooltip":"","color":"","bgcolor":"","icon":"","payload":"50","payloadType":"num","topic":"topic","topicType":"msg","x":1270,"y":1520,"wires":[["c91b428a.233dd"]]},{"id":"97d95884.aeab18","type":"ui_button","z":"6bb640c6.525a5","name":"","group":"8822534f.5b11a","order":5,"width":0,"height":0,"passthru":false,"label":"Set HIGH EC Calibration Point","tooltip":"","color":"","bgcolor":"","icon":"","payload":"51","payloadType":"num","topic":"topic","topicType":"msg","x":1270,"y":1580,"wires":[["c91b428a.233dd"]]},{"id":"fc42ebdc.c32b48","type":"ui_text","z":"6bb640c6.525a5","group":"8822534f.5b11a","order":1,"width":0,"height":0,"name":"","label":"TDS Reading","format":"{{msg.payload.data.waterData.tds}}","layout":"row-spread","x":1240,"y":1340,"wires":[]},{"id":"5e441bef.227d94","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"waterChillerThermostat.mode","x":270,"y":1400,"wires":[["91ea6d4c.69d0c"]]},{"id":"87d3a07.f742c6","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"waterChillerThermostat.minValue","x":270,"y":1460,"wires":[["75623fb2.4fc75"]]},{"id":"3c6a90d5.6ac9b","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"waterChillerThermostat.maxValue","x":270,"y":1520,"wires":[["8b0d46df.7fbfa8"]]},{"id":"91ea6d4c.69d0c","type":"ui_dropdown","z":"6bb640c6.525a5","name":"Chiller Thermostat","label":"Chiller Thermostat Mode","tooltip":"","place":"Chiller Thermostat Mode","group":"a2345340.dcf1","order":14,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"Off","value":"0","type":"str"},{"label":"Force On","value":"1","type":"str"},{"label":"Thermostat","value":"2","type":"str"}],"payload":"","topic":"waterChillerThermostat.mode","topicType":"str","x":510,"y":1400,"wires":[["84cc42f5.c1bcd"]]},{"id":"75623fb2.4fc75","type":"ui_numeric","z":"6bb640c6.525a5","name":"Chiller Thermostat Min","label":"Chiller Thermostat Min","tooltip":"","group":"a2345340.dcf1","order":16,"width":0,"height":0,"wrap":false,"passthru":false,"topic":"waterChillerThermostat.minValue","topicType":"str","format":"{{value}}","min":0,"max":"30","step":"0.25","x":520,"y":1460,"wires":[["84cc42f5.c1bcd"]]},{"id":"8b0d46df.7fbfa8","type":"ui_numeric","z":"6bb640c6.525a5","name":"Chiller Thermostat Max","label":"Chiller Thermostat Max","tooltip":"","group":"a2345340.dcf1","order":15,"width":0,"height":0,"wrap":false,"passthru":false,"topic":"waterChillerThermostat.maxValue","topicType":"str","format":"{{value}}","min":0,"max":"30","step":"0.25","x":530,"y":1520,"wires":[["84cc42f5.c1bcd"]]},{"id":"84cc42f5.c1bcd","type":"subflow:fb6e1899.829f18","z":"6bb640c6.525a5","name":"","env":[],"x":1190,"y":480,"wires":[]},{"id":"d3e4d3b8.77bbd","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"samplingIntervalMS","x":250,"y":300,"wires":[["bfa9a15b.8dc05"]]},{"id":"c1ebcf2d.c4ffb","type":"function","z":"6bb640c6.525a5","name":"Update config global","func":"if (msg.payload && msg.payload.config) {\n    global.set(\"latest_config\", msg.payload.config);\n    msg.payload = global.get(\"latest_config\");\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":260,"y":240,"wires":[["d3e4d3b8.77bbd","7abf1ed1.c73a","2eba2177.f8461e","260006e4.e4268a","c7de419f.00e67","26efa78f.3c30a8","dbcf7076.21fe7","9ce5e6c3.edb948","9ec7a1b4.3b61c","6a9e8e37.dcc63","ecef3886.8a5278","d67faca0.46327","5e441bef.227d94","87d3a07.f742c6","3c6a90d5.6ac9b","63f82fec.16bf9","83604f4.9366cb","6d97a53f.bce11c","72e6d3bb.b2b44c","4e285aa3.641ea4","cbcdde49.3ce6a","8ce14781.6e6e78"]]},{"id":"bfa9a15b.8dc05","type":"function","z":"6bb640c6.525a5","name":"ms to s","func":"msg.payload = Math.floor(msg.payload/1000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":280,"wires":[["c209008e.7439c"]]},{"id":"92821c48.0c0d5","type":"subflow:2c950cc0.f5b4d4","z":"38def9ff.21aea6","name":"","x":140,"y":220,"wires":[["b9e9913b.47eae","16fea1c4.41d3ee","bcaab1eb.be397","461d6e7e.7388"]]},{"id":"acac5621.ff9388","type":"function","z":"68dd499a.a366c8","name":"Set values for switches","func":"'config_exhaustFanPercent',\n            'config_intakeFanPercent',\n            'config_exhaustFanOn',\n            'config_intakeFanOn'\nvar exOn = msg.payload.config_exhaustFanOn;\nvar expct = msg.payload.config_exhaustFanPercent;\nvar inOn = msg.payload.config_intakeFanOn;\nvar inpct = msg.payload.config_intakeFanPercent;\n\nif (!exOn.length) {\n    return msg;\n}\nvar idx = 0;\nfor (let d of expct) {\n    if (idx < exOn.length - 1 && exOn[idx + 1].x <= d.x ) {\n        idx++;\n    }\n    d.y = (exOn[0].y > 0)?d.y:0;\n}\nidx = 0;\nfor (let d of inpct) {\n    if (idx < inOn.length - 1 && inOn[idx + 1].x <= d.x ) {\n        idx++;\n    }\n    d.y = (inOn[0].y > 0)?d.y:0;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":440,"wires":[["ab9baf7a.e392d"]]},{"id":"4371fd42.f6b154","type":"change","z":"68dd499a.a366c8","name":"","rules":[{"t":"set","p":"show_lux","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":1400,"wires":[[]]},{"id":"d648c47c.e57618","type":"ui_switch","z":"68dd499a.a366c8","name":"","label":"Lux","tooltip":"","group":"ab3ec0cf.5f1fc","order":11,"width":4,"height":1,"passthru":false,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":130,"y":1400,"wires":[["4371fd42.f6b154"]]},{"id":"80b1802b.9135f","type":"change","z":"68dd499a.a366c8","name":"","rules":[{"t":"set","p":"show_intake_fan","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":1460,"wires":[[]]},{"id":"d232f109.c5091","type":"ui_switch","z":"68dd499a.a366c8","name":"","label":"Intake Fan","tooltip":"","group":"ab3ec0cf.5f1fc","order":11,"width":4,"height":1,"passthru":false,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":150,"y":1460,"wires":[["80b1802b.9135f"]]},{"id":"420e3e21.d8bea","type":"change","z":"68dd499a.a366c8","name":"","rules":[{"t":"set","p":"show_exhaust_fan","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":1520,"wires":[[]]},{"id":"12bb7105.fd30cf","type":"ui_switch","z":"68dd499a.a366c8","name":"","label":"Exhaust Fan","tooltip":"","group":"ab3ec0cf.5f1fc","order":11,"width":4,"height":1,"passthru":false,"decouple":"false","topic":"topic","topicType":"msg","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":150,"y":1520,"wires":[["420e3e21.d8bea"]]},{"id":"ba099ffc.910cf","type":"switch","z":"68dd499a.a366c8","name":"Show intake fan","property":"show_intake_fan","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":520,"y":880,"wires":[["43fb15a6.3c224c"]]},{"id":"f7d8993d.84d618","type":"switch","z":"68dd499a.a366c8","name":"Show exhaust fan","property":"show_exhaust_fan","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":530,"y":920,"wires":[["43fb15a6.3c224c"]]},{"id":"5464aa34.16af94","type":"switch","z":"68dd499a.a366c8","name":"Show lux","property":"show_lux","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":500,"y":840,"wires":[["43fb15a6.3c224c"]]},{"id":"c24ee7a0.871c18","type":"debug","z":"68dd499a.a366c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1120,"y":800,"wires":[]},{"id":"293f4bd8.354f14","type":"ui_template","z":"38def9ff.21aea6","group":"b9fab5a.6b0f448","name":"Cam","order":1,"width":6,"height":7,"format":"\n    <div  id=\"camDiv\" style=\"{{eleStyles}}\">\n        <div ng-click=\"toggleZoom()\" ng-if=\"currentPic.url.endsWith('.mp4')\">\n                <video style=\"width:100%;height:100%;\" loop muted autoplay autoplay playsinline>\n                    <source src=\"{{currentPic.url}}\" type=\"video/mp4\">\n                </video>\n        </div>\n        <div ng-if=\"!currentPic.url.endsWith('.mp4')\" ng-click=\"toggleZoom()\" style=\"width:100%;height:calc(100% - 75px);background:url({{currentPic.url}});background-position: center;background-repeat: no-repeat; background-size: contain;\">\n    \n        </div>\n        <a href=\"{{currentPic.url}}\" style=\"display:table;margin: 0 auto;background-color: rgba(255,255,255,.6);\">{{currentPic.title}}</a>\n        <div ng-if=\"playlist\" style=\"display:table;margin: 0 auto;\" id=\"timelapseDiv\">\n            \n            <md-button style=\"display:none\"></md-button>\n            <md-button style=\"background-color: white; margin: 5px 3px 0px 3px\" ng-click=\"goFirst($event)\"> <ui-icon icon=\"skip_previous\"></ui-icon></md-button>\n            <md-button style=\"background-color: white; margin: 5px 3px 0px 3px\" ng-disabled=\"frameIndex=0\" ng-click=\"prev($event)\"> <ui-icon icon=\"keyboard_arrow_left\"></ui-icon></md-button>\n            <md-button style=\"background-color: white; margin: 5px 3px 0px 3px\" ng-if=\"!playing\" ng-click=\"play($event)\"> <ui-icon icon=\"play_arrow\"></ui-icon></md-button>\n            <md-button style=\"background-color: white; margin: 5px 3px 0px 3px\" ng-if=\"playing\" ng-click=\"pause($event)\"> <ui-icon icon=\"pause\"></ui-icon></md-button>\n            <md-button style=\"background-color: white; margin: 5px 3px 0px 3px\" ng-disabled=\"frameIndex==playlist.length-1\" ng-click=\"next($event)\"> <ui-icon icon=\"keyboard_arrow_right\"></ui-icon></md-button>\n            <md-button style=\"background-color: white; margin: 5px 3px 0px 3px\" ng-click=\"goLast($event)\"> <ui-icon icon=\"skip_next\"></ui-icon></md-button>\n            \n        \n        </div>\n        \n    </div>\n\n\n<script>\n\n    \n    (function(scope) {\n        const ele = document.getElementById('camDiv');\n        scope.frameDelay = 1000;\n        scope.playing = false;\n        scope.timeoutHandle = null;\n        scope.frameIndex = 0;\n        const baseEleStyles = \"width:100%;height:100%;\"\n        const fullscreenEleStyles = \"top: 0;left:0;bottom:0;right:0;z-index:2000;position:fixed;background-color: rgba(0,0,0,.5);\"\n        scope.eleStyles = baseEleStyles;\n        scope.toggleZoom = function() {\n            console.log(ele);\n            if (ele.style.position == \"fixed\") {\n                console.log(\"putting back\");\n                scope.eleStyles = baseEleStyles;\n            } else {\n                console.log(\"full screening\");\n                scope.eleStyles = baseEleStyles + fullscreenEleStyles;\n            }\n        }\n        \n        scope.startTimeout = function() {\n            scope.timeoutHandle = setTimeout(() => {\n                if (!scope.playing || !scope.playlist) {\n                    return;\n                }\n                scope.frameIndex++;\n                if (scope.frameIndex >= scope.playlist.length) {\n                    scope.frameIndex = 0\n                }\n                var bgImg = new Image();\n                bgImg.onload = function(){\n                    scope.currentPic = scope.playlist[scope.frameIndex];\n                    console.log(\"load finished starting timeout\");\n                    scope.$apply();\n                    scope.startTimeout();   \n                };\n                console.log(\"starting load\");\n                bgImg.src = scope.playlist[scope.frameIndex].url;\n                \n            }, scope.frameDelay);\n        }\n        scope.play = function(event) {\n            event.stopPropagation();\n            console.log(\"do play?\");\n            scope.playing = true;\n            if (scope.frameIndex == scope.playlist.length-1) {\n                scope.frameIndex = 0;\n            }\n            scope.startTimeout();\n        }\n        scope.goFirst = function(event) {\n         event.preventDefault();\n         scope.frameIndex = 0;\n         scope.currentPic = scope.playlist[scope.frameIndex];\n        }\n        scope.goLast = function(event) {\n         event.preventDefault();\n         scope.frameIndex = scope.playlist.length - 1;\n         scope.currentPic = scope.playlist[scope.frameIndex];\n        }\n        scope.pause = function(event) {\n            event.stopPropagation();\n            scope.playing = false;\n            if (scope.timeoutHandle) {\n                clearTimeout(scope.timeoutHandle);\n                scope.timeoutHandle = null;\n            }\n        }\n        scope.next = function(event) {\n            event.stopPropagation();\n            scope.frameIndex++;\n            if (scope.frameIndex >= scope.playlist.length) {\n                scope.frameIndex--;\n                return;\n            }\n            scope.currentPic = scope.playlist[scope.frameIndex];\n        }\n        scope.prev = function(event) {\n            event.stopPropagation();\n            scope.frameIndex--;\n            if (scope.frameIndex < 0) {\n                scope.frameIndex++;\n                return;\n            }\n            scope.currentPic = scope.playlist[scope.frameIndex];\n        }\n        console.log(\"camEle: \" + scope.camEle);\n        \n        scope.currentPic = { url: \"/spinner.gif\", title: \"No image\" };\n        scope.$watch('msg.data', function(data) {\n            console.log(JSON.stringify(data));\n            if (Array.isArray(data)) {\n                console.log(\"it is array\");\n                scope.playlist = data;\n                scope.currentPic = data[0];\n            } else {\n                console.log('it is not array');\n                scope.currentPic = data;\n                scope.playlist = null;\n            }\n        });\n    })(scope);\n    \n    \n    if (data.startsWith(\"[\")) {\n        \n    } else {\n        ele.style.background = `url(/${data}) no-repeat contain`;\n    }\n</script>\n\n","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":1390,"y":340,"wires":[[]]},{"id":"59e0eba2.8224b4","type":"ui_dropdown","z":"6bb640c6.525a5","name":"Lights Mode","label":"Lights Mode","tooltip":"","place":"Select option","group":"4975dc2d.9c4134","order":8,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"Schedule","value":0,"type":"num"},{"label":"On","value":1,"type":"num"},{"label":"Off","value":2,"type":"num"}],"payload":"","topic":"lightsSchedule.status","topicType":"str","x":490,"y":1120,"wires":[["84cc42f5.c1bcd"]]},{"id":"63f82fec.16bf9","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"lightsSchedule.turnOnGmtHourMin","x":270,"y":1160,"wires":[["ed03e955.1da0b8"]]},{"id":"83604f4.9366cb","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"lightsSchedule.turnOffGmtHourMin","x":270,"y":1200,"wires":[["d0ac8768.cea138"]]},{"id":"ed03e955.1da0b8","type":"ui_numeric","z":"6bb640c6.525a5","name":"Lights Turn On Time","label":"Lights Turn On Time","tooltip":"","group":"a2345340.dcf1","order":3,"width":0,"height":0,"wrap":false,"passthru":false,"topic":"lightsSchedule.turnOnGmtHourMin","topicType":"str","format":"{{value}}","min":0,"max":"2300","step":"10","x":520,"y":1160,"wires":[["84cc42f5.c1bcd"]]},{"id":"d0ac8768.cea138","type":"ui_numeric","z":"6bb640c6.525a5","name":"Lights Turn Off Time","label":"Lights Turn Off Time","tooltip":"","group":"a2345340.dcf1","order":4,"width":0,"height":0,"wrap":false,"passthru":false,"topic":"lightsSchedule.turnOffGmtHourMin","topicType":"str","format":"{{value}}","min":0,"max":"2300","step":"10","x":520,"y":1200,"wires":[["84cc42f5.c1bcd"]]},{"id":"6d97a53f.bce11c","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"roomFanSchedule.status","x":270,"y":1260,"wires":[["8149a97b.8d3278"]]},{"id":"72e6d3bb.b2b44c","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"roomFanSchedule.turnOnGmtHourMin","x":270,"y":1300,"wires":[["92bdaebc.25b83"]]},{"id":"4e285aa3.641ea4","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"roomFanSchedule.turnOffGmtHourMin","x":270,"y":1340,"wires":[["46ef38aa.ef7e28"]]},{"id":"8149a97b.8d3278","type":"ui_dropdown","z":"6bb640c6.525a5","name":"Room Fans Mode","label":"Room Fans Mode","tooltip":"","place":"Select option","group":"4975dc2d.9c4134","order":9,"width":0,"height":0,"passthru":false,"multiple":false,"options":[{"label":"Schedule","value":0,"type":"num"},{"label":"On","value":1,"type":"num"},{"label":"Off","value":2,"type":"num"}],"payload":"","topic":"roomFanSchedule.status","topicType":"str","x":510,"y":1260,"wires":[["84cc42f5.c1bcd"]]},{"id":"92bdaebc.25b83","type":"ui_numeric","z":"6bb640c6.525a5","name":"Room Fans Turn On Time","label":"Room Fans Turn On Time","tooltip":"","group":"a2345340.dcf1","order":6,"width":0,"height":0,"wrap":false,"passthru":false,"topic":"roomFanSchedule.turnOnGmtHourMin","topicType":"str","format":"{{value}}","min":0,"max":"2300","step":"100","x":530,"y":1300,"wires":[["84cc42f5.c1bcd"]]},{"id":"46ef38aa.ef7e28","type":"ui_numeric","z":"6bb640c6.525a5","name":"Room Fans Turn Off Time","label":"Room Fans Turn Off Time","tooltip":"","group":"a2345340.dcf1","order":7,"width":0,"height":0,"wrap":false,"passthru":false,"topic":"roomFanSchedule.turnOffGmtHourMin","topicType":"str","format":"{{value}}","min":0,"max":"2300","step":"100","x":530,"y":1340,"wires":[["84cc42f5.c1bcd"]]},{"id":"2ddfd455.7f7dcc","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":28,"width":3,"height":1,"name":"","label":"Lights","format":"{{msg.payload.data.lightsOn?\"ON\":\"OFF\"}}","layout":"col-center","x":410,"y":540,"wires":[]},{"id":"9534ec93.e7856","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":24,"width":3,"height":1,"name":"","label":"Room Fan","format":"{{msg.payload.data.roomFanOn?\"ON\":\"OFF\"}}","layout":"col-center","x":430,"y":580,"wires":[]},{"id":"cbcdde49.3ce6a","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"pumpOn","x":270,"y":1580,"wires":[["fb00ae58.6f2c6"]]},{"id":"fb00ae58.6f2c6","type":"ui_switch","z":"6bb640c6.525a5","name":"","label":"Water Pump","tooltip":"","group":"4975dc2d.9c4134","order":5,"width":3,"height":1,"passthru":false,"decouple":"true","topic":"pumpOn","topicType":"str","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":490,"y":1580,"wires":[["84cc42f5.c1bcd"]]},{"id":"5cd5959f.c7cacc","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":23,"width":3,"height":1,"name":"","label":"Water Pump","format":"{{msg.payload.data.pumpOn?\"ON\":(msg.payload.data.pumpEmergencyShutoff?\"EMERGENCY SHUTOFF\":\"OFF\")}}","layout":"col-center","x":590,"y":580,"wires":[]},{"id":"1216a120.10325f","type":"inject","z":"38def9ff.21aea6","name":"Trigger Auto Pic AM","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"10 08 * * *","once":false,"onceDelay":"60","topic":"","payload":"auto","payloadType":"str","x":1020,"y":80,"wires":[["98815826.dfc3c8"]]},{"id":"d6ee44c.8f1a7b8","type":"inject","z":"38def9ff.21aea6","name":"Trigger Auto Pic PM","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"50 19 * * *","once":false,"onceDelay":"60","topic":"","payload":"auto","payloadType":"str","x":1020,"y":160,"wires":[["98815826.dfc3c8"]]},{"id":"98815826.dfc3c8","type":"function","z":"38def9ff.21aea6","name":"Capture Picture","func":"\nconst fname = `${msg.payload}_${JSON.stringify(new Date()).replace(/\\\"/g, '').replace(/\\:/g, \"-\").replace(/T/g, '_').replace(/Z/g, '').split('.')[0]}.png`;\nmsg.data = {url:'/'+ fname, title: (new Date()).toLocaleString()};\nmsg.payload = '/home/pi/phogrows/' + fname;\n\n\nreturn [msg, {data: {url: '/spinner.gif', title: \"No Image\"}}];","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1150,"y":260,"wires":[["fde9f3f8.ccabf"],["293f4bd8.354f14"]]},{"id":"4cf0d702.599778","type":"ui_button","z":"38def9ff.21aea6","name":"","group":"b9fab5a.6b0f448","order":4,"width":2,"height":1,"passthru":false,"label":"Capture Pic","tooltip":"","color":"","bgcolor":"","icon":"","payload":"cap","payloadType":"str","topic":"topic","topicType":"msg","x":900,"y":280,"wires":[["98815826.dfc3c8"]]},{"id":"fde9f3f8.ccabf","type":"exec","z":"38def9ff.21aea6","command":"fswebcam -d /dev/video2 --skip 30 -r 3840x2160 --text-colour \"#FF00FF00\" --line-colour \"#00000000\" --banner-colour \"#00000000\" --bottom-banner --png 5 --save ","addpay":"payload","append":"","useSpawn":"false","timer":"","oldrc":false,"name":"capture pic","x":1210,"y":460,"wires":[["293f4bd8.354f14","54d553d4.a2d68c"],["da281f87.7eeee"],[]]},{"id":"da281f87.7eeee","type":"debug","z":"38def9ff.21aea6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1260,"y":620,"wires":[]},{"id":"df5c6777.d01178","type":"ui_button","z":"38def9ff.21aea6","name":"","group":"b9fab5a.6b0f448","order":2,"width":2,"height":1,"passthru":false,"label":"All Pics","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":910,"y":340,"wires":[["a90696f3.1487f8"]]},{"id":"a90696f3.1487f8","type":"function","z":"38def9ff.21aea6","name":"","func":"var fs = global.get('fs')\nvar path = global.get('path')\nconst dir ='/home/pi/phogrows';  \nconst prefix = null;\nfs.readdir(dir, (err, files) => {\n    const dataArr = []\n    if (!err) {\n        for (let f of files) {\n            const spl = f.split(\".\")[0].split(/_/g);\n            if (spl.length == 3) {\n                if (!prefix || prefix == spl[0]) {\n                    const dt = new Date(`${spl[1]}T${spl[2].replace(/-/g, ':')}Z`);\n                    dataArr.push({url: `/${f}`, title: dt.toLocaleString(), stamp: dt.getTime()});\n                }\n            }\n        }\n    }\n    dataArr.sort((a, b) => a.stamp - b.stamp);\n    node.send({data: dataArr});        \n    \n});\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1090,"y":360,"wires":[["293f4bd8.354f14","5e0eb687.16ddc8"]]},{"id":"5e0eb687.16ddc8","type":"debug","z":"38def9ff.21aea6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"data","targetType":"msg","statusVal":"","statusType":"auto","x":1060,"y":560,"wires":[]},{"id":"6e9b0626.4b1b98","type":"inject","z":"38def9ff.21aea6","name":"Trigger Auto Pic Midday","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"20 13 * * *","once":false,"onceDelay":"60","topic":"","payload":"auto","payloadType":"str","x":1030,"y":120,"wires":[["98815826.dfc3c8"]]},{"id":"181f5e02.40d542","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":11,"width":6,"height":1,"name":"","label":"Operation","format":"{{msg.payload.status.currentOp.type}}","layout":"row-spread","x":1880,"y":40,"wires":[]},{"id":"c7881248.6e881","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":12,"width":6,"height":1,"name":"","label":"Operation Status","format":"{{msg.payload.status.currentOp.status}}","layout":"row-spread","x":1910,"y":80,"wires":[]},{"id":"e47d7482.6d1888","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":13,"width":6,"height":1,"name":"","label":"Operation Delta Gals","format":"{{msg.payload.status.currentOp.gallonsDelta }}","layout":"row-spread","x":1920,"y":120,"wires":[]},{"id":"f37a0f8.185a1f","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"79e4a25c.bb49dc","order":18,"width":6,"height":1,"passthru":false,"label":"Fill To","tooltip":"","color":"","bgcolor":"","icon":"","payload":"{\"cmd\":\"startop\",\"op\":\"FillToPercent\",\"value\":8}","payloadType":"json","topic":"topic","topicType":"msg","x":1830,"y":440,"wires":[["e8ff15cd.b82188"]]},{"id":"7c9755af.51e40c","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"79e4a25c.bb49dc","order":20,"width":6,"height":1,"passthru":false,"label":"Drain to","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"num","topic":"topic","topicType":"msg","x":1840,"y":360,"wires":[["c2192b75.1c7588"]]},{"id":"f1a3cdda.8931f","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"79e4a25c.bb49dc","order":17,"width":12,"height":1,"passthru":false,"label":"Abort Op","tooltip":"","color":"","bgcolor":"","icon":"","payload":"{\"msgType\":\"FlowAbortOpMsg\"}","payloadType":"json","topic":"topic","topicType":"msg","x":1840,"y":640,"wires":[["e96f2915.e1a068"]]},{"id":"2e26c3d5.d30bfc","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":1,"width":3,"height":1,"name":"","label":"Gallons In","format":"{{ msg.payload.status.gallonsIn }}","layout":"col-center","x":1660,"y":400,"wires":[]},{"id":"180386ba.ef8ed9","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":2,"width":3,"height":1,"name":"","label":"Gallons Out","format":"{{ msg.payload.status.gallonsOut }}","layout":"col-center","x":1650,"y":440,"wires":[]},{"id":"79888615.2aa488","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":7,"width":3,"height":1,"name":"","label":"In Valve Open","format":"{{msg.payload.status.inValveOpen}}","layout":"col-center","x":1660,"y":480,"wires":[]},{"id":"bd38b2ae.0409b","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":8,"width":3,"height":1,"name":"","label":"Out Valve Open","format":"{{msg.payload.status.outValveOpen}}","layout":"col-center","x":1660,"y":340,"wires":[]},{"id":"45626b2e.271004","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":3,"width":3,"height":1,"name":"","label":"Water Level","format":"{{msg.payload.status.waterLevel }} %","layout":"col-center","x":1650,"y":520,"wires":[]},{"id":"a298b0ea.8edab","type":"function","z":"638a1ba8.eab274","name":"Handle Flow Msg","func":"\nif (msg.payload.msgType == \"GbResultMsg\" && flow.get(\"flowLastMsgId\") == msg.payload.replyTo) {\n    return [null, msg, null, null, null];\n} else if (msg.payload.msgType == \"FlowStatusMsg\") {\n    return [msg, null, null, null, null];\n} else if (msg.payload.msgType == \"FlowOpStartedMsg\") {\n    return [null, null, msg, null, null];\n} else if (msg.payload.msgType == \"FlowOpEndedMsg\") {\n    return [null, null, null, msg, null];\n} \n","outputs":5,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1330,"y":100,"wires":[["181f5e02.40d542","c7881248.6e881","79888615.2aa488","bd38b2ae.0409b","e3a34517.f577b8","b7df9dbc.c20e1","82b122f2.04701"],["5263476e.99ad58","f8e86409.c9be58","b2b167cd.916118","b7df9dbc.c20e1"],["181f5e02.40d542","c7881248.6e881","b2b167cd.916118","b7df9dbc.c20e1","d9cd14d0.a8d338"],["181f5e02.40d542","c7881248.6e881","d9cd14d0.a8d338"],[]]},{"id":"5263476e.99ad58","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":9,"width":6,"height":1,"name":"","label":"Last Command Success","format":"{{msg.payload.success}}","layout":"row-spread","x":1950,"y":220,"wires":[]},{"id":"f8e86409.c9be58","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":10,"width":6,"height":1,"name":"","label":"Last Command Error","format":"{{msg.payload.error}}","layout":"row-spread","x":1940,"y":260,"wires":[]},{"id":"a3cd56ee.75db98","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"79e4a25c.bb49dc","order":25,"width":6,"height":1,"passthru":false,"label":"Flush","tooltip":"","color":"","bgcolor":"","icon":"","payload":"{\"msgType\":\"FlowStartOpMsg\",\"op\":\"Flush\"}","payloadType":"json","topic":"topic","topicType":"msg","x":1830,"y":600,"wires":[["e96f2915.e1a068"]]},{"id":"46be4d83.979644","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"79e4a25c.bb49dc","order":22,"width":6,"height":1,"passthru":false,"label":"Empty Reservoir","tooltip":"","color":"","bgcolor":"","icon":"","payload":"{\"msgType\":\"FlowStartOpMsg\",\"op\":\"Empty\"}","payloadType":"json","topic":"topic","topicType":"msg","x":1860,"y":560,"wires":[["e96f2915.e1a068"]]},{"id":"5053363.05caec8","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"79e4a25c.bb49dc","order":5,"width":3,"height":1,"passthru":false,"label":"Reset Gallons In","tooltip":"","color":"","bgcolor":"","icon":"","payload":"{\"msgType\":\"FlowResetCounterMsg\",\"counterName\":\"litersIn\"}","payloadType":"json","topic":"topic","topicType":"msg","x":1870,"y":480,"wires":[["e96f2915.e1a068"]]},{"id":"8fc28888.ef3798","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"79e4a25c.bb49dc","order":6,"width":3,"height":1,"passthru":false,"label":"Reset Gallons Out","tooltip":"","color":"","bgcolor":"","icon":"","payload":"{\"msgType\":\"FlowResetCounterMsg\",\"counterName\":\"litersOut\"}","payloadType":"json","topic":"topic","topicType":"msg","x":1870,"y":520,"wires":[["e96f2915.e1a068"]]},{"id":"400d3311.1b47ec","type":"ui_numeric","z":"638a1ba8.eab274","name":"Drain %","label":"","tooltip":"","group":"79e4a25c.bb49dc","order":21,"width":6,"height":1,"wrap":true,"passthru":true,"topic":"topic","topicType":"msg","format":"{{value}} %","min":"0","max":"99","step":1,"x":1840,"y":320,"wires":[["615bdd1a.120094"]]},{"id":"6918125c.89c90c","type":"ui_numeric","z":"638a1ba8.eab274","name":"Fill %","label":"","tooltip":"","group":"79e4a25c.bb49dc","order":19,"width":6,"height":1,"wrap":true,"passthru":true,"topic":"topic","topicType":"msg","format":"{{value}} %","min":"1","max":"100","step":1,"x":1830,"y":400,"wires":[["c9270710.4c2008"]]},{"id":"615bdd1a.120094","type":"function","z":"638a1ba8.eab274","name":"","func":"\nflow.set(\"DrainToPercent\", msg.payload)\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2020,"y":320,"wires":[["e96f2915.e1a068"]]},{"id":"c2192b75.1c7588","type":"function","z":"638a1ba8.eab274","name":"","func":"const drainPct = flow.get(\"DrainToPercent\");\nif (drainPct === null || drainPct === undefined) {\n    return null;\n}\nmsg.payload = {msgType:\"FlowStartOpMsg\",op:\"DrainToPercent\",params:[drainPct]};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2020,"y":360,"wires":[["e96f2915.e1a068"]]},{"id":"c9270710.4c2008","type":"function","z":"638a1ba8.eab274","name":"","func":"\nflow.set(\"FillToPercent\", msg.payload)\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1980,"y":400,"wires":[["e96f2915.e1a068"]]},{"id":"e8ff15cd.b82188","type":"function","z":"638a1ba8.eab274","name":"","func":"const pct = flow.get(\"FillToPercent\");\nif (pct === null || pct === undefined) {\n    return null;\n}\nmsg.payload = {msgType:\"FlowStartOpMsg\",op:\"FillToPercent\", params: [pct]};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2020,"y":440,"wires":[["e96f2915.e1a068"]]},{"id":"e3a34517.f577b8","type":"function","z":"638a1ba8.eab274","name":"Round","func":"\nmsg.payload.status.gallonsIn = Math.floor((msg.payload.status.litersIn * .264172)*100)/100;\nmsg.payload.status.gallonsOut = Math.floor((msg.payload.status.litersOut * .264172)*100)/100;\nif (msg.payload.status.currentOp) {\n    msg.payload.status.currentOp.gallonsDelta = Math.floor(((msg.payload.status.currentOp.litersDelta || 0) * .264172)*100)/100;\n}\nmsg.payload.status.waterLevel = Math.floor((msg.payload.status.waterLevel * 100))/100;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1410,"y":260,"wires":[["e47d7482.6d1888","2e26c3d5.d30bfc","180386ba.ef8ed9","45626b2e.271004"]]},{"id":"b2b167cd.916118","type":"function","z":"638a1ba8.eab274","name":"Round","func":"if (!msg.payload.status) {\n    return null;\n}\nmsg.payload.status.gallonsIn = Math.floor((msg.payload.litersIn * .264172)*100)/100;\nmsg.payload.status.gallonsOut = Math.floor((msg.payload.litersOut * .264172)*100)/100;\nif (msg.payload.status.currentOp) {\n    msg.payload.status.currentOp.gallonsDelta = Math.floor(((msg.payload.status.currentOp.litersDelta || 0) * .264172)*100)/100;\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1630,"y":200,"wires":[["e47d7482.6d1888"]]},{"id":"8ce14781.6e6e78","type":"prop-to-topic","z":"6bb640c6.525a5","name":"","prop":"bubblesOn","x":270,"y":1640,"wires":[["722ba024.e1bcc"]]},{"id":"722ba024.e1bcc","type":"ui_switch","z":"6bb640c6.525a5","name":"","label":"Bubbles","tooltip":"","group":"4975dc2d.9c4134","order":6,"width":3,"height":1,"passthru":false,"decouple":"true","topic":"bubblesOn","topicType":"str","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","animate":false,"x":480,"y":1640,"wires":[["84cc42f5.c1bcd"]]},{"id":"24ed378f.0e5908","type":"debug","z":"5189c7b3.782c68","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":500,"y":180,"wires":[]},{"id":"54d553d4.a2d68c","type":"exec","z":"38def9ff.21aea6","command":"/growbot/timelapser/maketimelapse.sh","addpay":"","append":"","useSpawn":"true","timer":"","oldrc":false,"name":"","x":1540,"y":520,"wires":[[],[],[]]},{"id":"c13d5763.2550c8","type":"ui_button","z":"38def9ff.21aea6","name":"","group":"b9fab5a.6b0f448","order":3,"width":2,"height":1,"passthru":false,"label":"Time Lapse","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":850,"y":400,"wires":[["2b607d7.bafe882"]]},{"id":"642bcf72.03349","type":"ui_template","z":"38def9ff.21aea6","group":"60058375.2cde8c","name":"Grafana Charts","order":32,"width":14,"height":12,"format":"<div style=\"width:100%;height:100%;overflow:hidden;\">\n    <ui-icon style=\"cursor: pointer\" id=\"grafanaBack\" icon=\"skip_previous\"></ui-icon>\n    <iframe id=\"grafanaFrame\" scrolling=\"no\" style=\"margin-left:-16px;width:900px;height:100%;border:0\" src=\"/grafana/d/uIVLIHRRk/water-temp?orgId=1&kiosk&refresh=30s\" ></iframe>\n</div>\n<script>\nvar g = document.getElementById(\"grafanaFrame\");\ndocument.getElementById(\"grafanaBack\").addEventListener(\"click\", function() {\n    g.src=\"/grafana/d/uIVLIHRRk/water-temp?orgId=1&kiosk&refresh=30s\";\n});\ng.onload = function() {\n    setTimeout(() => {\n        g.style.width = \"770px\";\n    }, 1000);\n    var style = g.contentDocument.createElement('style');\n    var head = g.contentDocument.getElementsByTagName(\"head\")[0];\n    style.type = \"text/css\";\n    style.innerText = \".panel-title-container, .react-resizable-handle {pointer-events: none;} header[aria-label='Dashboard navigation'] { padding-top: 16px;} body {background-color: transparent !important;} .page-toolbar {display:none !important;} div[role=menu] {display:none !important;}\";\n    head.appendChild(style);\n};\n</script>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":820,"y":540,"wires":[[]]},{"id":"82b122f2.04701","type":"function","z":"638a1ba8.eab274","name":"Build SQL flow status insert","func":"\nif (!msg.payload.status) {\n    return null;\n}\nconst status = msg.payload.status;\nconst oldLitersIn = flow.get(\"lastlitersIn\");\nconst oldLitersOut = flow.get(\"lastlitersOut\");\nconst oldInValveOpen = flow.get(\"lastinValveOpen\");\nconst oldOutValveOpen = flow.get(\"lastoutValveOpen\");\n\n//only write if there are changes to these 4 things\nif (oldLitersIn === status.litersIn && oldLitersOut === status.litersOut\n    && oldInValveOpen === status.inValveOpen && oldOutValveOpen === status.outValveOpen) {\n    return;        \n}\n\nflow.set(\"lastlitersIn\", status.litersIn);\nflow.set(\"lastlitersOut\", status.litersOut);\nflow.set(\"lastinValveOpen\", status.inValveOpen);\nflow.set(\"lastoutValveOpen\", status.outValveOpen);\n\nlet sql = \"INSERT INTO flowstatus (timestamp, litersIn, litersOut, inValveOpen, outValveOpen, waterLevel) \";\nsql += `VALUES (current_timestamp, ${status.litersIn}, ${status.litersOut}, ${status.inValveOpen}, ${status.outValveOpen}, ${status.waterLevel});`;\nmsg.topic = sql;\nmsg.payload = null;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2240,"y":100,"wires":[["d3d2d415.c50788"]]},{"id":"d9cd14d0.a8d338","type":"function","z":"638a1ba8.eab274","name":"Build SQL op insert","func":"let sql = \"INSERT INTO flowops (timestamp, op, status, error, opLitersIn, opLitersOut, opLitersDelta, params, id) \";\nif (!msg.payload.status.currentOp) {\n    return null;\n}\nconst op = msg.payload.status.currentOp;\nsql += ` VALUES (current_timestamp, '${op.type}', '${op.status}', '${op.errorMessage.replace(/\\'/g, \"'\")}', ${op.litersIn}, ${op.litersOut}, ${op.litersDelta}, '${op.params?op.params.join(\",\"):'null'}', '${op.id}');`;\nmsg.payload = null;\nmsg.topic = sql;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2280,"y":200,"wires":[["d3d2d415.c50788"]]},{"id":"d3d2d415.c50788","type":"sqlite","z":"638a1ba8.eab274","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"","x":2390,"y":300,"wires":[[]]},{"id":"b7df9dbc.c20e1","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":14,"width":6,"height":1,"name":"","label":"Operation Error","format":"{{msg.payload.status.currentOp.errorMessage }}","layout":"row-spread","x":1900,"y":160,"wires":[]},{"id":"237d2910.0b472e","type":"inject","z":"38def9ff.21aea6","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1330,"y":720,"wires":[["54d553d4.a2d68c"]]},{"id":"2b607d7.bafe882","type":"function","z":"38def9ff.21aea6","name":"","func":"msg.data = {\"url\":\"/timelapse.mp4\",\"title\":\"Time Lapse\"};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1040,"y":420,"wires":[["293f4bd8.354f14"]]},{"id":"e4e3eaeb.6cf0b8","type":"ui_numeric","z":"38def9ff.21aea6","d":true,"name":"","label":"","tooltip":"","group":"b9fab5a.6b0f448","order":8,"width":0,"height":0,"wrap":false,"passthru":true,"topic":"topic","topicType":"msg","format":"{{value}}","min":0,"max":"560","step":1,"x":600,"y":740,"wires":[["64d0a1c5.0485"]]},{"id":"14bd452e.0f075b","type":"ui_slider","z":"38def9ff.21aea6","d":true,"name":"","label":"zoom","tooltip":"","group":"b9fab5a.6b0f448","order":6,"width":0,"height":0,"passthru":true,"outs":"end","topic":"topic","topicType":"msg","min":0,"max":"560","step":1,"x":450,"y":740,"wires":[["e4e3eaeb.6cf0b8"]]},{"id":"6d9fb4fd.07f6fc","type":"serial out","z":"38def9ff.21aea6","name":"","serial":"d0a8065.0235ff8","x":860,"y":760,"wires":[]},{"id":"64d0a1c5.0485","type":"function","z":"38def9ff.21aea6","name":"zoom","func":"msg.payload = `z${msg.payload}\\n`;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":860,"wires":[["6d9fb4fd.07f6fc","197cc269.2e65ee"]]},{"id":"197cc269.2e65ee","type":"debug","z":"38def9ff.21aea6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":860,"y":940,"wires":[]},{"id":"cda3584e.7a7548","type":"ui_slider","z":"38def9ff.21aea6","d":true,"name":"","label":"focus","tooltip":"","group":"b9fab5a.6b0f448","order":7,"width":0,"height":0,"passthru":true,"outs":"end","topic":"topic","topicType":"msg","min":0,"max":"309","step":1,"x":230,"y":840,"wires":[["8417bd92.98781"]]},{"id":"8417bd92.98781","type":"ui_numeric","z":"38def9ff.21aea6","d":true,"name":"","label":"","tooltip":"","group":"b9fab5a.6b0f448","order":9,"width":0,"height":0,"wrap":false,"passthru":true,"topic":"topic","topicType":"msg","format":"{{value}}","min":0,"max":"309","step":1,"x":380,"y":840,"wires":[["3af6f4e7.49748c"]]},{"id":"3af6f4e7.49748c","type":"function","z":"38def9ff.21aea6","name":"focus","func":"msg.payload = `f${msg.payload}\\n`;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":960,"wires":[["6d9fb4fd.07f6fc","197cc269.2e65ee"]]},{"id":"bcb1435.c55a3c","type":"debug","z":"38def9ff.21aea6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":360,"y":1040,"wires":[]},{"id":"7b517d93.ab5b54","type":"serial in","z":"38def9ff.21aea6","name":"","serial":"d0a8065.0235ff8","x":120,"y":940,"wires":[["bcb1435.c55a3c"]]},{"id":"24d37f2d.85aac","type":"function","z":"38def9ff.21aea6","name":"init","func":"msg.payload = `i`;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":1020,"wires":[["6d9fb4fd.07f6fc","197cc269.2e65ee"]]},{"id":"626eb427.252b3c","type":"inject","z":"38def9ff.21aea6","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":310,"y":1160,"wires":[["24d37f2d.85aac"]]},{"id":"d37dbca5.87c9a","type":"websocket in","z":"38def9ff.21aea6","name":"outside intake","server":"","client":"706f2da7.938834","x":170,"y":1400,"wires":[["ed7d2bc3.1f9ea8"]]},{"id":"8e9637.167ac9c8","type":"function","z":"38def9ff.21aea6","name":"ducter parse status","func":"\nif (msg.payload.msgType == \"DucterStatusMsg\") {\n    //msg.payload = msg.payload.outsideOpenPercent;\n    return msg;\n} else {\n    return null\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":1540,"wires":[["f4a8df66.6a269","888d2ed7.1f92e"]]},{"id":"33ea60b9.6a262","type":"ui_text","z":"38def9ff.21aea6","group":"5fcd719a.e80f1","order":2,"width":3,"height":1,"name":"","label":"Inside Temp","format":"{{msg.payload}} °C","layout":"col-center","x":970,"y":1160,"wires":[]},{"id":"4a4d5719.a5d378","type":"ui_text","z":"38def9ff.21aea6","group":"5fcd719a.e80f1","order":4,"width":3,"height":1,"name":"","label":"Inside Humidity","format":"{{msg.payload}} %","layout":"col-center","x":980,"y":1200,"wires":[]},{"id":"6cab26bc.bf51c8","type":"ui_text","z":"38def9ff.21aea6","group":"5fcd719a.e80f1","order":3,"width":3,"height":1,"name":"","label":"Outside Humidity","format":"{{msg.payload}} %","layout":"col-center","x":990,"y":1300,"wires":[]},{"id":"6ca85d98.7f5074","type":"ui_text","z":"38def9ff.21aea6","group":"5fcd719a.e80f1","order":1,"width":3,"height":1,"name":"","label":"Outside Temp","format":"{{msg.payload}} °C","layout":"col-center","x":980,"y":1260,"wires":[]},{"id":"69eb1a8f.995004","type":"function","z":"38def9ff.21aea6","name":"inside to temp/humid","func":"const m = msg.payload;\nflow.set(\"insideTempC\", m.tempC);\nflow.set(\"insideHumidityPercent\", m.humidityPercent);\n\nreturn [{payload: m.tempC}, {payload: m.humidityPercent}];\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":1180,"wires":[["49603d01.4eb334"],["fadd6eec.daeb3"]]},{"id":"49603d01.4eb334","type":"function","z":"38def9ff.21aea6","name":"Round","func":"msg.payload = Math.floor(msg.payload * 100)/100;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":1160,"wires":[["33ea60b9.6a262"]]},{"id":"fadd6eec.daeb3","type":"function","z":"38def9ff.21aea6","name":"Round","func":"msg.payload = Math.floor(msg.payload * 100)/100;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":1200,"wires":[["4a4d5719.a5d378"]]},{"id":"ed7d2bc3.1f9ea8","type":"function","z":"38def9ff.21aea6","name":"outside to temp/humid","func":"const m = msg.payload;\nflow.set(\"outsideTempC\", m.tempC);\nflow.set(\"outsideHumidityPercent\", m.humidityPercent);\nreturn [{payload: m.tempC}, {payload: m.humidityPercent}];\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":1260,"wires":[["65632cfa.6b0644"],["ecad54c9.798268"]]},{"id":"65632cfa.6b0644","type":"function","z":"38def9ff.21aea6","name":"Round","func":"msg.payload = Math.floor(msg.payload * 100)/100;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":1260,"wires":[["6ca85d98.7f5074"]]},{"id":"ecad54c9.798268","type":"function","z":"38def9ff.21aea6","name":"Round","func":"msg.payload = Math.floor(msg.payload * 100)/100;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":1300,"wires":[["6cab26bc.bf51c8"]]},{"id":"901fdd20.31f19","type":"function","z":"38def9ff.21aea6","name":"mix to temp/humid","func":"const m = msg.payload;\nflow.set(\"mixTempC\", m.tempC);\nflow.set(\"mixHumidityPercent\", m.humidityPercent);\nreturn [{payload: m.tempC}, {payload: m.humidityPercent}];\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":1360,"wires":[["c9e9dc33.19375"],["f2cb3756.876a28"]]},{"id":"c9e9dc33.19375","type":"function","z":"38def9ff.21aea6","name":"Round","func":"msg.payload = Math.floor(msg.payload * 100)/100;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":1360,"wires":[["1786685a.31b6b8"]]},{"id":"f2cb3756.876a28","type":"function","z":"38def9ff.21aea6","name":"Round","func":"msg.payload = Math.floor(msg.payload * 100)/100;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":1400,"wires":[["2f640f95.22e06"]]},{"id":"1786685a.31b6b8","type":"ui_text","z":"38def9ff.21aea6","group":"5fcd719a.e80f1","order":13,"width":3,"height":1,"name":"","label":"Mix Temp","format":"{{msg.payload}} °C","layout":"col-center","x":960,"y":1360,"wires":[]},{"id":"2f640f95.22e06","type":"ui_text","z":"38def9ff.21aea6","group":"5fcd719a.e80f1","order":14,"width":3,"height":1,"name":"","label":"Mix Humidity","format":"{{msg.payload}} %","layout":"col-center","x":970,"y":1400,"wires":[]},{"id":"4064e567.eaae4c","type":"function","z":"38def9ff.21aea6","name":"humidifier split","func":"if (msg.payload.msgType == \"HumidifierStatusMsg\") {\n    const m = msg.payload;\n    return [{payload: m.mode}, {payload: m.onPct}, {payload: m.offPct}, {payload: m.sensor}, {payload: m.isOn}];\n}\n\nreturn null;\n","outputs":5,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":1900,"wires":[["a377db25.54d8a8"],["3c682fa7.c139"],["d2b5469b.8345e8"],["c7214254.31972"],["5815a3e.9be6d5c"]]},{"id":"18bd183a.096488","type":"ui_dropdown","z":"38def9ff.21aea6","name":"","label":"Humidifier Mode","tooltip":"","place":"Humidifier Mode","group":"5fcd719a.e80f1","order":15,"width":6,"height":1,"passthru":true,"multiple":false,"options":[{"label":"Off","value":"0","type":"str"},{"label":"On","value":"1","type":"str"},{"label":"Humidistat","value":"2","type":"str"}],"payload":"","topic":"topic","topicType":"msg","x":440,"y":2060,"wires":[["cdb1809a.115c4"]]},{"id":"f1e78d0e.ff9e3","type":"ui_numeric","z":"38def9ff.21aea6","name":"","label":"Humidifier On At","tooltip":"","group":"5fcd719a.e80f1","order":17,"width":6,"height":1,"wrap":false,"passthru":false,"topic":"topic","topicType":"msg","format":"{{value}} %","min":0,"max":"99","step":1,"x":420,"y":2140,"wires":[["60ca5db3.b08fa4"]]},{"id":"914bcaee.9957c8","type":"ui_numeric","z":"38def9ff.21aea6","name":"","label":"Humidifier Off At","tooltip":"","group":"5fcd719a.e80f1","order":18,"width":6,"height":1,"wrap":false,"passthru":false,"topic":"topic","topicType":"msg","format":"{{value}} %","min":0,"max":"99","step":1,"x":420,"y":2180,"wires":[["ef1fe91b.970918"]]},{"id":"7ffaf99c.91bd38","type":"ui_text_input","z":"38def9ff.21aea6","name":"","label":"Humidifier Sensor","tooltip":"","group":"5fcd719a.e80f1","order":19,"width":6,"height":1,"passthru":true,"mode":"text","delay":"3000","topic":"topic","topicType":"msg","x":430,"y":2220,"wires":[["247f1816.2a2668"]]},{"id":"60ca5db3.b08fa4","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"humidifierOnAt\", msg.payload);\nflow.set(\"humidifierSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":2140,"wires":[["f024e44f.9c1188"]]},{"id":"247f1816.2a2668","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"targetSensorName\", msg.payload);\nflow.set(\"humidifierSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":2240,"wires":[["f024e44f.9c1188"]]},{"id":"ef1fe91b.970918","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"humidifierOffAt\", msg.payload);\nflow.set(\"humidifierSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":2180,"wires":[["f024e44f.9c1188"]]},{"id":"cdb1809a.115c4","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"humidifierMode\", msg.payload);\nflow.set(\"humidifierSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":2080,"wires":[["f024e44f.9c1188"]]},{"id":"a1c55c5e.57834","type":"function","z":"38def9ff.21aea6","name":"assemble humidifier msg","func":"\nconst onAt = flow.get(\"humidifierOnAt\");\nconst offAt = flow.get(\"humidifierOffAt\");\nconst mode = flow.get(\"humidifierMode\");\nconst sensor = flow.get(\"targetSensorName\");\nflow.set(\"humidifierSetPending\", false);\nif ((onAt || onAt === 0) && (offAt || offAt === 0) && (mode || mode === 0) && sensor) {\n    msg.payload = JSON.stringify({\n        msgType: \"HumidifierSetMsg\",\n        mode: mode,\n        onPct: onAt,\n        offPct: offAt,\n        sensor: sensor\n    });\n    return msg;\n} else {\n    return null;\n}\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1090,"y":2220,"wires":[["73c48711.811598"]]},{"id":"a377db25.54d8a8","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"humidifierSetPending\")) {\n    flow.set(\"humidifierMode\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":130,"y":2060,"wires":[["18bd183a.096488"]]},{"id":"3c682fa7.c139","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"humidifierSetPending\")) {\n    flow.set(\"humidifierOnAt\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":130,"y":2120,"wires":[["f1e78d0e.ff9e3"]]},{"id":"d2b5469b.8345e8","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"humidifierSetPending\")) {\n    flow.set(\"humidifierOffAt\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":130,"y":2160,"wires":[["914bcaee.9957c8"]]},{"id":"c7214254.31972","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"humidifierSetPending\")) {\n    flow.set(\"targetSensorName\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":130,"y":2220,"wires":[["7ffaf99c.91bd38"]]},{"id":"5815a3e.9be6d5c","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":27,"width":3,"height":1,"name":"","label":"Humidifier","format":"{{msg.payload?\"On\":\"Off\"}}","layout":"col-center","x":830,"y":2040,"wires":[]},{"id":"f024e44f.9c1188","type":"debounce","z":"38def9ff.21aea6","time":1000,"name":"","x":820,"y":2180,"wires":[["a1c55c5e.57834"]]},{"id":"6f58e69f.28af28","type":"udp in","z":"38def9ff.21aea6","name":"","iface":"","port":"45678","ipv":"udp4","multicast":"false","group":"","datatype":"utf8","x":100,"y":1460,"wires":[["3a1cbe6.f801042"]]},{"id":"73c48711.811598","type":"udp out","z":"38def9ff.21aea6","name":"","addr":"192.168.1.255","iface":"","port":"45678","ipv":"udp4","outport":"","base64":false,"multicast":"broad","x":2010,"y":1980,"wires":[]},{"id":"3a1cbe6.f801042","type":"function","z":"38def9ff.21aea6","name":"json parse","func":"msg.payload = JSON.parse(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":130,"y":1580,"wires":[["8e9637.167ac9c8","4064e567.eaae4c","aab31bd3.4156f8","21aa4032.50de8","fa337d85.232e1"]]},{"id":"aab31bd3.4156f8","type":"function","z":"38def9ff.21aea6","name":"Temp Sensor Splitter","func":"if (msg.payload.nodeId == \"growbot-inside-intake-temp\") {\n    return [msg,null,null];\n} else if (msg.payload.nodeId == \"growbot-outside-intake-temp\") {\n    return [null,msg,null];\n} else if (msg.payload.nodeId == \"growbot-mix-intake-temp\") {\n     return [null,null,msg];\n}\nreturn null;","outputs":3,"noerr":0,"initialize":"","finalize":"","libs":[],"x":200,"y":1220,"wires":[["69eb1a8f.995004"],["ed7d2bc3.1f9ea8"],["901fdd20.31f19"]]},{"id":"5ae6763a.9960e8","type":"udp in","z":"638a1ba8.eab274","name":"","iface":"","port":"45678","ipv":"udp4","multicast":"false","group":"","datatype":"utf8","x":140,"y":60,"wires":[["d04f181a.6d4208"]]},{"id":"d04f181a.6d4208","type":"function","z":"638a1ba8.eab274","name":"json parse","func":"msg.payload = JSON.parse(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":80,"wires":[["ebdb72a4.96d04"]]},{"id":"3d383eef.374d52","type":"udp out","z":"638a1ba8.eab274","name":"","addr":"192.168.1.255","iface":"","port":"45678","ipv":"udp4","outport":"","base64":false,"multicast":"broad","x":2670,"y":360,"wires":[]},{"id":"e96f2915.e1a068","type":"function","z":"638a1ba8.eab274","name":"set msgid","func":"const msgId = Math.floor(Math.random() * 100000000);\nflow.set(\"flowLastMsgId\", msgId);\nmsg.payload.msgId = msgId;\nmsg.payload = JSON.stringify(msg.payload);\nreturn [msg, {payload: { success: \"Pending...\"}}];","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2200,"y":460,"wires":[["3d383eef.374d52"],["f8e86409.c9be58","5263476e.99ad58"]]},{"id":"f4a8df66.6a269","type":"function","z":"38def9ff.21aea6","name":"ducter split","func":"if (msg.payload.msgType == \"DucterStatusMsg\") {\n    const m = msg.payload;\n    return [{payload: m.mode}, \n    {payload: m.insideOpenPercent}, \n    {payload: m.outsideOpenPercent}, \n    {payload: m.sensor}, \n    {payload: m.targetTempC},\n    {payload: m.ki},\n    {payload: m.kp},\n    {payload: m.kd}];\n}\n\nreturn null;\n","outputs":8,"noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":2400,"wires":[["4e79a9d2.8b0c18"],["ae388783.716a48"],[],["eec82456.e9ccd8"],["862e64f8.eec548"],["6f382903.f6fbc8"],["45f9827a.60b11c"],["af5e1f47.29137"]]},{"id":"4e79a9d2.8b0c18","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"humidifierSetPending\")) {\n    flow.set(\"humidifierMode\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":2560,"wires":[["fe488889.34fdf8"]]},{"id":"fe488889.34fdf8","type":"ui_dropdown","z":"38def9ff.21aea6","name":"","label":"Air Mode","tooltip":"","place":"Air Mode","group":"5fcd719a.e80f1","order":5,"width":6,"height":1,"passthru":true,"multiple":false,"options":[{"label":"Manual","value":"0","type":"str"},{"label":"Auto","value":"1","type":"str"}],"payload":"","topic":"topic","topicType":"msg","x":660,"y":2560,"wires":[["aead563d.89b128"]]},{"id":"aead563d.89b128","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"ducterMode\", msg.payload);\nflow.set(\"ducterSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":2580,"wires":[["ccb61975.c99b28"]]},{"id":"eec82456.e9ccd8","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"ducterSetPending\")) {\n    flow.set(\"ducterTargetSensorName\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":2640,"wires":[["4e501d78.f3d504"]]},{"id":"4e501d78.f3d504","type":"ui_text_input","z":"38def9ff.21aea6","name":"","label":"Ducter Sensor","tooltip":"","group":"5fcd719a.e80f1","order":10,"width":6,"height":1,"passthru":true,"mode":"text","delay":"3000","topic":"topic","topicType":"msg","x":660,"y":2640,"wires":[["e204ee85.570af"]]},{"id":"e204ee85.570af","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"ducterTargetSensorName\", msg.payload);\nflow.set(\"ducterSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":2660,"wires":[["ccb61975.c99b28"]]},{"id":"862e64f8.eec548","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"ducterSetPending\")) {\n    flow.set(\"ducterTargetTempC\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":2700,"wires":[["142a27c9.908358"]]},{"id":"142a27c9.908358","type":"ui_numeric","z":"38def9ff.21aea6","name":"","label":"Target Temp C","tooltip":"","group":"5fcd719a.e80f1","order":6,"width":6,"height":1,"wrap":false,"passthru":false,"topic":"topic","topicType":"msg","format":"{{value}}","min":0,"max":"99","step":1,"x":620,"y":2700,"wires":[["8225ac20.c1267"]]},{"id":"8225ac20.c1267","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"ducterTargetTempC\", msg.payload);\nflow.set(\"ducterSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":2720,"wires":[["ccb61975.c99b28"]]},{"id":"3917ba08.594266","type":"ui_slider","z":"38def9ff.21aea6","name":"ducter mix","label":"","tooltip":"","group":"5fcd719a.e80f1","order":12,"width":6,"height":1,"passthru":false,"outs":"end","topic":"topic","topicType":"msg","min":"0","max":"100","step":1,"x":650,"y":2820,"wires":[["4da12d2.fee04d4"]]},{"id":"c5e8ac26.9d279","type":"ui_text","z":"38def9ff.21aea6","group":"5fcd719a.e80f1","order":11,"width":6,"height":1,"name":"","label":"","format":"Outside ----------------  Inside","layout":"col-center","x":650,"y":2780,"wires":[]},{"id":"4da12d2.fee04d4","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"const insideVal = msg.payload;\nconst outsideVal = 100 - insideVal;\nflow.set(\"ducterInsideOpenPercent\", insideVal);\nflow.set(\"ducterOutsideOpenPercent\", outsideVal);\nflow.set(\"ducterSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":2820,"wires":[["ccb61975.c99b28"]]},{"id":"ae388783.716a48","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"ducterSetPending\")) {\n    const insideVal = msg.payload;\n    const outsideVal = 100 - insideVal;\n    flow.set(\"ducterInsideOpenPercent\", insideVal);\n    flow.set(\"ducterOutsideOpenPercent\", outsideVal);\n    return msg;\n}\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":2820,"wires":[["3917ba08.594266"]]},{"id":"ccb61975.c99b28","type":"debounce","z":"38def9ff.21aea6","time":1000,"name":"","x":1090,"y":2720,"wires":[["b257e566.c3e248"]]},{"id":"b257e566.c3e248","type":"function","z":"38def9ff.21aea6","name":"assemble ducter msg","func":"\nconst insideOpenPercent = flow.get(\"ducterInsideOpenPercent\");\nconst outsideOpenPercent = flow.get(\"ducterOutsideOpenPercent\");\nconst mode = flow.get(\"ducterMode\");\nconst sensor = flow.get(\"ducterTargetSensorName\");\nconst targetTempC = flow.get(\"ducterTargetTempC\");\nconst ki = flow.get(\"ducterKi\");\nconst kp = flow.get(\"ducterKp\");\nconst kd = flow.get(\"ducterKd\");\n\nflow.set(\"ducterSetPending\", false);\nif ( (mode == 0 && (insideOpenPercent || insideOpenPercent === 0) && (outsideOpenPercent || outsideOpenPercent === 0))\n    || (mode == 1 && (targetTempC || targetTempC === 0) ) ) {\n    msg.payload = JSON.stringify({\n        msgType: \"DucterSetDuctsMsg\",\n        mode: mode,\n        insideOpenPercent: insideOpenPercent,\n        outsideOpenPercent: outsideOpenPercent,\n        sensor: sensor,\n        targetTempC: targetTempC,\n        ki: ki,\n        kp: kp,\n        kd: kd\n    });\n    return msg;\n} else {\n    return null;\n}\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":2580,"wires":[["73c48711.811598"]]},{"id":"858c193.40db9e8","type":"ui_gauge","z":"38def9ff.21aea6","name":"Lux","group":"60058375.2cde8c","order":19,"width":3,"height":2,"gtype":"gage","title":"","label":"Lux","format":"{{msg.payload.data.luxAmbient1}}","min":0,"max":"50000","colors":["#000000","#d8e47c","#fbff00"],"seg1":"100","seg2":"10000","x":590,"y":500,"wires":[]},{"id":"4b848a38.53f734","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":14,"width":3,"height":1,"name":"","label":"Lux","format":"{{msg.payload.data.luxAmbient1}}","layout":"col-center","x":590,"y":540,"wires":[]},{"id":"21aa4032.50de8","type":"function","z":"38def9ff.21aea6","name":"lightify split","func":"if (msg.payload.msgType == \"LightifyStatusMsg\") {\n    const m = msg.payload;\n    return [{payload: m.mode}, {payload: m.targetLux}, {payload: m.lightPercent}, {payload: m.sensor}];\n}\n\nreturn null;\n","outputs":4,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1130,"y":1840,"wires":[["1b14ef9d.3600e"],["a3563ac2.bebea8"],["7ec7ac6e.af05e4"],["1bd4ff8d.6e3ae"]]},{"id":"ec98eded.97e1c","type":"ui_dropdown","z":"38def9ff.21aea6","name":"","label":"Lightify Mode","tooltip":"","place":"Lightify Mode","group":"198cd612.f86eaa","order":2,"width":6,"height":1,"passthru":true,"multiple":false,"options":[{"label":"Manual","value":"0","type":"str"},{"label":"Auto","value":"1","type":"str"}],"payload":"","topic":"topic","topicType":"msg","x":1330,"y":1580,"wires":[["e08e8741.831798"]]},{"id":"6fae6a8e.35a474","type":"ui_numeric","z":"38def9ff.21aea6","name":"","label":"Target Lux","tooltip":"","group":"198cd612.f86eaa","order":3,"width":0,"height":0,"wrap":false,"passthru":false,"topic":"topic","topicType":"msg","format":"{{value}}","min":"1000","max":"70000","step":"1000","x":1330,"y":1620,"wires":[["c80e6563.ee0128"]]},{"id":"6aca57ff.2a4778","type":"ui_slider","z":"38def9ff.21aea6","name":"","label":"Lightify %","tooltip":"","group":"198cd612.f86eaa","order":4,"width":0,"height":0,"passthru":false,"outs":"end","topic":"topic","topicType":"msg","min":0,"max":"100","step":1,"x":1320,"y":1660,"wires":[["c7d061c.51659a"]]},{"id":"6b6581dd.7dced","type":"ui_text_input","z":"38def9ff.21aea6","name":"","label":"Sensor Name","tooltip":"","group":"198cd612.f86eaa","order":1,"width":0,"height":0,"passthru":false,"mode":"text","delay":"2000","topic":"topic","topicType":"msg","x":1340,"y":1700,"wires":[["71a87f68.9f6a2"]]},{"id":"1b14ef9d.3600e","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"lightifySetPending\")) {\n    flow.set(\"lightifyMode\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1090,"y":1580,"wires":[["ec98eded.97e1c"]]},{"id":"a3563ac2.bebea8","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"lightifySetPending\")) {\n    flow.set(\"lightifyTargetLux\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1090,"y":1620,"wires":[["6fae6a8e.35a474"]]},{"id":"7ec7ac6e.af05e4","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"lightifySetPending\")) {\n    flow.set(\"lightiflightPercent\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1090,"y":1660,"wires":[["6aca57ff.2a4778"]]},{"id":"1bd4ff8d.6e3ae","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"lightifySetPending\")) {\n    flow.set(\"lightifySensor\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1090,"y":1700,"wires":[["6b6581dd.7dced"]]},{"id":"e08e8741.831798","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"lightifyMode\", msg.payload);\nflow.set(\"lightifySetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":1780,"wires":[["9439e1e2.ddc74"]]},{"id":"c80e6563.ee0128","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"lightifyTargetLux\", msg.payload);\nflow.set(\"lightifySetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":1820,"wires":[["9439e1e2.ddc74"]]},{"id":"c7d061c.51659a","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"lightifyLightPercent\", msg.payload);\nflow.set(\"lightifySetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":1860,"wires":[["9439e1e2.ddc74"]]},{"id":"71a87f68.9f6a2","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"lightifySensor\", msg.payload);\nflow.set(\"lightifySetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":1900,"wires":[["9439e1e2.ddc74"]]},{"id":"9439e1e2.ddc74","type":"debounce","z":"38def9ff.21aea6","time":1000,"name":"","x":1510,"y":1860,"wires":[["919b4e.d28444b"]]},{"id":"919b4e.d28444b","type":"function","z":"38def9ff.21aea6","name":"assemble lightify msg","func":"\nconst targetLux = flow.get(\"lightifyTargetLux\");\nconst lightPercent = flow.get(\"lightifyLightPercent\");\nconst mode = flow.get(\"lightifyMode\");\nconst sensor = flow.get(\"lightifySensor\");\nflow.set(\"lightifySetPending\", false);\nif ((targetLux || targetLux === 0) && (lightPercent || lightPercent === 0) \n&& (mode || mode === 0) && sensor) {\n    msg.payload = JSON.stringify({\n        msgType: \"LightifySetMsg\",\n        mode: mode,\n        targetLux: targetLux,\n        lightPercent: lightPercent,\n        sensor: sensor\n    });\n    return msg;\n} else {\n    return null;\n}\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1760,"y":1780,"wires":[["73c48711.811598"]]},{"id":"461d6e7e.7388","type":"function","z":"38def9ff.21aea6","name":"set flow vars","func":"flow.set(\"ambientTempC\", msg.payload.data.temperatureC);\nflow.set(\"ambientHumidityPercent\", msg.payload.data.humidity);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":180,"y":440,"wires":[[]]},{"id":"888d2ed7.1f92e","type":"function","z":"38def9ff.21aea6","name":"write airstatus sql","func":"let sql = \"INSERT INTO airstatus (timestamp, insideTempC, insideHumidityPercent, outsideTempC, outsideHumidityPercent, mixTempC, mixHumidityPercent, ambientTempC, ambientHumidityPercent, mode, insideOpenPercent, outsideOpenPercent, targetTempC) VALUES (\";\nsql += Date.now() + \", \";\n\nvar insideTempC = flow.get(\"insideTempC\")||msg.topic;\nif (Number.isNaN(insideTempC)) insideTempC = null;\n\nvar insideHumidityPercent = flow.get(\"insideHumidityPercent\")||null;\nif (Number.isNaN(insideHumidityPercent)) insideHumidityPercent = null;\n\nvar outsideTempC = flow.get(\"outsideTempC\")||null;\nif (Number.isNaN(outsideTempC)) outsideTempC = null;\n\nvar outsideHumidityPercent = flow.get(\"outsideHumidityPercent\")||null;\nif (Number.isNaN(outsideHumidityPercent)) outsideHumidityPercent = null;\n\nvar mixTempC = flow.get(\"mixTempC\")||null;\nif (Number.isNaN(mixTempC)) mixTempC = null;\n\nvar mixHumidityPercent = flow.get(\"mixHumidityPercent\")||null;\nif (Number.isNaN(mixHumidityPercent)) mixHumidityPercent = null;\n\nvar ambientTempC = flow.get(\"ambientTempC\")||null;\nif (Number.isNaN(ambientTempC)) ambientTempC = null;\n\nvar ambientHumidityPercent = flow.get(\"ambientHumidityPercent\")||null;\nif (Number.isNaN(ambientHumidityPercent)) ambientHumidityPercent = null;\n\nvar m = msg.payload;\n\nvar mode = m.mode||null;\nif (Number.isNaN(mode)) mode = null;\n\nvar insideOpenPercent = m.insideOpenPercent||null;\nif (Number.isNaN(insideOpenPercent)) insideOpenPercent = null;\n\nvar outsideOpenPercent = m.outsideOpenPercent||null;\nif (Number.isNaN(outsideOpenPercent)) insideHumidityPercent = null;\n\nvar targetTempC = m.targetTempC||null;\nif (Number.isNaN(targetTempC)) targetTempC = null;\n\nvar vals = `${insideTempC}, ${insideHumidityPercent}, ${outsideTempC}, ${outsideHumidityPercent}, ${mixTempC}, ${mixHumidityPercent}, ${ambientTempC}, ${ambientHumidityPercent}, `;\nvals += `${mode}, ${insideOpenPercent}, ${outsideOpenPercent}, ${targetTempC}`;\nconst lastvals = flow.get('lastWroteAirStatus');\nif (lastvals == null || vals != lastvals ) {\n    flow.set('lastWroteAirStatus', vals);\n    sql += vals + \");\";\n    msg.topic = sql;\n    return msg;\n} else {\n    return null;\n}\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":1560,"wires":[["c73547f1.09bc38"]]},{"id":"c73547f1.09bc38","type":"sqlite","z":"38def9ff.21aea6","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"","x":680,"y":1620,"wires":[[]]},{"id":"6f382903.f6fbc8","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"ducterSetPending\")) {\n    flow.set(\"ducterKi\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":2940,"wires":[["cc2dcd53.ddef4"]]},{"id":"cc2dcd53.ddef4","type":"ui_numeric","z":"38def9ff.21aea6","name":"","label":"Ki","tooltip":"","group":"5fcd719a.e80f1","order":7,"width":6,"height":1,"wrap":false,"passthru":false,"topic":"topic","topicType":"msg","format":"{{value}}","min":0,"max":"99","step":".1","x":550,"y":2940,"wires":[["1839e177.406f4f"]]},{"id":"1839e177.406f4f","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"ducterKi\", msg.payload);\nflow.set(\"ducterSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":2960,"wires":[["ccb61975.c99b28"]]},{"id":"45f9827a.60b11c","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"ducterSetPending\")) {\n    flow.set(\"ducterKp\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":3000,"wires":[["6154811c.e1a78"]]},{"id":"6154811c.e1a78","type":"ui_numeric","z":"38def9ff.21aea6","name":"","label":"Kp","tooltip":"","group":"5fcd719a.e80f1","order":8,"width":6,"height":1,"wrap":false,"passthru":false,"topic":"topic","topicType":"msg","format":"{{value}}","min":0,"max":"99","step":".1","x":550,"y":3000,"wires":[["6d66a094.29fcd"]]},{"id":"6d66a094.29fcd","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"ducterKp\", msg.payload);\nflow.set(\"ducterSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":3020,"wires":[["ccb61975.c99b28"]]},{"id":"af5e1f47.29137","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"if (!flow.get(\"ducterSetPending\")) {\n    flow.set(\"ducterKd\", msg.payload);\n    return msg; \n} else {\n    return null;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":3060,"wires":[["a026acc4.9cbd9"]]},{"id":"a026acc4.9cbd9","type":"ui_numeric","z":"38def9ff.21aea6","name":"","label":"Kd","tooltip":"","group":"5fcd719a.e80f1","order":9,"width":6,"height":1,"wrap":false,"passthru":false,"topic":"topic","topicType":"msg","format":"{{value}}","min":0,"max":"99","step":".1","x":550,"y":3060,"wires":[["68402ecf.08f58"]]},{"id":"68402ecf.08f58","type":"function","z":"38def9ff.21aea6","name":"set flow val","func":"\nflow.set(\"ducterKd\", msg.payload);\nflow.set(\"ducterSetPending\", true);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":830,"y":3080,"wires":[["ccb61975.c99b28"]]},{"id":"4e1f0661.619288","type":"function","z":"638a1ba8.eab274","name":"Build Doser Msg String","func":"//assumes as input that we will have a payload.port and payload.\n\nconst msgId = Math.floor(Math.random() * 100000000);\nflow.set(\"doserLastMsgId\", msgId);\nmsg.payload.msgId = msgId;\nmsg.payload = JSON.stringify(msg.payload);\nreturn [msg, {payload: { success: \"Pending...\"}}];\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1320,"y":360,"wires":[["3d383eef.374d52"]]},{"id":"ebdb72a4.96d04","type":"function","z":"638a1ba8.eab274","name":"Route Message","func":"/* first output will route stuff through to the water control stuff,\n    second output will route stuff through to the doser stuff*/\n\nconst FLOW_MSG_TYPES = [\"FlowStatusMsg\", \n                        \"FlowOpStartedMsg\",\n                        \"FlowOpEndedMsg\"];\n                        \nconst DOSER_MSG_TYPES = [\"DoserStartedMsg\",\n                         \"DoserEndedMsg\",\n                         \"DoserContinuousStartedMsg\",\n                         \"DoserContinuousEndedMsg\"];\n\nif (msg.payload.msgType == \"GbResultMsg\") {\n    if (flow.get(\"flowLastMsgId\") == msg.payload.replyTo) {\n        return [msg, null];\n    } else if (flow.get(\"doserLastMsgId\") == msg.payload.replyTo) {\n        return [null, msg];\n    }\n} else if (FLOW_MSG_TYPES.includes(msg.payload.msgType)) {\n    return [msg, null];\n} else if (DOSER_MSG_TYPES.includes(msg.payload.msgType)) {\n    return [null, msg];\n} else {\n    return [null,null, msg];\n}\n \n\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":100,"wires":[["a298b0ea.8edab"],["670ab345.cd3bbc"]]},{"id":"670ab345.cd3bbc","type":"function","z":"638a1ba8.eab274","name":"Handle Doser Msg","func":"\nif (msg.payload.msgType == \"GbResultMsg\" && flow.get(\"doserLastMsgId\") == msg.payload.replyTo) {\n    return [msg, null, null, null, null];\n} else if (msg.payload.msgType == \"DoserStartedMsg\") {\n    return [null, msg, null, null, null];\n} else if (msg.payload.msgType == \"DoserEndedMsg\") {\n    return [null, null, msg, null, null];\n} else if (msg.payload.msgType == \"DoserContinuousStartedMsg\") {\n    return [null, null, null, msg, null];\n} else if (msg.payload.msgType == \"DoserContinuousEndedMsg\") {\n    return [null, null, null, null, msg];\n}\n\n\n","outputs":5,"noerr":0,"initialize":"","finalize":"","libs":[],"x":170,"y":260,"wires":[["4cccfc07.22a9e4"],[],["81a1c7bf.328ae8","b2f50f45.facc2","587c3084.43ee4"],["4cccfc07.22a9e4"],["4cccfc07.22a9e4"]]},{"id":"81a1c7bf.328ae8","type":"function","z":"638a1ba8.eab274","name":"Write Dosing Ended SQL Insert","func":"\nconst port = msg.payload.port;\nconst ml = msg.payload.actualMl;\n\nlet sql = `INSERT INTO dosing (timestamp, port, ml) VALUES (${Date.now()}, ${port}, ${ml});`;\n\nmsg.topic = sql;\nmsg.payload = {};\n\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":220,"wires":[["ffb9d39.d04463"]]},{"id":"b2f50f45.facc2","type":"function","z":"638a1ba8.eab274","name":"Check and Continue Doser Queue","func":"//only continue the queue if it was successful\nif (msg.payload.success) {\n    let doserQ = flow.get(\"doserMsgQueue\");\n    if (doserQ && Array.isArray(doserQ) && doserQ.length) {\n        //seems like there's probably something here to deal with\n        let msg = doserQ.shift();\n        flow.set(\"doserMsgQueue\", doserQ);\n        return {payload: msg};\n    }\n} else {\n    //maybe purge the queue if it was failure? or just leave it?\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":300,"wires":[["4e1f0661.619288"]]},{"id":"74630d98.4862f4","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":40,"width":4,"height":2,"passthru":false,"label":"STOP!","tooltip":"","color":"","bgcolor":"","icon":"","payload":"{\"msgType\":\"DoserEStopMsg\",\"skipRetract\":false}","payloadType":"json","topic":"topic","topicType":"msg","x":150,"y":420,"wires":[["ee2dac39.b2cb2"]]},{"id":"ee2dac39.b2cb2","type":"function","z":"638a1ba8.eab274","name":"Build Estop Msg String","func":"\nconst msgId = Math.floor(Math.random() * 100000000);\n//flow.set(\"doserLastMsgId\", msgId);\nmsg.payload.msgId = msgId;\nmsg.payload = JSON.stringify(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":480,"y":420,"wires":[["3d383eef.374d52"]]},{"id":"7085fc3d.e85624","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":15,"width":6,"height":1,"name":"","label":"Doser Last Msg","format":"{{msg.payload}}","layout":"row-spread","x":1240,"y":580,"wires":[]},{"id":"4cccfc07.22a9e4","type":"function","z":"638a1ba8.eab274","name":"MakeMsgDisplay","func":"let s = \"\";\nif (msg.payload.msgType == \"DoserContinuousStartedMsg\") {\n    s = \"Starting prime on port \" + msg.payload.port;\n} else if (msg.payload.msgType == \"DoserContinuousEndedMsg\") {\n    s = \"Priming stopped on port \" + msg.payload.port + \" with \" + msg.payload.actualMl + \" ml\";\n} else if (msg.payload.msgType == \"GbResultMsg\") {\n    if (!msg.payload.success) {\n        s = \"Error: \" + (msg.payload.error ||  \"null err\");\n    }\n}\n\nif (s) {\n    msg.payload = s;\n    return msg;\n}\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":520,"wires":[["7085fc3d.e85624"]]},{"id":"90df6b75.456068","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"b35587bd.c30058","order":24,"width":6,"height":2,"passthru":false,"label":"Kill Queue","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"payload","topicType":"msg","x":530,"y":1520,"wires":[["4e617405.fc119c"]]},{"id":"4e617405.fc119c","type":"function","z":"638a1ba8.eab274","name":"","func":"\nflow.set(\"doserMsgQueue\", [])\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":1520,"wires":[[]]},{"id":"d67e6136.ea21d","type":"ui_text","z":"638a1ba8.eab274","group":"79e4a25c.bb49dc","order":16,"width":6,"height":1,"name":"","label":"Last Dose","format":"{{msg.payload}}","layout":"row-spread","x":1020,"y":460,"wires":[]},{"id":"587c3084.43ee4","type":"function","z":"638a1ba8.eab274","name":"Format Last Dose","func":"return {payload: \n`Dosed ${msg.payload.actualMl} mL on port ${msg.payload.port}`}\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":380,"wires":[["d67e6136.ea21d"]]},{"id":"4dd7f95b.0b8d48","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"79e4a25c.bb49dc","order":23,"width":6,"height":1,"passthru":false,"label":"Force Drain + Enable Pump","tooltip":"","color":"","bgcolor":"","icon":"","payload":"{\"msgType\":\"FlowStartOpMsg\",\"op\":\"ManualOverride\",\"params\":[false, true, true, 50]}","payloadType":"json","topic":"topic","topicType":"msg","x":1900,"y":700,"wires":[["e96f2915.e1a068"]]},{"id":"cffb0753.8f3cf8","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"79e4a25c.bb49dc","order":23,"width":6,"height":1,"passthru":false,"label":"Force Fill","tooltip":"","color":"","bgcolor":"","icon":"","payload":"{\"msgType\":\"FlowStartOpMsg\",\"op\":\"ManualOverride\",\"params\":[true, false, false, 0]}","payloadType":"json","topic":"topic","topicType":"msg","x":1840,"y":740,"wires":[["e96f2915.e1a068"]]},{"id":"675ee2ff.298adc","type":"udp in","z":"594ee16b.d66e3","name":"","iface":"","port":"45678","ipv":"udp4","multicast":"false","group":"","datatype":"utf8","x":180,"y":180,"wires":[["9c6e7dcf.3cd8d"]]},{"id":"ed677c9f.25f2a","type":"function","z":"594ee16b.d66e3","name":"NodeStampSetter","func":"flow.set(`last_${msg.payload.nodeId}`, Date.now());\nreturn {payload: `last_${msg.payload.nodeId}`};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":610,"y":120,"wires":[[]]},{"id":"82927512.1b65d8","type":"inject","z":"594ee16b.d66e3","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"3","crontab":"","once":true,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":300,"wires":[["8feaa2e1.49632","30004db3.79ddc2","cae752fd.43b8a","9d4d34f4.cefdb8","15bacf6a.2e0d31","3970e6dd.09c0ca","c32c96e.8f63668","42a4b841.4b70b8","82154924.85f0a8","b591fcf6.6b97d"]]},{"id":"8feaa2e1.49632","type":"function","z":"594ee16b.d66e3","name":"growbot-accusquirt","func":"let nodeid = 'growbot-accusquirt';\nlet maxTime = 6000;\n\nlet last = flow.get(`last_${nodeid}`) || 0;\n\nlet payload = {name: \"AccuSquirt Nutrient Doser\", nodeId: nodeid, status: ((Date.now() - last) < maxTime)?'green-indicator':'red-indicator'};\nreturn {payload: payload};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":300,"wires":[["1d7a1636.d3d78a"]]},{"id":"9c6e7dcf.3cd8d","type":"function","z":"594ee16b.d66e3","name":"Json parse","func":"msg.payload = JSON.parse(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":340,"y":80,"wires":[["ed677c9f.25f2a"]]},{"id":"d435f0a.a5de91","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"","order":1,"width":0,"height":0,"format":"<style>\n.indicator-container {\n    display: flex;\n    align-items: center;\n}\n.label-container {\n    margin-left: 10px;\n    display: inline;\n}\n.indicator-label {\n    \n    display: block;\n}\n\n.indicator-sub-label {\n    \n    font-size: .75em;\n    color: lightgray;\n    display: block;\n}\n.green-indicator {\n    display: inline-block;\n    background-color: green;\n    width: 25px;\n    height: 25px;\n    border-radius: 50%; /* Makes it a circle */\n    position: relative;\n    border: 2px solid #555; /* Gives a metallic rim */\n    box-shadow:\n        0 0 10px rgba(0, 255, 0, 0.7), /* Outer glow */\n        inset 0 0 20px rgba(255, 255, 255, 0.5), /* Inner white glow for clear glass */\n        0 2px 5px rgba(0, 0, 0, 0.3); /* Shadow for depth */\n    align-items: center;\n    justify-content: center;\n}\n\n.green-indicator::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background-color: inherit; /* Inherits the background color of the div */\n    border-radius: 50%;\n    filter: brightness(0.6); /* Darkens the main color to give a domed effect */\n    z-index: 1;\n}\n\n.green-indicator::after {\n    content: '';\n    position: absolute;\n    top: 10%;\n    left: 10%;\n    width: 80%;\n    height: 80%;\n    border-radius: 50%;\n    background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0) 70%);\n    opacity: 0.7;\n    pointer-events: none; /* Ensures the highlight doesn’t interfere with user interactions */\n    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);\n    z-index: 2;\n}\n\n\n\n\n\n.red-indicator {\n    display: inline-block;\n    background-color: red;\n    width: 25px;\n    height: 25px;\n    border-radius: 50%; /* Makes it a circle */\n    position: relative;\n    border: 2px solid #555; /* Gives a metallic rim */\n    box-shadow:\n        0 0 10px rgba(150, 0, 0, 0.7), /* Outer glow */\n        inset 0 0 20px rgba(255, 255, 255, 0.5), /* Inner white glow for clear glass */\n        0 2px 5px rgba(0, 0, 0, 0.3); /* Shadow for depth */\n    align-items: center;\n    justify-content: center;\n}\n\n.red-indicator::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background-color: inherit; /* Inherits the background color of the div */\n    border-radius: 50%;\n    filter: brightness(0.6); /* Darkens the main color to give a domed effect */\n    z-index: 1;\n}\n\n.red-indicator::after {\n    content: '';\n    position: absolute;\n    top: 10%;\n    left: 10%;\n    width: 80%;\n    height: 80%;\n    border-radius: 50%;\n    background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0) 70%);\n    opacity: 0.7;\n    pointer-events: none; /* Ensures the highlight doesn’t interfere with user interactions */\n    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);\n    z-index: 2;\n}\n\n</style>\n","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"global","x":140,"y":60,"wires":[[]]},{"id":"1d7a1636.d3d78a","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"accusquirt","order":2,"width":0,"height":0,"format":"<div class=\"indicator-container\">\n    <div class=\"{{msg.payload.status}}\"></div>\n    <div class=\"label-container\">\n        <div class=\"indicator-label\">{{msg.payload.name}}</div>\n        <div class=\"indicator-sub-label\">{{msg.payload.nodeId}}</div>\n    </div>\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":650,"y":300,"wires":[[]]},{"id":"30004db3.79ddc2","type":"function","z":"594ee16b.d66e3","name":"growbot-lightify","func":"let nodeid = 'growbot-lightify';\nlet maxTime = 10000;\n\nlet last = flow.get(`last_${nodeid}`) || 0;\n\nlet payload = {name: \"Grow Light Dimmer Control\", nodeId: nodeid, status: ((Date.now() - last) < maxTime)?'green-indicator':'red-indicator'};\nreturn {payload: payload};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":340,"wires":[["84600aa0.c3e2a8"]]},{"id":"84600aa0.c3e2a8","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"lightify","order":3,"width":0,"height":0,"format":"<div class=\"indicator-container\">\n    <div class=\"{{msg.payload.status}}\"></div>\n    <div class=\"label-container\">\n        <div class=\"indicator-label\">{{msg.payload.name}}</div>\n        <div class=\"indicator-sub-label\">{{msg.payload.nodeId}}</div>\n    </div>\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":620,"y":340,"wires":[[]]},{"id":"cae752fd.43b8a","type":"function","z":"594ee16b.d66e3","name":"growbot-esp (core)","func":"let nodeid = 'plant-top-lux';\nlet maxTime = 10000;\n\nlet last = flow.get(`last_${nodeid}`) || 0;\n\nlet payload = {name: \"Growbot Core Sensor/Power Module\", nodeId: 'growbot-esp', status: ((Date.now() - last) < maxTime)?'green-indicator':'red-indicator'};\nreturn {payload: payload};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":380,"wires":[["2d9c30c7.0903a"]]},{"id":"2d9c30c7.0903a","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"core","order":4,"width":0,"height":0,"format":"<div class=\"indicator-container\">\n    <div class=\"{{msg.payload.status}}\"></div>\n    <div class=\"label-container\">\n        <div class=\"indicator-label\">{{msg.payload.name}}</div>\n        <div class=\"indicator-sub-label\">{{msg.payload.nodeId}}</div>\n    </div>\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":620,"y":380,"wires":[[]]},{"id":"9d4d34f4.cefdb8","type":"function","z":"594ee16b.d66e3","name":"growbot-inside-intake-temp","func":"let nodeid = 'growbot-inside-intake-temp';\nlet maxTime = 10000;\n\nlet last = flow.get(`last_${nodeid}`) || 0;\n\nlet payload = {name: \"Internal Intake Temp/Humid Sensor\", nodeId: nodeid, status: ((Date.now() - last) < maxTime)?'green-indicator':'red-indicator'};\nreturn {payload: payload};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":420,"wires":[["3c564f19.d1d07"]]},{"id":"3c564f19.d1d07","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"insideintake","order":9,"width":0,"height":0,"format":"<div class=\"indicator-container\">\n    <div class=\"{{msg.payload.status}}\"></div>\n    <div class=\"label-container\">\n        <div class=\"indicator-label\">{{msg.payload.name}}</div>\n        <div class=\"indicator-sub-label\">{{msg.payload.nodeId}}</div>\n    </div>\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":640,"y":420,"wires":[[]]},{"id":"15bacf6a.2e0d31","type":"function","z":"594ee16b.d66e3","name":"growbot-mix-intake-temp","func":"let nodeid = 'growbot-mix-intake-temp';\nlet maxTime = 10000;\n\nlet last = flow.get(`last_${nodeid}`) || 0;\n\nlet payload = {name: \"Airflow Mix Temp/Humid Sensor\", nodeId: nodeid, status: ((Date.now() - last) < maxTime)?'green-indicator':'red-indicator'};\nreturn {payload: payload};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":460,"wires":[["42eb9ad6.cb3104"]]},{"id":"42eb9ad6.cb3104","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"mixtemp","order":11,"width":0,"height":0,"format":"<div class=\"indicator-container\">\n    <div class=\"{{msg.payload.status}}\"></div>\n    <div class=\"label-container\">\n        <div class=\"indicator-label\">{{msg.payload.name}}</div>\n        <div class=\"indicator-sub-label\">{{msg.payload.nodeId}}</div>\n    </div>\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":630,"y":460,"wires":[[]]},{"id":"3970e6dd.09c0ca","type":"function","z":"594ee16b.d66e3","name":"growbot-humidifier","func":"let nodeid = 'growbot-humidifier';\nlet maxTime = 10000;\n\nlet last = flow.get(`last_${nodeid}`) || 0;\n\nlet payload = {name: \"Intake Humidifier Control\", nodeId: nodeid, status: ((Date.now() - last) < maxTime)?'green-indicator':'red-indicator'};\nreturn {payload: payload};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":500,"wires":[["838fb9f0.a660b8"]]},{"id":"838fb9f0.a660b8","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"humidifier","order":5,"width":0,"height":0,"format":"<div class=\"indicator-container\">\n    <div class=\"{{msg.payload.status}}\"></div>\n    <div class=\"label-container\">\n        <div class=\"indicator-label\">{{msg.payload.name}}</div>\n        <div class=\"indicator-sub-label\">{{msg.payload.nodeId}}</div>\n    </div>\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":630,"y":500,"wires":[[]]},{"id":"c32c96e.8f63668","type":"function","z":"594ee16b.d66e3","name":"growbot-flow","func":"let nodeid = 'growbot-flow';\nlet maxTime = 6000;\n\nlet last = flow.get(`last_${nodeid}`) || 0;\n\nlet payload = {name: \"Water Flow Fill/Drain Control\", nodeId:  nodeid, status: ((Date.now() - last) < maxTime)?'green-indicator':'red-indicator'};\nreturn {payload: payload};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":390,"y":540,"wires":[["2e5d4d44.9296b2"]]},{"id":"2e5d4d44.9296b2","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"flow","order":6,"width":0,"height":0,"format":"<div class=\"indicator-container\">\n    <div class=\"{{msg.payload.status}}\"></div>\n    <div class=\"label-container\">\n        <div class=\"indicator-label\">{{msg.payload.name}}</div>\n        <div class=\"indicator-sub-label\">{{msg.payload.nodeId}}</div>\n    </div>\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":620,"y":540,"wires":[[]]},{"id":"42a4b841.4b70b8","type":"function","z":"594ee16b.d66e3","name":"growbot-switcheroo","func":"let nodeid = 'growbot-switcheroo';\nlet maxTime = 10000;\n\nlet last = flow.get(`last_${nodeid}`) || 0;\n\nlet payload = {name: \"Power Control\", nodeId: nodeid, status: ((Date.now() - last) < maxTime)?'green-indicator':'red-indicator'};\nreturn {payload: payload};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":410,"y":620,"wires":[["52b5fb88.49cde4"]]},{"id":"52b5fb88.49cde4","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"switcheroo","order":7,"width":0,"height":0,"format":"<div class=\"indicator-container\">\n    <div class=\"{{msg.payload.status}}\"></div>\n    <div class=\"label-container\">\n        <div class=\"indicator-label\">{{msg.payload.name}}</div>\n        <div class=\"indicator-sub-label\">{{msg.payload.nodeId}}</div>\n    </div>\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":640,"y":620,"wires":[[]]},{"id":"82154924.85f0a8","type":"function","z":"594ee16b.d66e3","name":"growbot-ducter","func":"let nodeid = 'growbot-ducter';\nlet maxTime = 10000;\n\nlet last = flow.get(`last_${nodeid}`) || 0;\n\nlet payload = {name: \"Intake Airflow Damper Control\", nodeId: nodeid, status: ((Date.now() - last) < maxTime)?'green-indicator':'red-indicator'};\nreturn {payload: payload};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":660,"wires":[["c2cd4425.187098"]]},{"id":"c2cd4425.187098","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"ducter","order":8,"width":0,"height":0,"format":"<div class=\"indicator-container\">\n    <div class=\"{{msg.payload.status}}\"></div>\n    <div class=\"label-container\">\n        <div class=\"indicator-label\">{{msg.payload.name}}</div>\n        <div class=\"indicator-sub-label\">{{msg.payload.nodeId}}</div>\n    </div>\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":620,"y":660,"wires":[[]]},{"id":"b591fcf6.6b97d","type":"function","z":"594ee16b.d66e3","name":"growbot-outside-intake-temp","func":"let nodeid = 'growbot-outside-intake-temp';\nlet maxTime = 10000;\n\nlet last = flow.get(`last_${nodeid}`) || 0;\n\nlet payload = {name: \"External Intake Temp/Humid Sensor\", nodeId: nodeid, status: ((Date.now() - last) < maxTime)?'green-indicator':'red-indicator'};\nreturn {payload: payload};","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":580,"wires":[["6a2814aa.460a5c"]]},{"id":"6a2814aa.460a5c","type":"ui_template","z":"594ee16b.d66e3","group":"7cf977f9.c0b488","name":"outsideintake","order":10,"width":0,"height":0,"format":"<div class=\"indicator-container\">\n    <div class=\"{{msg.payload.status}}\"></div>\n    <div class=\"label-container\">\n        <div class=\"indicator-label\">{{msg.payload.name}}</div>\n        <div class=\"indicator-sub-label\">{{msg.payload.nodeId}}</div>\n    </div>\n</div>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":true,"templateScope":"local","x":640,"y":580,"wires":[[]]},{"id":"1741624a.17368e","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":40,"width":4,"height":2,"passthru":false,"label":"Calibrate 1","tooltip":"","color":"","bgcolor":"","icon":"","payload":"1","payloadType":"num","topic":"topic","topicType":"msg","x":1270,"y":980,"wires":[["e41b56b2.de6ff8"]]},{"id":"60f20dd5.81e7c4","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":42,"width":4,"height":2,"passthru":false,"label":"Calibrate 2","tooltip":"","color":"","bgcolor":"","icon":"","payload":"2","payloadType":"num","topic":"topic","topicType":"msg","x":1270,"y":1020,"wires":[["e41b56b2.de6ff8"]]},{"id":"87aa95e0.abd8d8","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":47,"width":4,"height":2,"passthru":false,"label":"Calibrate 3","tooltip":"","color":"","bgcolor":"","icon":"","payload":"3","payloadType":"num","topic":"topic","topicType":"msg","x":1270,"y":1060,"wires":[["e41b56b2.de6ff8"]]},{"id":"e6cefa03.455478","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":49,"width":4,"height":2,"passthru":false,"label":"Calibrate 4","tooltip":"","color":"","bgcolor":"","icon":"","payload":"4","payloadType":"num","topic":"topic","topicType":"msg","x":1270,"y":1100,"wires":[["e41b56b2.de6ff8"]]},{"id":"6667ca0e.a0c2f4","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":54,"width":4,"height":2,"passthru":false,"label":"Calibrate 5","tooltip":"","color":"","bgcolor":"","icon":"","payload":"5","payloadType":"num","topic":"topic","topicType":"msg","x":1270,"y":1140,"wires":[["e41b56b2.de6ff8"]]},{"id":"6f645de0.2af6d4","type":"ui_button","z":"638a1ba8.eab274","name":"","group":"963f0a7c.dc1ca8","order":56,"width":4,"height":2,"passthru":false,"label":"Calibrate 6","tooltip":"","color":"","bgcolor":"","icon":"","payload":"6","payloadType":"num","topic":"topic","topicType":"msg","x":1270,"y":1180,"wires":[["e41b56b2.de6ff8"]]},{"id":"e41b56b2.de6ff8","type":"function","z":"638a1ba8.eab274","name":"Build clibrate msg","func":"const payload = { msgType: \"DoserCalibratePortMsg\", port: msg.payload };\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1570,"y":1040,"wires":[["4e1f0661.619288"]]},{"id":"492fb9c6.198128","type":"function","z":"38def9ff.21aea6","name":"reset power counter","func":" msg.payload = JSON.stringify({\n        msgType: \"PowerMonCommandMsg\",\n        resetAmpHours: true,\n        unixSecondsStamp: Math.floor(Date.now()/1000)\n    });\n    return msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1860,"y":2360,"wires":[["73c48711.811598"]]},{"id":"20e2c944.bb3c06","type":"ui_button","z":"38def9ff.21aea6","name":"","group":"60058375.2cde8c","order":33,"width":0,"height":0,"passthru":false,"label":"Reset power counter","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"topic","topicType":"msg","x":1480,"y":2360,"wires":[["492fb9c6.198128"]]},{"id":"fa337d85.232e1","type":"function","z":"38def9ff.21aea6","name":"handle power mon status msg","func":"\n\nif (msg.payload.msgType == \"PowerMonStatusMsg\") {\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1350,"y":2280,"wires":[["333f2a3d.c9b3c6","1a1962e4.34a5bd"]]},{"id":"ca9d04e8.653df8","type":"function","z":"638a1ba8.eab274","name":"Create power table","func":"node.send({payload:{}, topic: `create table if not exists power_use (\n\ttimestamp integer,\n\tdevice text,\n\tamp_draw real,\n\ttotal_amp_hours real,\n\tsince_timestamp int\n);`});\nsetTimeout(() => {\n    node.send({payload: {}, topic: `create index if not exists idx_power_use_timestamp on power_use (timestamp);`});\n}, 5000);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":750,"y":80,"wires":[["bcf7e578.09f018"]]},{"id":"333f2a3d.c9b3c6","type":"function","z":"38def9ff.21aea6","name":"Create INSERT state SQL","func":"msg.topic = `INSERT INTO power_use (timestamp, device, amp_draw, total_amp_hours, since_timestamp) VALUES (${Date.now()}, '${msg.payload.nodeId?.replace(\"'\",\"''\")}', ${(msg.payload.instantAmpDraw||0)}, ${(msg.payload.ampHoursSinceReset||0)}, ${(msg.payload.lastResetUnixSeconds||0)})`;\n\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1730,"y":2440,"wires":[["4c415e45.bb3d4"]]},{"id":"4c415e45.bb3d4","type":"sqlite","z":"38def9ff.21aea6","mydb":"30dfc866.064c48","sqlquery":"msg.topic","sql":"","name":"","x":2240,"y":2240,"wires":[[]]},{"id":"2711b7c6.a58038","type":"ui_text","z":"38def9ff.21aea6","group":"60058375.2cde8c","order":15,"width":3,"height":1,"name":"","label":"Power- Amps","format":"{{msg.payload}}","layout":"col-center","x":430,"y":640,"wires":[]},{"id":"7ba174ec.40ba4c","type":"ui_gauge","z":"38def9ff.21aea6","name":"Power Draw","group":"60058375.2cde8c","order":20,"width":3,"height":2,"gtype":"gage","title":"","label":"Amps","format":"{{msg.payload}}","min":"0","max":"30","colors":["#0bd534","#00ff11","#f40b0b"],"seg1":"0","seg2":"0","x":630,"y":640,"wires":[]},{"id":"1a1962e4.34a5bd","type":"function","z":"38def9ff.21aea6","name":"round instant amp draw","func":"msg.payload = Math.round((msg.payload.instantAmpDraw||0)*100)/100;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1320,"y":920,"wires":[["197cc269.2e65ee","7ba174ec.40ba4c","2711b7c6.a58038"]]}]